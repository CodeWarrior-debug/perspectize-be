---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - perspectize-fe/package.json
  - perspectize-fe/src/routes/+layout.svelte
  - perspectize-fe/src/lib/queries/client.ts
  - perspectize-fe/src/lib/queries/content.ts
  - perspectize-fe/vite.config.ts
  - perspectize-fe/src/routes/+page.svelte
autonomous: true

must_haves:
  truths:
    - "TanStack Query provider wraps the application"
    - "TanStack Form available for perspective forms"
    - "GraphQL client is configured with backend URL"
    - "Toast notifications appear in top-right position"
    - "Vitest runs with npm test command"
    - "Test coverage report generates with npm run test:coverage"
  artifacts:
    - path: "perspectize-fe/src/lib/queries/client.ts"
      provides: "GraphQL client configuration"
      contains: "GraphQLClient"
    - path: "perspectize-fe/src/lib/queries/content.ts"
      provides: "Example GraphQL queries"
      contains: "gql"
    - path: "perspectize-fe/vite.config.ts"
      provides: "Vitest configuration"
      contains: "test:"
    - path: "perspectize-fe/src/routes/+layout.svelte"
      provides: "Root layout with QueryClientProvider and Toaster"
      contains: "QueryClientProvider"
  key_links:
    - from: "perspectize-fe/src/routes/+layout.svelte"
      to: "@tanstack/svelte-query"
      via: "QueryClientProvider import"
      pattern: "QueryClientProvider"
    - from: "perspectize-fe/src/routes/+layout.svelte"
      to: "svelte-sonner"
      via: "Toaster import"
      pattern: "Toaster"
---

<objective>
Configure TanStack Query with GraphQL client, TanStack Form, svelte-sonner toast notifications, and Vitest testing infrastructure.

Purpose: Establish the data fetching layer and developer tooling that will be used throughout the application. TanStack Query provides caching and data management, TanStack Form provides form handling for perspective forms, toasts provide user feedback, and Vitest enables testing.

Output: A working TanStack Query setup with GraphQL client, TanStack Form installed, toast notifications configured in top-right position with 2s duration, and Vitest ready for unit testing.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure TanStack Query, TanStack Form, and GraphQL client</name>
  <files>
    perspectize-fe/package.json
    perspectize-fe/src/routes/+layout.svelte
    perspectize-fe/src/lib/queries/client.ts
    perspectize-fe/src/lib/queries/content.ts
  </files>
  <action>
    1. Install dependencies:
       ```bash
       cd perspectize-fe
       npm install @tanstack/svelte-query graphql-request graphql @tanstack/svelte-form
       ```

    2. Create GraphQL client in src/lib/queries/client.ts:
       ```typescript
       import { GraphQLClient } from 'graphql-request';

       // Backend URL - will be environment variable in production
       const GRAPHQL_ENDPOINT = import.meta.env.VITE_GRAPHQL_URL || 'http://localhost:8080/graphql';

       export const graphqlClient = new GraphQLClient(GRAPHQL_ENDPOINT, {
         headers: {
           // Auth headers will be added when user selection is implemented
         },
       });
       ```

    3. Create example content queries in src/lib/queries/content.ts:
       ```typescript
       import { gql } from 'graphql-request';

       // Example queries matching the Go backend schema
       export const LIST_CONTENT = gql`
         query ListContent($first: Int, $after: String) {
           content(first: $first, after: $after) {
             edges {
               node {
                 id
                 title
                 url
                 contentType
                 createdAt
                 updatedAt
               }
               cursor
             }
             pageInfo {
               hasNextPage
               endCursor
             }
           }
         }
       `;

       export const GET_CONTENT = gql`
         query GetContent($id: IntID!) {
           content(id: $id) {
             id
             title
             url
             contentType
             description
             thumbnailUrl
             duration
           }
         }
       `;
       ```

    4. Update +layout.svelte to add QueryClientProvider:
       ```svelte
       <script lang="ts">
         import { browser } from '$app/environment';
         import { QueryClient, QueryClientProvider } from '@tanstack/svelte-query';
         import Header from '$lib/components/Header.svelte';
         import '../app.css';

         export const prerender = true;

         // CRITICAL: Disable queries on server to prevent post-SSR execution
         const queryClient = new QueryClient({
           defaultOptions: {
             queries: {
               enabled: browser, // Only run queries in browser
               staleTime: 60 * 1000, // 1 minute
               retry: 1,
             },
           },
         });
       </script>

       <QueryClientProvider client={queryClient}>
         <div class="min-h-screen bg-background text-foreground">
           <Header />
           <slot />
         </div>
       </QueryClientProvider>
       ```

    IMPORTANT: The `enabled: browser` is CRITICAL. Without it, TanStack Query continues executing queries on the server after HTML is sent, wasting resources. See 01-RESEARCH.md pitfall #2.

    Note: TanStack Form (@tanstack/svelte-form) is installed for use in Phase 3 perspective forms. No configuration needed - it's used directly in components.
  </action>
  <verify>
    ```bash
    cd perspectize-fe && npm run dev
    ```
    No errors about missing modules.

    ```bash
    grep -r "QueryClientProvider" perspectize-fe/src/routes/+layout.svelte
    grep "@tanstack/svelte-form" perspectize-fe/package.json
    ```
    QueryClientProvider is in layout. TanStack Form is in dependencies.
  </verify>
  <done>
    - @tanstack/svelte-query installed
    - @tanstack/svelte-form installed (for Phase 3 perspective forms)
    - graphql-request and graphql installed
    - client.ts exports graphqlClient with backend URL
    - content.ts has example GraphQL queries
    - +layout.svelte wraps app in QueryClientProvider
    - enabled: browser set in QueryClient defaults
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure svelte-sonner toast notifications</name>
  <files>
    perspectize-fe/package.json
    perspectize-fe/src/routes/+layout.svelte
    perspectize-fe/src/routes/+page.svelte
  </files>
  <action>
    1. Install svelte-sonner:
       ```bash
       cd perspectize-fe
       npm install svelte-sonner
       ```

    2. Add Toaster component to +layout.svelte:
       ```svelte
       <script lang="ts">
         import { browser } from '$app/environment';
         import { QueryClient, QueryClientProvider } from '@tanstack/svelte-query';
         import { Toaster } from 'svelte-sonner';
         import Header from '$lib/components/Header.svelte';
         import '../app.css';

         export const prerender = true;

         const queryClient = new QueryClient({
           defaultOptions: {
             queries: {
               enabled: browser,
               staleTime: 60 * 1000,
               retry: 1,
             },
           },
         });
       </script>

       <QueryClientProvider client={queryClient}>
         <!-- Toast notifications: top-right, 2s auto-dismiss per requirements -->
         <Toaster position="top-right" duration={2000} richColors />

         <div class="min-h-screen bg-background text-foreground">
           <Header />
           <slot />
         </div>
       </QueryClientProvider>
       ```

    3. Add test buttons to +page.svelte to verify toasts work:
       ```svelte
       <script lang="ts">
         import { toast } from 'svelte-sonner';
         import PageWrapper from '$lib/components/PageWrapper.svelte';
         import { Button } from '$lib/components/ui/button';
       </script>

       <PageWrapper>
         <h1 class="text-4xl font-bold mb-4">Perspectize</h1>
         <p class="mb-4">This text should be in Inter font.</p>

         <div class="space-x-4 mb-8">
           <Button>Primary (Navy)</Button>
           <Button variant="secondary">Secondary</Button>
         </div>

         <div class="space-x-4 mb-8">
           <h2 class="text-xl font-semibold mb-2">Toast Tests</h2>
           <Button variant="outline" onclick={() => toast.success('Success! This will dismiss in 2s')}>
             Success Toast
           </Button>
           <Button variant="outline" onclick={() => toast.error('Error occurred!')}>
             Error Toast
           </Button>
           <Button variant="outline" onclick={() => toast.info('Information message')}>
             Info Toast
           </Button>
         </div>

         <div class="mt-8 p-4 bg-primary text-primary-foreground rounded">
           This box should have navy background with white text.
         </div>
       </PageWrapper>
       ```

    4. Configuration details:
       - position="top-right": Matches REQUIREMENTS.md (SETUP-07)
       - duration={2000}: 2 second auto-dismiss (SETUP-07)
       - richColors: Better visual distinction for success/error/info
  </action>
  <verify>
    ```bash
    cd perspectize-fe && npm run dev
    ```
    Open http://localhost:5173:
    - Click "Success Toast" button
    - Toast appears in top-right corner
    - Toast auto-dismisses after 2 seconds
    - Test error and info toasts as well
  </verify>
  <done>
    - svelte-sonner installed
    - Toaster in +layout.svelte with position="top-right" and duration={2000}
    - Test buttons in +page.svelte for success/error/info toasts
    - Toasts appear in correct position and auto-dismiss
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure Vitest for unit testing with coverage</name>
  <files>
    perspectize-fe/package.json
    perspectize-fe/vite.config.ts
    perspectize-fe/tests/setup.ts
    perspectize-fe/tests/unit/example.test.ts
  </files>
  <action>
    1. Install testing dependencies:
       ```bash
       cd perspectize-fe
       npm install -D vitest @testing-library/svelte @testing-library/jest-dom jsdom @vitest/coverage-v8
       ```

    2. Update vite.config.ts with Vitest configuration:
       ```typescript
       import { sveltekit } from '@sveltejs/kit/vite';
       import { defineConfig } from 'vitest/config';

       export default defineConfig({
         plugins: [sveltekit()],
         test: {
           include: ['src/**/*.{test,spec}.{js,ts}', 'tests/**/*.{test,spec}.{js,ts}'],
           environment: 'jsdom',
           globals: true,
           setupFiles: ['./tests/setup.ts'],
           coverage: {
             provider: 'v8',
             reporter: ['text', 'json', 'html'],
             exclude: [
               'node_modules/',
               '.svelte-kit/',
               '**/*.d.ts',
               '**/*.config.*',
               '**/setup.ts',
             ],
           },
         },
       });
       ```

    3. Create test setup file tests/setup.ts:
       ```typescript
       import '@testing-library/jest-dom/vitest';
       import { vi } from 'vitest';

       // Mock $app/environment for tests
       vi.mock('$app/environment', () => ({
         browser: true,
         dev: true,
         building: false,
       }));

       // Mock $app/navigation if needed
       vi.mock('$app/navigation', () => ({
         goto: vi.fn(),
         invalidate: vi.fn(),
         invalidateAll: vi.fn(),
         preloadData: vi.fn(),
         preloadCode: vi.fn(),
         afterNavigate: vi.fn(),
         beforeNavigate: vi.fn(),
       }));
       ```

    4. Create example test file tests/unit/example.test.ts:
       ```typescript
       import { describe, it, expect } from 'vitest';

       describe('Example test suite', () => {
         it('should pass a basic test', () => {
           expect(1 + 1).toBe(2);
         });

         it('should work with arrays', () => {
           const items = ['a', 'b', 'c'];
           expect(items).toHaveLength(3);
           expect(items).toContain('b');
         });
       });
       ```

    5. Add test scripts to package.json:
       ```json
       {
         "scripts": {
           "test": "vitest",
           "test:run": "vitest run",
           "test:coverage": "vitest run --coverage"
         }
       }
       ```

    6. Create tests/fixtures/.gitkeep for shared test fixtures (future use)
  </action>
  <verify>
    ```bash
    cd perspectize-fe && npm test -- --run
    ```
    Tests pass.

    ```bash
    npm run test:coverage
    ```
    Coverage report generates.
  </verify>
  <done>
    - vitest and testing libraries installed
    - vite.config.ts has test configuration
    - tests/setup.ts with SvelteKit mocks
    - Example test in tests/unit/example.test.ts passes
    - npm test runs Vitest in watch mode
    - npm run test:coverage generates coverage report
    - tests/fixtures/.gitkeep created for future fixtures
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **TanStack Query configured**: QueryClientProvider wraps app, enabled: browser set
2. **TanStack Form installed**: @tanstack/svelte-form in package.json (for Phase 3)
3. **GraphQL client ready**: client.ts exports configured GraphQLClient
4. **Example queries exist**: content.ts has LIST_CONTENT and GET_CONTENT
5. **Toasts work**: Click test buttons, toasts appear top-right, dismiss in 2s
6. **Tests run**: `npm test -- --run` passes
7. **Coverage works**: `npm run test:coverage` generates report
</verification>

<success_criteria>
- TanStack Query provider configured with browser-only queries
- TanStack Form installed (@tanstack/svelte-form in dependencies)
- GraphQL client configured with backend URL (localhost:8080/graphql default)
- Example content queries in lib/queries/content.ts
- svelte-sonner Toaster in layout (top-right, 2s duration)
- Toast test buttons work on home page
- Vitest configured with jsdom environment
- Test setup file with SvelteKit mocks
- Example test passes
- Coverage reporting works
- Test scripts in package.json (test, test:run, test:coverage)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
