---
phase: 02-data-layer-activity
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - perspectize-fe/src/routes/+page.svelte
  - perspectize-fe/src/lib/components/ActivityTable.svelte
  - perspectize-fe/src/lib/components/UserSelector.svelte
  - perspectize-fe/src/lib/components/Header.svelte
  - perspectize-fe/tests/components/ActivityTable.test.ts
  - perspectize-fe/tests/components/UserSelector.test.ts
autonomous: false

must_haves:
  truths:
    - "User can view Activity page showing most recently updated content (default sort by updatedAt desc)"
    - "User can sort the table by any column (ascending/descending)"
    - "User can filter the table by text search (searches title, description)"
    - "User can paginate with page size selector (10/25/50)"
    - "User can select from existing users via dropdown in the header"
    - "Selected user persists across page navigation (session storage)"
  artifacts:
    - path: "perspectize-fe/src/routes/+page.svelte"
      provides: "Activity page with data fetching and component composition"
      min_lines: 30
    - path: "perspectize-fe/src/lib/components/ActivityTable.svelte"
      provides: "AG Grid wrapper with content columns, Quick Filter, pagination"
      min_lines: 50
    - path: "perspectize-fe/src/lib/components/UserSelector.svelte"
      provides: "User dropdown with TanStack Query data and session persistence"
      min_lines: 25
    - path: "perspectize-fe/src/lib/components/Header.svelte"
      provides: "Updated header with UserSelector integrated"
      min_lines: 15
    - path: "perspectize-fe/tests/components/ActivityTable.test.ts"
      provides: "Component tests for ActivityTable"
      min_lines: 20
    - path: "perspectize-fe/tests/components/UserSelector.test.ts"
      provides: "Component tests for UserSelector"
      min_lines: 20
  key_links:
    - from: "perspectize-fe/src/routes/+page.svelte"
      to: "/api (graphqlClient)"
      via: "TanStack Query createQuery with LIST_CONTENT"
      pattern: "createQuery"
    - from: "perspectize-fe/src/routes/+page.svelte"
      to: "perspectize-fe/src/lib/components/ActivityTable.svelte"
      via: "passes content data as rowData prop"
      pattern: "ActivityTable"
    - from: "perspectize-fe/src/lib/components/ActivityTable.svelte"
      to: "@ag-grid-community/core"
      via: "AG Grid with Quick Filter and pagination"
      pattern: "AgGridSvelte5Component"
    - from: "perspectize-fe/src/lib/components/UserSelector.svelte"
      to: "perspectize-fe/src/lib/stores/userSelection.svelte"
      via: "imports selectedUserId for two-way binding"
      pattern: "selectedUserId"
    - from: "perspectize-fe/src/lib/components/Header.svelte"
      to: "perspectize-fe/src/lib/components/UserSelector.svelte"
      via: "renders UserSelector in header actions area"
      pattern: "UserSelector"
---

<objective>
Build the Activity page UI with AG Grid table displaying real content data, text search, column sorting, pagination, and a user selector dropdown in the header.

Purpose: This is the core deliverable of Phase 2 — transforming the placeholder Activity page into a functional data table that users can sort, filter, and paginate. The user selector enables attribution for future perspective creation.

Output: Fully functional Activity page as the default landing page, with AG Grid table, Quick Filter search, pagination (10/25/50), and UserSelector in the header.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-data-layer-activity/02-RESEARCH.md
@.planning/phases/02-data-layer-activity/02-01-SUMMARY.md

Key existing files (from Phase 1):
@perspectize-fe/src/routes/+page.svelte
@perspectize-fe/src/routes/+layout.svelte
@perspectize-fe/src/lib/components/Header.svelte
@perspectize-fe/src/lib/components/AGGridTest.svelte
@perspectize-fe/src/lib/components/PageWrapper.svelte
@perspectize-fe/src/lib/queries/client.ts
@perspectize-fe/src/lib/components/shadcn/index.ts
@perspectize-fe/tests/helpers/render.ts
@perspectize-fe/tests/setup.ts
@perspectize-fe/vite.config.ts

Files from 02-01 (data layer):
@perspectize-fe/src/lib/queries/content.ts
@perspectize-fe/src/lib/queries/users.ts
@perspectize-fe/src/lib/stores/userSelection.svelte.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ActivityTable and UserSelector components</name>
  <files>
    perspectize-fe/src/lib/components/ActivityTable.svelte
    perspectize-fe/src/lib/components/UserSelector.svelte
  </files>
  <action>
    Create two new components: the AG Grid content table and the user selector dropdown.

    **File 1 - `src/lib/components/ActivityTable.svelte`:**

    Create an AG Grid wrapper component that displays content data with sorting, filtering, and pagination. Accept `rowData` as a prop (data fetched by parent page).

    Props:
    - `rowData: ContentRow[]` — array of content items to display
    - `loading: boolean` — show loading overlay when true (default false)

    Interface for row data (define in script):
    ```typescript
    interface ContentRow {
      id: string;
      name: string;
      url: string | null;
      contentType: string;
      length: number | null;      // duration in seconds
      lengthUnits: string | null;
      createdAt: string;
      updatedAt: string;
    }
    ```

    Column definitions (ACT-02 requirements — thumbnail deferred to later since backend Content type doesn't have a thumbnail field, use URL/name instead):
    - **Title** (`name`): `flex: 2`, sortable, filterable. Cell renderer: if URL exists, wrap name in `<a>` tag linking to URL (target="_blank"). Otherwise plain text.
    - **Type** (`contentType`): `width: 100`, sortable.
    - **Duration**: Computed from `length` + `lengthUnits`. Use AG Grid `valueFormatter` to display "15:42" format for seconds, or the raw value for other units. If null, display "—".
    - **Date Added** (`createdAt`): `width: 140`, sortable. Use `valueFormatter` to format as locale date string (e.g., "Feb 7, 2026").
    - **Last Updated** (`updatedAt`): `width: 140`, sortable. Default sort column (desc). Use `valueFormatter` like Date Added.

    Note: `perspectiveCount` column is deferred — the backend Content type does not have this field yet (noted in 02-RESEARCH.md Open Question #2). It can be added in a gap closure plan if needed.

    Grid configuration:
    - `pagination: true`
    - `paginationPageSize: 10` (default)
    - `paginationPageSizeSelector: [10, 25, 50]` (ACT-05)
    - `defaultColDef: { resizable: true, sortable: true }`
    - `domLayout: 'autoHeight'`
    - `getRowId: (params) => String(params.data?.id ?? '')`
    - `suppressCellFocus: true` (cleaner UX for read-only table)
    - `modules: [ClientSideRowModelModule]`
    - `theme: themeQuartz.withParams({ fontFamily: 'Inter, sans-serif', fontSize: 14, headerFontSize: 14 })`

    Quick Filter integration (ACT-04):
    - Accept a `searchText` prop: `searchText: string` (default '')
    - Use `$effect()` to call `gridApi.setGridOption('quickFilterText', searchText)` when searchText changes
    - Store `gridApi` via `onGridReady` callback in gridOptions

    Default sorting (ACT-01):
    - Set `sort: 'desc'` on the `updatedAt` column definition to default-sort by most recently updated

    **Do NOT:**
    - Import from `ag-grid-community` (use `@ag-grid-community/*`)
    - Import AG Grid CSS files (use `themeQuartz.withParams()`)
    - Use `AgGridSvelte` (use `AgGridSvelte5Component`)
    - Create a perspectiveCount column (backend doesn't support it yet)

    **File 2 - `src/lib/components/UserSelector.svelte`:**

    Create a dropdown component for selecting the active user. Uses TanStack Query to fetch users and the userSelection store for persistence.

    Approach: Use a native HTML `<select>` element styled with Tailwind for simplicity. The shadcn-svelte Select component requires additional primitive installation. A styled native select is sufficient for v1.

    Implementation:
    ```svelte
    <script lang="ts">
      import { createQuery } from '@tanstack/svelte-query';
      import { graphqlClient } from '$lib/queries/client';
      import { LIST_USERS } from '$lib/queries/users';
      import { selectedUserId } from '$lib/stores/userSelection.svelte';

      interface UsersResponse {
        users: Array<{ id: string; username: string; email: string }>;
      }

      const usersQuery = createQuery<UsersResponse>({
        queryKey: ['users'],
        queryFn: () => graphqlClient.request(LIST_USERS),
        staleTime: 5 * 60 * 1000, // 5 minutes (users change rarely)
      });

      function handleChange(event: Event) {
        const target = event.target as HTMLSelectElement;
        const value = target.value;
        selectedUserId = value ? parseInt(value, 10) : null;
      }
    </script>
    ```

    Template:
    - Show a `<select>` with Tailwind classes: `h-9 rounded-md border border-input bg-background px-3 text-sm`
    - Default option: "Select user..." (value="")
    - Map over `usersQuery.data.users` to create `<option>` elements with `value={user.id}` and text `{user.username}`
    - Set `selected` based on `selectedUserId` matching `user.id`
    - When loading: show a single disabled option "Loading..."
    - When error: show a single disabled option "Error loading users"
    - Bind `onchange={handleChange}`

    **Important:**
    - User IDs from GraphQL come as strings (GraphQL `ID!` type). Parse to int for the store.
    - The store (`selectedUserId`) is a number | null. The select value is a string. Handle conversion in `handleChange`.
    - Do NOT install shadcn-svelte Select primitives — use native `<select>` styled with Tailwind.
  </action>
  <verify>
    1. `pnpm run check` passes from perspectize-fe/
    2. Files exist: `ls src/lib/components/ActivityTable.svelte src/lib/components/UserSelector.svelte`
    3. grep confirms `AgGridSvelte5Component` in ActivityTable.svelte
    4. grep confirms `createQuery` in UserSelector.svelte
    5. grep confirms `selectedUserId` import in UserSelector.svelte
  </verify>
  <done>ActivityTable.svelte renders AG Grid with content columns, Quick Filter support, pagination (10/25/50), and default updatedAt desc sort. UserSelector.svelte fetches users via TanStack Query and persists selection to session storage via the store.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Activity page and update Header, add component tests</name>
  <files>
    perspectize-fe/src/routes/+page.svelte
    perspectize-fe/src/lib/components/Header.svelte
    perspectize-fe/tests/components/ActivityTable.test.ts
    perspectize-fe/tests/components/UserSelector.test.ts
  </files>
  <action>
    Replace the placeholder Activity page with the real implementation, add UserSelector to the Header, and write component tests.

    **File 1 - Update `src/routes/+page.svelte`:**

    Replace the entire placeholder content (AGGridTest, toast test buttons) with the real Activity page. The page is responsible for data fetching (TanStack Query) and composing components.

    Structure:
    ```svelte
    <script lang="ts">
      import { createQuery } from '@tanstack/svelte-query';
      import { graphqlClient } from '$lib/queries/client';
      import { LIST_CONTENT } from '$lib/queries/content';
      import PageWrapper from '$lib/components/PageWrapper.svelte';
      import ActivityTable from '$lib/components/ActivityTable.svelte';

      interface ContentResponse {
        content: {
          items: Array<{
            id: string;
            name: string;
            url: string | null;
            contentType: string;
            length: number | null;
            lengthUnits: string | null;
            createdAt: string;
            updatedAt: string;
          }>;
          pageInfo: { hasNextPage: boolean; endCursor: string | null };
          totalCount: number | null;
        };
      }

      // Fetch all content, sorted by last updated (client-side pagination via AG Grid)
      const contentQuery = createQuery<ContentResponse>({
        queryKey: ['content', { first: 100, sortBy: 'UPDATED_AT', sortOrder: 'DESC' }],
        queryFn: () => graphqlClient.request(LIST_CONTENT, {
          first: 100,
          sortBy: 'UPDATED_AT',
          sortOrder: 'DESC',
          includeTotalCount: true
        })
      });

      let searchText = $state('');

      // Derive row data from query result
      let rowData = $derived(contentQuery.data?.content?.items ?? []);
      let totalCount = $derived(contentQuery.data?.content?.totalCount ?? 0);
    </script>
    ```

    Template layout:
    ```svelte
    <PageWrapper>
      <div class="space-y-6">
        <!-- Page header with title and search -->
        <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h1 class="text-2xl font-bold">Activity</h1>
            <p class="text-sm text-muted-foreground">
              {#if contentQuery.isLoading}
                Loading content...
              {:else}
                {totalCount} video{totalCount !== 1 ? 's' : ''} found
              {/if}
            </p>
          </div>

          <!-- Quick Filter search input (ACT-04) -->
          <div class="w-full sm:w-72">
            <input
              type="text"
              bind:value={searchText}
              placeholder="Search title, description..."
              class="w-full h-9 rounded-md border border-input bg-background px-3 text-sm placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring"
            />
          </div>
        </div>

        <!-- Content table -->
        {#if contentQuery.isLoading}
          <div class="flex items-center justify-center py-12">
            <p class="text-muted-foreground">Loading content...</p>
          </div>
        {:else if contentQuery.error}
          <div class="flex items-center justify-center py-12">
            <p class="text-destructive">Failed to load content. Is the backend running?</p>
          </div>
        {:else}
          <ActivityTable {rowData} {searchText} />
        {/if}
      </div>
    </PageWrapper>
    ```

    **Important:**
    - Remove ALL Phase 1 placeholder content (AGGridTest import, toast test buttons, validation checklist)
    - Do NOT remove the AGGridTest.svelte file itself — it can be deleted in a cleanup plan later
    - Fetch `first: 100` to get a reasonable dataset for client-side pagination
    - Use `$derived` for rowData (NOT `$effect`)
    - Show helpful error message when backend is unreachable

    **File 2 - Update `src/lib/components/Header.svelte`:**

    Add the UserSelector component to the header, next to the existing "Add Video" button.

    Changes:
    - Import `UserSelector` from `$lib/components/UserSelector.svelte`
    - Add `<UserSelector />` in the header actions area (the `<div class="flex items-center gap-4">` container), BEFORE the "Add Video" button
    - Keep all existing header functionality (logo, Add Video button, sticky positioning)

    Updated actions area:
    ```svelte
    <div class="flex items-center gap-4">
      <UserSelector />
      <Button onclick={handleAddVideo}>Add Video</Button>
    </div>
    ```

    **File 3 - `tests/components/ActivityTable.test.ts`:**

    Test the ActivityTable component. AG Grid requires browser DOM features that jsdom may not fully support, so focus on testing the component renders without errors and accepts props correctly.

    Mock AG Grid's `AgGridSvelte5Component` to avoid DOM complexity:
    ```typescript
    vi.mock('ag-grid-svelte5', () => ({
      default: vi.fn() // Mock the default export (AgGridSvelte5Component)
    }));
    ```

    Tests:
    - Component renders without errors when given empty rowData
    - Component accepts rowData and searchText props
    - Component exports are correct (default export)

    Use the `renderComponent` helper from `tests/helpers/render.ts`.

    **File 4 - `tests/components/UserSelector.test.ts`:**

    Test the UserSelector component. Mock TanStack Query and the store:
    ```typescript
    vi.mock('@tanstack/svelte-query', () => ({
      createQuery: vi.fn(() => ({
        data: { users: [{ id: '1', username: 'testuser', email: 'test@test.com' }] },
        isLoading: false,
        error: null
      }))
    }));

    vi.mock('$lib/stores/userSelection.svelte', () => ({
      selectedUserId: null
    }));
    ```

    Tests:
    - Component renders a select element
    - Component shows "Select user..." placeholder option
    - Component renders user options when data is available
    - Component shows loading state when isLoading is true

    Use `renderComponent` helper and `screen` from `@testing-library/svelte`.

    **Important:**
    - Mock AG Grid and TanStack Query at module level to avoid DOM/network issues
    - Keep tests focused on component structure, not AG Grid internals
    - All existing tests must still pass
  </action>
  <verify>
    1. `pnpm run check` passes from perspectize-fe/
    2. `pnpm test:run` passes (all tests including new component tests)
    3. grep confirms `createQuery` in +page.svelte
    4. grep confirms `ActivityTable` import in +page.svelte
    5. grep confirms `UserSelector` import in Header.svelte
    6. grep confirms NO `AGGridTest` import in +page.svelte (placeholder removed)
  </verify>
  <done>Activity page displays real content data via TanStack Query in an AG Grid table with Quick Filter search, pagination (10/25/50), and default updatedAt desc sort. UserSelector appears in the header. All placeholder Phase 1 content removed from +page.svelte. Component tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Activity page with AG Grid table showing content from the backend, text search via Quick Filter, column sorting, pagination with page size selector (10/25/50), and user selector dropdown in the header with session persistence.
  </what-built>
  <how-to-verify>
    Prerequisites: Start the Go backend (`cd perspectize-go && make run`) and the frontend dev server (`cd perspectize-fe && pnpm run dev`).

    1. **Navigate to http://localhost:5173** — should show the Activity page as the landing page
    2. **Verify content table** — AG Grid displays content rows with Title, Type, Duration, Date Added, Last Updated columns
    3. **Verify default sort** — content should be sorted by Last Updated (descending) by default
    4. **Test column sorting** — click any column header to sort ascending, click again for descending (ACT-03)
    5. **Test text search** — type in the search box at top-right; table should filter by matching text across all columns (ACT-04)
    6. **Test pagination** — if more than 10 items, pagination controls appear at bottom; try changing page size to 25 and 50 (ACT-05)
    7. **Test user selector** — dropdown in header should list users from the database. Select a user.
    8. **Test session persistence** — after selecting a user, navigate away (if other routes exist) or refresh the page. The selected user should persist. (USER-02)
    9. **Test empty state** — if backend is not running, verify a helpful error message appears ("Failed to load content. Is the backend running?")
    10. **Check responsive** — resize browser to mobile width (375px). Table and search should adapt. Header should still show user selector and Add Video button.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Frontend builds: `cd perspectize-fe && pnpm run build` succeeds
2. Type check: `cd perspectize-fe && pnpm run check` passes
3. All tests: `cd perspectize-fe && pnpm test:run` passes
4. Backend: `cd perspectize-go && make test` passes
5. Visual: Activity page renders content in AG Grid with sorting, filtering, pagination
6. Functional: User selector populates, selection persists in session storage
7. No placeholder content: AGGridTest component no longer rendered on Activity page
</verification>

<success_criteria>
- Activity page is the default landing page showing content sorted by updatedAt desc
- AG Grid table displays content with Title, Type, Duration, Date Added, Last Updated columns
- Users can sort any column by clicking headers (ascending/descending)
- Quick Filter search box filters table content across all columns
- Pagination works with page size selector offering 10/25/50 options
- User selector dropdown in header shows users from database
- Selected user persists in session storage across page navigation/refresh
- All Phase 1 placeholder content removed from +page.svelte
- All tests pass (backend and frontend)
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-layer-activity/02-02-SUMMARY.md`
</output>
