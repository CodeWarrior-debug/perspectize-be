---
phase: 03-add-video-flow
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - perspectize-fe/src/lib/components/AddVideoDialog.svelte
  - perspectize-fe/src/lib/components/Header.svelte
  - perspectize-fe/tests/components/Header.test.ts
  - perspectize-fe/tests/components/AddVideoDialog.test.ts
autonomous: false

must_haves:
  truths:
    - "User can paste a YouTube URL and submit to add a video"
    - "Backend auto-fetches video metadata (title, description, thumbnail, duration) on creation"
    - "User sees success toast (top-right, 2s auto-dismiss) after video creation"
    - "User sees error toast if URL is invalid or fetch fails"
    - "User is warned via toast if video already exists (duplicate detection)"
  artifacts:
    - path: "perspectize-fe/src/lib/components/AddVideoDialog.svelte"
      provides: "Dialog with URL input, mutation, validation, error mapping"
      min_lines: 60
    - path: "perspectize-fe/src/lib/components/Header.svelte"
      provides: "Add Video button wired to dialog open state"
      contains: "AddVideoDialog"
    - path: "perspective-fe/tests/components/AddVideoDialog.test.ts"
      provides: "Component tests for AddVideoDialog"
      min_lines: 30
    - path: "perspectize-fe/tests/components/Header.test.ts"
      provides: "Updated Header tests (dialog integration)"
      min_lines: 30
  key_links:
    - from: "perspectize-fe/src/lib/components/AddVideoDialog.svelte"
      to: "perspectize-fe/src/lib/queries/content.ts"
      via: "imports CREATE_CONTENT_FROM_YOUTUBE mutation"
      pattern: "CREATE_CONTENT_FROM_YOUTUBE"
    - from: "perspectize-fe/src/lib/components/AddVideoDialog.svelte"
      to: "perspectize-fe/src/lib/utils/youtube.ts"
      via: "imports validateYouTubeUrl for client-side validation"
      pattern: "validateYouTubeUrl"
    - from: "perspectize-fe/src/lib/components/AddVideoDialog.svelte"
      to: "perspectize-fe/src/lib/queries/client.ts"
      via: "uses graphqlClient for mutation execution"
      pattern: "graphqlClient"
    - from: "perspectize-fe/src/lib/components/Header.svelte"
      to: "perspectize-fe/src/lib/components/AddVideoDialog.svelte"
      via: "imports and renders AddVideoDialog with bind:open"
      pattern: "AddVideoDialog"
    - from: "perspectize-fe/src/lib/components/AddVideoDialog.svelte"
      to: "svelte-sonner"
      via: "toast.success, toast.error for user feedback"
      pattern: "toast\\."
---

<objective>
Build the AddVideoDialog component with TanStack Query mutation, error mapping for duplicates/invalid URLs, and wire it to the Header's "Add Video" button. Update tests for both components.

Purpose: Complete the Add Video user flow so users can paste a YouTube URL, submit it, and receive toast feedback for success, errors, or duplicates.
Output: Working AddVideoDialog with mutation integration, Header wired to open dialog, and component tests.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-add-video-flow/03-RESEARCH.md
@.planning/phases/03-add-video-flow/03-01-SUMMARY.md

@perspectize-fe/src/lib/components/Header.svelte
@perspectize-fe/src/lib/components/shadcn/index.ts
@perspectize-fe/src/lib/queries/content.ts
@perspectize-fe/src/lib/queries/client.ts
@perspectize-fe/src/lib/utils/youtube.ts
@perspectize-fe/src/routes/+layout.svelte
@perspectize-fe/tests/components/Header.test.ts
@perspectize-fe/tests/helpers/render.ts
@perspectize-fe/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddVideoDialog component with mutation and error handling</name>
  <files>
    perspectize-fe/src/lib/components/AddVideoDialog.svelte
  </files>
  <action>
    Create `src/lib/components/AddVideoDialog.svelte` implementing the complete Add Video dialog flow. Reference the complete component example in 03-RESEARCH.md.

    **Props:**
    - `open` using `$bindable(false)` -- controlled by parent (Header)

    **Reactive state:**
    - `url = $state('')` -- form input value
    - `error = $state('')` -- client-side validation error message

    **Form reset via $effect:**
    - When `open` becomes true, reset `url` and `error` to empty strings
    - This prevents stale form state when reopening the dialog

    **TanStack Query mutation:**
    - Use `createMutation` from `@tanstack/svelte-query`
    - `mutationFn`: calls `graphqlClient.request(CREATE_CONTENT_FROM_YOUTUBE, { input: { url } })`
    - `onSuccess`: show `toast.success('Added: ${data.createContentFromYouTube.name}')`, invalidate content queries via `queryClient.invalidateQueries({ queryKey: ['content'] })`, set `open = false`
    - `onError`: map error messages to user-friendly toasts:
      - If message contains "duplicate" or "already exists" -> `toast.error('This video has already been added')`
      - If message contains "invalid" or "not found" -> `toast.error('Invalid YouTube URL or video not found')`
      - Otherwise -> `toast.error('Failed to add video. Please try again.')`

    **Form submission handler:**
    - Prevent default form submission
    - Call `validateYouTubeUrl(url)` -- if invalid, set `error = 'Please enter a valid YouTube URL'` and return
    - If valid, clear error and call `mutation.mutate(url)`

    **Template structure:**
    ```
    Dialog.Root bind:open
      Dialog.Content
        Dialog.Header
          Dialog.Title "Add Video"
        form onsubmit={handleSubmit}
          div.space-y-4.py-4
            div.space-y-2
              Label for="url" "YouTube URL"
              Input id="url" bind:value={url} placeholder="https://www.youtube.com/watch?v=..." disabled={$mutation.isPending}
              {#if error} p.text-sm.text-destructive {error} {/if}
          Dialog.Footer
            Button type="button" variant="outline" onclick={close} disabled={$mutation.isPending} "Cancel"
            Button type="submit" disabled={$mutation.isPending || !url.trim()} {$mutation.isPending ? 'Adding...' : 'Add Video'}
    ```

    **Imports from barrel file:**
    - `Dialog, Button, Input, Label` from `$lib/components/shadcn`
    - `createMutation, useQueryClient` from `@tanstack/svelte-query`
    - `toast` from `svelte-sonner`
    - `graphqlClient` from `$lib/queries/client`
    - `CREATE_CONTENT_FROM_YOUTUBE` from `$lib/queries/content`
    - `validateYouTubeUrl` from `$lib/utils/youtube`

    **Important:** The Dialog component from shadcn-svelte uses a namespace pattern. Check the installed dialog/index.ts to determine exact import structure. It may export `Dialog` as a namespace object (e.g., `Dialog.Root`, `Dialog.Content`) or as individual named exports. Adapt imports accordingly. The 03-RESEARCH.md shows the Dialog namespace pattern.
  </action>
  <verify>
    ```bash
    cd perspectize-fe
    pnpm run check
    ```
    Type-check passes with no errors on the new component.
  </verify>
  <done>
    AddVideoDialog.svelte exists with: controlled open prop, URL input with validation, TanStack Query mutation with cache invalidation, user-friendly error mapping for duplicates/invalid/generic errors, form reset on dialog open, disabled states during mutation pending.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Header to AddVideoDialog and update all tests</name>
  <files>
    perspectize-fe/src/lib/components/Header.svelte
    perspectize-fe/tests/components/Header.test.ts
    perspective-fe/tests/components/AddVideoDialog.test.ts
  </files>
  <action>
    **1. Update Header.svelte:**
    - Remove the `toast` import and `handleAddVideo` function (placeholder behavior from Phase 1)
    - Add `import AddVideoDialog from './AddVideoDialog.svelte'`
    - Add `let dialogOpen = $state(false)` for dialog state
    - Change Button onclick to `() => dialogOpen = true`
    - Add `<AddVideoDialog bind:open={dialogOpen} />` after the closing `</header>` tag
    - Reference the updated Header example in 03-RESEARCH.md

    **2. Update `tests/components/Header.test.ts`:**
    - Remove the test that checks for `toast.info` being called (the placeholder behavior is gone)
    - The toast mock can be simplified or removed since Header no longer directly uses toast
    - Keep all structural tests (renders header, brand name, h-16, border, responsive padding, max-width, Add Video button)
    - Add test: "renders AddVideoDialog component" -- verify the dialog component is rendered (check for its presence in the DOM)
    - The Header now imports AddVideoDialog which depends on TanStack Query context. You'll need to mock `@tanstack/svelte-query` to provide `useQueryClient` and `createMutation`. A simple approach:
      ```typescript
      vi.mock('@tanstack/svelte-query', () => ({
        useQueryClient: () => ({ invalidateQueries: vi.fn() }),
        createMutation: () => ({
          mutate: vi.fn(),
          subscribe: vi.fn(() => () => {}),
          isPending: false
        })
      }));
      ```
    - Also mock `$lib/queries/client` and `$lib/utils/youtube`:
      ```typescript
      vi.mock('$lib/queries/client', () => ({
        graphqlClient: { request: vi.fn() }
      }));
      vi.mock('$lib/utils/youtube', () => ({
        validateYouTubeUrl: vi.fn(() => true)
      }));
      ```

    **3. Create `tests/components/AddVideoDialog.test.ts`:**
    - Mock dependencies: `@tanstack/svelte-query` (createMutation, useQueryClient), `svelte-sonner` (toast), `$lib/queries/client` (graphqlClient), `$lib/utils/youtube` (validateYouTubeUrl)
    - Test cases:
      a. "renders dialog with title 'Add Video' when open" -- render with `open: true`, check for "Add Video" text
      b. "renders URL input field when open" -- check for input with placeholder containing "youtube"
      c. "renders Cancel and submit buttons when open" -- check for "Cancel" button and "Add Video" submit button
      d. "shows validation error for invalid URL on submit" -- mock `validateYouTubeUrl` to return false, simulate form submission, check for error message
      e. "disables submit button when URL is empty" -- render with open: true, check submit button is disabled
    - Use the same `vi.mock` patterns as Header test, follow testing conventions in `tests/helpers/render.ts`
    - Note: Testing the full mutation flow (success/error toasts, dialog closing) requires more complex TanStack Query mocking. Focus on the component rendering and validation behavior which can be tested without full mutation integration. The mutation integration is verified via the checkpoint task.
  </action>
  <verify>
    ```bash
    cd perspectize-fe
    pnpm run test:run
    pnpm run check
    ```
    All tests pass (existing + updated Header tests + new AddVideoDialog tests). Type-check clean.
  </verify>
  <done>
    Header "Add Video" button opens the AddVideoDialog. Placeholder toast removed. Header and AddVideoDialog component tests pass. All existing tests still pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Add Video flow: clicking "Add Video" in header opens a dialog with YouTube URL input. Submitting a valid URL triggers the backend mutation which auto-fetches video metadata. Success shows a toast with the video name. Invalid URLs show client-side validation errors. Backend errors (duplicate, invalid URL, fetch failure) are mapped to user-friendly toast messages.</what-built>
  <how-to-verify>
    Prerequisites: Backend must be running (`cd perspectize-go && make run`)

    1. Start frontend: `cd perspectize-fe && pnpm run dev`
    2. Open http://localhost:5173 in browser
    3. Click "Add Video" button in header
    4. Verify: Dialog opens with "Add Video" title, URL input, Cancel and Add Video buttons
    5. Try submitting with empty input -- "Add Video" button should be disabled
    6. Type "not-a-url" and click "Add Video" -- should show "Please enter a valid YouTube URL" error
    7. Paste a valid YouTube URL (e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ) and click "Add Video"
    8. Verify: Button shows "Adding...", then success toast appears (top-right, auto-dismiss) with video name
    9. Verify: Dialog closes automatically after success
    10. Try submitting the same URL again -- should show "This video has already been added" error toast
    11. Click Cancel -- dialog should close, no mutation fired
    12. Reopen dialog -- form should be reset (no stale URL or error)
    13. Check mobile (375px width) -- dialog should be responsive
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm run test:run` -- all tests pass (42 existing + new youtube + mutation + AddVideoDialog + updated Header)
2. `pnpm run check` -- no TypeScript errors
3. `pnpm run test:coverage` -- coverage thresholds still met (80% lines/functions/statements, 75% branches)
4. Header "Add Video" button opens dialog (not placeholder toast)
5. Valid YouTube URL submission creates content via backend mutation
6. Success toast shows video name, dialog closes, content queries invalidated
7. Duplicate URL shows "This video has already been added" toast
8. Invalid URL shows client-side validation error before mutation fires
9. Backend errors mapped to user-friendly messages
10. Form resets when dialog reopens
</verification>

<success_criteria>
- User can paste a YouTube URL and submit to add a video (VIDEO-01)
- Backend auto-fetches video metadata on creation (VIDEO-02, verified via success toast showing name)
- Success toast appears (top-right, 2s auto-dismiss) after creation (VIDEO-03)
- Error toast appears for invalid URL or fetch failure (VIDEO-04)
- Duplicate detection warns user via toast (VIDEO-05)
- All tests pass including new component tests (TEST-04)
- Coverage thresholds maintained
</success_criteria>

<output>
After completion, create `.planning/phases/03-add-video-flow/03-02-SUMMARY.md`
</output>
