---
phase: 03.2-activity-page-beta-quality
plan: 01
subsystem: api
tags: [graphql, gqlgen, postgresql, jsonb, youtube-api]

# Dependency graph
requires:
  - phase: 02-data-layer-activity
    provides: Content list query with basic sort/pagination
provides:
  - GraphQL Content fields: channelTitle, publishedAt, tags, description
  - Content sort by VIEW_COUNT, LIKE_COUNT, PUBLISHED_AT
  - Content search filter on name field (ILIKE)
affects: [activity-page, content-display, search]

# Tech tracking
tech-stack:
  added: []
  patterns: [jsonb-extraction-sort, nulls-last-handling]

key-files:
  created: []
  modified:
    - backend/schema.graphql
    - backend/internal/core/domain/pagination.go
    - backend/internal/adapters/graphql/resolvers/helpers.go
    - backend/internal/adapters/repositories/postgres/content_repository.go
    - backend/internal/adapters/graphql/resolvers/schema.resolvers.go
    - backend/internal/adapters/youtube/client.go

key-decisions:
  - "JSONB extraction for sort fields with NULLS LAST to handle missing statistics"
  - "ILIKE search on name field for case-insensitive text search"

patterns-established:
  - "JSONB sort pattern: (response->'items'->0->'statistics'->>'viewCount')::BIGINT with NULLS LAST"
  - "Search filter pattern: name ILIKE %search% in both data and count queries"

# Metrics
duration: 3min
completed: 2026-02-13
---

# Phase 3.2 Plan 01: Backend YouTube Fields Summary

**GraphQL API extended with YouTube metadata fields (channelTitle, publishedAt, tags, description) and content sorting by view/like counts and search filter**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-13T01:25:20Z
- **Completed:** 2026-02-13T01:28:45Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments
- Extended GraphQL Content type with 4 YouTube metadata fields from stored response JSON
- Added 3 new sort options (VIEW_COUNT, LIKE_COUNT, PUBLISHED_AT) with JSONB extraction
- Implemented search filter on name field with case-insensitive ILIKE
- All 78 backend tests pass

## Task Commits

Each task was committed atomically:

1. **Task 1: Extend GraphQL schema with new Content fields, sort options, and search filter** - `4d4bfec` (feat)
2. **Task 2: Extract new fields in helpers.go and wire sort/filter in repository** - `5ab042a` (feat)

## Files Created/Modified

- `backend/schema.graphql` - Added channelTitle, publishedAt, tags, description fields to Content type; extended ContentSortBy with VIEW_COUNT, LIKE_COUNT, PUBLISHED_AT; added search to ContentFilter
- `backend/internal/core/domain/pagination.go` - Added ContentSortByViewCount, ContentSortByLikeCount, ContentSortByPublishedAt constants; added Search field to ContentFilter
- `backend/internal/adapters/graphql/model/models_gen.go` - Generated GraphQL models with new fields (via make graphql-gen)
- `backend/internal/adapters/graphql/generated/generated.go` - Updated GraphQL resolvers (via make graphql-gen)
- `backend/internal/adapters/graphql/resolvers/helpers.go` - Extract channelTitle, publishedAt, tags, description from YouTube response JSON with nil checks
- `backend/internal/adapters/repositories/postgres/content_repository.go` - JSONB extraction for VIEW_COUNT/LIKE_COUNT/PUBLISHED_AT sort; ILIKE search on name; NULLS LAST for JSONB sorts
- `backend/internal/adapters/graphql/resolvers/schema.resolvers.go` - Map search filter from GraphQL to domain
- `backend/internal/adapters/youtube/client.go` - Updated YouTubeAPIResponse struct with tags and publishedAt fields

## Decisions Made

**JSONB extraction for sort fields** - Used PostgreSQL JSONB extraction syntax `(response->'items'->0->'statistics'->>'viewCount')::BIGINT` for sorting by YouTube statistics. Added `NULLS LAST` clause to handle videos without statistics data gracefully.

**ILIKE for search** - Implemented case-insensitive search on name field using ILIKE with `%search%` pattern. Applied to both data query and count query to maintain consistent pagination totals.

**Helper function for JSONB sort detection** - Created `isJSONBSort()` helper to centralize logic for determining when to add NULLS LAST clause, keeping the query construction code clean.

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - schema changes generated cleanly, JSONB extraction syntax worked on first attempt, all tests passed.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Backend GraphQL API ready for frontend Activity Page enhancements:
- Frontend can query channelTitle, publishedAt, tags, description for richer content display
- Frontend can sort by view count, like count, or published date
- Frontend can implement text search on video titles

No blockers for Phase 3.2 Plan 02 (Frontend Activity Page enhancements).

---
*Phase: 03.2-activity-page-beta-quality*
*Completed: 2026-02-13*
