---
phase: 03.2-activity-page-beta-quality
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/components/AddVideoPopover.svelte
  - frontend/src/lib/components/Header.svelte
  - perspective-frontend/src/lib/components/shadcn/popover/index.ts
  - frontend/src/lib/components/shadcn/popover/popover-content.svelte
  - frontend/src/lib/components/shadcn/index.ts
  - frontend/tests/components/AddVideoDialog.test.ts
  - frontend/tests/components/Header.test.ts
autonomous: true

must_haves:
  truths:
    - "Clicking Add Video button opens a non-modal popover near the button, not a centered modal"
    - "Page stays interactive while popover is open (no overlay, no background darkening)"
    - "Clicking outside the popover dismisses it"
    - "Submitting a valid YouTube URL adds the video (toast confirmation) and closes the popover"
    - "URL input does not show browser autofill suggestions (autocomplete=off)"
    - "Invalid URL shows inline error, popover stays open"
  artifacts:
    - path: "perspective-frontend/src/lib/components/AddVideoPopover.svelte"
      provides: "Non-modal popover with YouTube URL input, mutation, validation"
      min_lines: 50
    - path: "frontend/src/lib/components/Header.svelte"
      provides: "Header with AddVideoPopover replacing AddVideoDialog"
      contains: "AddVideoPopover"
    - path: "frontend/src/lib/components/shadcn/popover/index.ts"
      provides: "shadcn Popover component exports"
      contains: "Popover"
  key_links:
    - from: "frontend/src/lib/components/AddVideoPopover.svelte"
      to: "/api GraphQL mutation"
      via: "createMutation with CREATE_CONTENT_FROM_YOUTUBE"
      pattern: "createMutation"
    - from: "frontend/src/lib/components/Header.svelte"
      to: "frontend/src/lib/components/AddVideoPopover.svelte"
      via: "import and render"
      pattern: "AddVideoPopover"
---

<objective>
Replace the full-screen modal Add Video dialog with a non-modal popover that appears near the Add Video button, keeping the page interactive.

Purpose: The user explicitly wants to interact with the page while the dialog is open. The current modal with overlay is disruptive and jerks the user into a new context. A popover near the button maintains spatial context and allows page interaction. This pattern will be reused in Phase 4 for Add Perspective.

Output: New AddVideoPopover component using shadcn Popover, updated Header to use it, old AddVideoDialog can be left in place but unused (removal in Phase 10 cleanup).
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-activity-page-beta-quality/03.2-CONTEXT.md
@.planning/phases/03.2-activity-page-beta-quality/03.2-RESEARCH.md
@frontend/CLAUDE.md

Key existing files:
@frontend/src/lib/components/AddVideoDialog.svelte
@frontend/src/lib/components/Header.svelte
@frontend/src/lib/components/shadcn/index.ts
@frontend/src/lib/utils/youtube.ts
@frontend/src/lib/queries/content.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn Popover and create AddVideoPopover component</name>
  <files>
    frontend/src/lib/components/shadcn/popover/index.ts
    frontend/src/lib/components/shadcn/popover/popover-content.svelte
    frontend/src/lib/components/shadcn/index.ts
    frontend/src/lib/components/AddVideoPopover.svelte
  </files>
  <action>
    **1. Install shadcn Popover component:**
    ```bash
    cd fe && pnpm dlx shadcn-svelte@latest add popover
    ```
    This will create files in `src/lib/components/shadcn/popover/`. If the CLI puts them elsewhere (e.g., `src/lib/components/ui/popover/`), move them to `shadcn/popover/` to match the project convention (shadcn components live in `shadcn/` directory, not `ui/`).

    **2. Update the shadcn barrel export** in `src/lib/components/shadcn/index.ts`:
    Add Popover exports after the Label export:
    ```typescript
    export { default as Popover } from "./popover/index.js";
    ```
    Actually, shadcn Popover uses namespace exports. Check the generated popover/index.ts for the exact export pattern. If it exports `Root`, `Trigger`, `Content` etc., then in the barrel file, re-export them as a namespace:
    ```typescript
    export * as Popover from "./popover/index.js";
    ```
    Or if the barrel pattern doesn't support namespace exports cleanly, import the Popover directly in AddVideoPopover.svelte from `$lib/components/shadcn/popover`.

    **3. Create `AddVideoPopover.svelte`** — This component replaces AddVideoDialog. Port the mutation logic from AddVideoDialog.svelte but use Popover instead of Dialog:

    ```svelte
    <script lang="ts">
      import { createMutation, useQueryClient } from '@tanstack/svelte-query';
      import { toast } from 'svelte-sonner';
      import * as Popover from '$lib/components/shadcn/popover';
      import { Button } from '$lib/components/shadcn';
      import { Input } from '$lib/components/shadcn';
      import { Label } from '$lib/components/shadcn';
      import { graphqlClient } from '$lib/queries/client';
      import { CREATE_CONTENT_FROM_YOUTUBE } from '$lib/queries/content';
      import { validateYouTubeUrl } from '$lib/utils/youtube';

      let open = $state(false);
      let url = $state('');
      let error = $state('');

      // Reset form when popover opens
      $effect(() => {
        if (open) {
          url = '';
          error = '';
        }
      });

      const queryClient = useQueryClient();

      const mutation = createMutation(() => ({
        mutationFn: async (videoUrl: string) => {
          return graphqlClient.request(CREATE_CONTENT_FROM_YOUTUBE, {
            input: { url: videoUrl }
          });
        },
        onSuccess: (data: any) => {
          const name = data?.createContentFromYouTube?.name ?? 'video';
          toast.success(`Added: ${name}`);
          queryClient.invalidateQueries({ queryKey: ['content'] });
          open = false;
        },
        onError: (err: Error) => {
          const message = err.message.toLowerCase();
          if (message.includes('already exists')) {
            toast.error('This video has already been added');
          } else if (message.includes('invalid youtube url') || message.includes('video not found')) {
            toast.error('Invalid YouTube URL or video not found');
          } else {
            toast.error('Failed to add video. Please try again.');
          }
        }
      }));

      function handleSubmit(e: Event) {
        e.preventDefault();
        if (!validateYouTubeUrl(url)) {
          error = 'Please enter a valid YouTube URL';
          return;
        }
        error = '';
        mutation.mutate(url);
      }
    </script>

    <Popover.Root bind:open>
      <Popover.Trigger asChild let:builder>
        <Button builders={[builder]} size="sm">Add Video</Button>
      </Popover.Trigger>
      <Popover.Content class="w-80" sideOffset={8} align="end">
        <form onsubmit={handleSubmit}>
          <div class="grid gap-3">
            <div class="space-y-1">
              <Label for="video-url" class="text-sm font-medium">YouTube URL</Label>
              <Input
                id="video-url"
                type="url"
                bind:value={url}
                autocomplete="off"
                placeholder="https://youtube.com/watch?v=..."
                disabled={mutation.isPending}
              />
              {#if error}
                <p class="text-xs text-destructive">{error}</p>
              {/if}
            </div>
            <div class="flex justify-end gap-2">
              <Button
                type="button"
                variant="outline"
                size="sm"
                onclick={() => (open = false)}
                disabled={mutation.isPending}
              >
                Cancel
              </Button>
              <Button type="submit" size="sm" disabled={mutation.isPending || !url.trim()}>
                {mutation.isPending ? 'Adding...' : 'Add'}
              </Button>
            </div>
          </div>
        </form>
      </Popover.Content>
    </Popover.Root>
    ```

    KEY DETAILS:
    - `align="end"` positions the popover to the right edge of the trigger (near the button)
    - `sideOffset={8}` gives 8px gap between button and popover
    - `autocomplete="off"` prevents browser autofill on the URL input
    - No overlay/portal — page stays interactive
    - Click-outside dismiss is default Popover behavior
    - Same mutation logic, error handling, and toast feedback as AddVideoDialog
    - Uses `type="url"` for semantic HTML

    NOTE: Check the exact shadcn-svelte Popover API. The Svelte 5 version may use `{#snippet}` syntax instead of `asChild let:builder`. If so, adapt:
    ```svelte
    <Popover.Trigger>
      {#snippet child({ props })}
        <Button {...props} size="sm">Add Video</Button>
      {/snippet}
    </Popover.Trigger>
    ```
    Consult the installed bits-ui version for the correct pattern.
  </action>
  <verify>
    - `cd fe && pnpm run check` passes type checking
    - `ls frontend/src/lib/components/shadcn/popover/` shows popover component files
    - `ls frontend/src/lib/components/AddVideoPopover.svelte` exists
  </verify>
  <done>
    shadcn Popover installed in shadcn/popover/ directory. AddVideoPopover.svelte created with non-modal popover, mutation logic, autocomplete=off, click-outside dismiss, form validation, and toast feedback. Type checking passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Header to use AddVideoPopover and update tests</name>
  <files>
    frontend/src/lib/components/Header.svelte
    frontend/tests/components/Header.test.ts
    frontend/tests/components/AddVideoDialog.test.ts
  </files>
  <action>
    **1. Update Header.svelte** — Replace AddVideoDialog with AddVideoPopover:

    Remove the import of AddVideoDialog and the `dialogOpen` state. Remove the `<AddVideoDialog bind:open={dialogOpen} />` at the bottom. Remove the `<Button onclick={() => (dialogOpen = true)}>` and replace the entire Add Video button area with the AddVideoPopover component.

    The Header should become:
    ```svelte
    <script lang="ts">
      import UserSelector from '$lib/components/UserSelector.svelte';
      import AddVideoPopover from '$lib/components/AddVideoPopover.svelte';
    </script>

    <header class="h-16 border-b border-border bg-white sticky top-0 z-50">
      <div class="h-full px-4 md:px-6 lg:px-8 max-w-screen-xl mx-auto flex items-center justify-between gap-2 md:gap-4">
        <a href="/" class="font-bold text-base sm:text-lg md:text-xl text-foreground hover:text-primary transition-colors min-w-0 truncate">
          Perspectize
        </a>
        <div class="flex items-center gap-2 md:gap-4 shrink-0">
          <UserSelector />
          <AddVideoPopover />
        </div>
      </div>
    </header>
    ```

    Note: AddVideoPopover renders its own trigger button (the "Add Video" button is inside the Popover.Trigger). No separate button needed in Header.

    **2. Update Header.test.ts** — Update tests to expect "AddVideoPopover" instead of "AddVideoDialog". The test may check for the "Add Video" button text -- this should still work since the button is rendered by AddVideoPopover. Remove any tests that assert `dialogOpen` state or dialog visibility. Instead, test that the AddVideoPopover component is rendered in the Header.

    **3. Update AddVideoDialog.test.ts** — Either:
    - Rename to AddVideoPopover.test.ts and update to test the new component, OR
    - Keep AddVideoDialog.test.ts for the old component (if not deleted) and create a new AddVideoPopover.test.ts

    Create `tests/components/AddVideoPopover.test.ts` with tests:
    - Component renders with "Add Video" button text
    - Component exports are correct (no required props)

    For the popover interaction tests (opening, form validation, submission), these require complex DOM interaction that may be difficult in jsdom. Focus on:
    - Rendering without errors
    - Button text is "Add Video"
    - Component can be imported and instantiated

    **4. Run test coverage gate:**
    ```bash
    cd fe && pnpm run test:coverage
    ```
    Must pass 80% stmts/lines/functions, 75% branches.
  </action>
  <verify>
    - `cd fe && pnpm run test:coverage` exits 0
    - `cd perspective-fe && pnpm run check` passes type checking
    - Header.svelte imports AddVideoPopover, not AddVideoDialog
    - No Button with onclick handler for dialog in Header (the trigger is inside AddVideoPopover)
  </verify>
  <done>
    Header uses AddVideoPopover instead of AddVideoDialog. Tests updated. Coverage gate passes. The Add Video button opens a popover near the button without any modal overlay.
  </done>
</task>

</tasks>

<verification>
- `cd fe && pnpm run check` — type checking passes
- `cd fe && pnpm run test:coverage` — coverage gate passes (80% stmts/lines/functions, 75% branches)
- Dev server: clicking "Add Video" opens a popover near the button, not a centered modal
- Page behind the popover is still interactive (no overlay, no darkening)
- Clicking outside the popover dismisses it
- Submitting a valid YouTube URL shows success toast and closes popover
- URL input has autocomplete="off" attribute
</verification>

<success_criteria>
- AddVideoPopover component exists and uses shadcn Popover (not Dialog)
- Header renders AddVideoPopover instead of AddVideoDialog
- Popover appears near the Add Video button (align="end", sideOffset)
- No modal overlay or background darkening
- Page stays interactive while popover is open
- All existing mutation/validation/toast behavior preserved
- Frontend test coverage gate passes
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-activity-page-beta-quality/03.2-02-SUMMARY.md`
</output>
