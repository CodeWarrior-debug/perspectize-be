---
phase: 03.2-activity-page-beta-quality
plan: 04
type: execute
wave: 3
depends_on: ["03.2-02", "03.2-03"]
files_modified:
  - fe/src/routes/+page.svelte
  - perspective-fe/src/lib/components/ActivityTable.svelte
  - fe/src/routes/+layout.svelte
  - fe/tests/components/Header.test.ts
  - fe/tests/components/ActivityTable.test.ts
autonomous: false

must_haves:
  truths:
    - "Activity page renders with heading, popover button in header, and full-height table"
    - "Column chooser button or right-click menu allows showing/hiding columns"
    - "All 11 success criteria from ROADMAP are satisfied in the integrated page"
    - "Frontend and backend test coverage gates pass"
  artifacts:
    - path: "fe/src/routes/+page.svelte"
      provides: "Integrated Activity page with heading, no subtitle, no global search"
      contains: "ActivityTable"
    - path: "perspective-fe/src/lib/components/ActivityTable.svelte"
      provides: "Final polished table with all features integrated"
      min_lines: 100
  key_links:
    - from: "fe/src/lib/components/Header.svelte"
      to: "fe/src/lib/components/AddVideoPopover.svelte"
      via: "import and render"
      pattern: "AddVideoPopover"
    - from: "fe/src/routes/+page.svelte"
      to: "fe/src/lib/components/ActivityTable.svelte"
      via: "import and render"
      pattern: "ActivityTable"
---

<objective>
Integration pass: polish the Activity page by connecting the popover dialog, table, and layout together, fix any rough edges, and verify all 11 success criteria.

Purpose: Plans 01-03 built the individual pieces (backend fields, popover dialog, table rewrite). This plan ensures they work together correctly -- the popover triggers from the header, the table loads server-side data, the layout fits correctly, and any integration issues are resolved.

Output: Fully integrated Activity page that meets all 11 success criteria from the roadmap. Visual checkpoint for user verification.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-activity-page-beta-quality/03.2-CONTEXT.md
@.planning/phases/03.2-activity-page-beta-quality/03.2-01-SUMMARY.md
@.planning/phases/03.2-activity-page-beta-quality/03.2-02-SUMMARY.md
@.planning/phases/03.2-activity-page-beta-quality/03.2-03-SUMMARY.md
@fe/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integration polish and test coverage</name>
  <files>
    perspective-fe/src/routes/+page.svelte
    perspective-fe/src/lib/components/ActivityTable.svelte
    perspective-fe/src/routes/+layout.svelte
    perspective-fe/tests/components/Header.test.ts
    perspective-fe/tests/components/ActivityTable.test.ts
  </files>
  <action>
    **1. Verify layout integration** — Ensure the page header (Header.svelte in +layout.svelte) stays sticky at `top-0 z-50`, and the Activity page content below it uses `h-[calc(100vh-4rem)]` to fill remaining height. The AG Grid inside ActivityTable should have its own scroll container (domLayout='normal') so column headers stick while data scrolls.

    If the layout isn't working correctly (double scroll bars, content not filling viewport, headers not sticky), fix:
    - `+layout.svelte`: Ensure the main content area doesn't add its own scroll. Remove any `overflow-auto` on the main container.
    - `+page.svelte`: Ensure `h-[calc(100vh-4rem)]` correctly accounts for the 4rem (h-16) header.
    - `ActivityTable.svelte`: Ensure the grid container uses `flex-1 min-h-0` to fill available space without overflowing.

    **2. Verify popover + table interaction** — Test that:
    - Add Video popover opens from the header button
    - While popover is open, the table is still scrollable/clickable
    - After adding a video, the table refetches and shows the new item
    - The popover's `queryClient.invalidateQueries({ queryKey: ['content'] })` triggers a refetch. But since ActivityTable now uses `graphqlClient.request` directly (not TanStack Query), the invalidation won't work automatically. Fix this by either:
      - (a) Having ActivityTable use TanStack Query internally (preferred -- keeps cache consistency), OR
      - (b) Dispatching a custom event from AddVideoPopover that ActivityTable listens to for refetch

    **Option (a) is preferred.** Modify ActivityTable to use TanStack Query for data fetching:
    ```svelte
    const contentQuery = createQuery(() => ({
      queryKey: ['content', { page: currentPage, pageSize, sortField, sortDirection, filter: buildFilter() }],
      queryFn: () => graphqlClient.request<ContentResponse>(LIST_CONTENT, {
        first: pageSize,
        after: cursors[currentPage] || undefined,
        sortBy: sortField,
        sortOrder: sortDirection,
        includeTotalCount: true,
        filter: buildFilter(),
      }),
      staleTime: 30_000, // 30 seconds
    }));
    ```
    Then derive rowData from query result:
    ```svelte
    let rowData = $derived(contentQuery.data?.content.items ?? []);
    ```
    And update pagination state from query result via $effect.

    IMPORTANT: If switching to TanStack Query complicates the reactive fetching (since sort/filter/page changes need to re-trigger the query), AND the functional wrapper pattern already handles this (the query re-runs when reactive dependencies in the queryKey change), then this approach is clean. But cursor management gets tricky because `cursors[currentPage]` must be stable.

    Alternative simpler approach: Keep the manual `fetchData()` function but add a way for AddVideoPopover to signal a refetch. Since the popover already calls `queryClient.invalidateQueries({ queryKey: ['content'] })`, have ActivityTable ALSO use TanStack Query so the invalidation propagates. This is the right call.

    **3. Ensure test coverage meets gates** — After integration changes, run:
    ```bash
    cd fe && pnpm run test:coverage
    ```
    If coverage drops due to new untested code paths (pagination controls, sort handlers, filter handlers), add targeted tests. Focus on:
    - Formatting utilities (already tested in Plan 03)
    - Component rendering (mocked GraphQL client)
    - Don't try to test AG Grid interactions in jsdom (they require real DOM)

    **4. Run backend tests:**
    ```bash
    cd backend && make test
    ```

    **5. Fix any type errors:**
    ```bash
    cd perspective-fe && pnpm run check
    ```
  </action>
  <verify>
    - `cd perspective-fe && pnpm run check` passes
    - `cd fe && pnpm run test:coverage` exits 0
    - `cd backend && make test` passes
    - Dev server loads Activity page without errors
    - Adding a video via popover causes the table to show the new item
  </verify>
  <done>
    Activity page fully integrated: header popover, table with server-side ops, layout with sticky headers and full-height table, all working together. Test coverage gates pass for both frontend and backend.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Activity page beta quality rebuild:
    1. Server-side sorting (click column headers)
    2. Per-column floating filters (type in filter inputs below headers)
    3. Server-side pagination (prev/next buttons, page size selector)
    4. 6 default columns: Item (thumbnail+title), Type (YouTube icon), Length, Views, Likes, Date
    5. Hidden columns via right-click column header: Channel, Date Added, Date Updated, Tags, Description
    6. Compact rows (~44px)
    7. Sticky page header + sticky table headers
    8. Add Video as popover (not modal) -- page stays interactive
    9. Data provenance tooltips on column headers
    10. Empty state message
    11. YouTube metadata fields exposed through GraphQL
  </what-built>
  <how-to-verify>
    Start both servers:
    ```bash
    cd backend && make run &
    cd fe && pnpm run dev
    ```
    Open http://localhost:5173 in browser.

    **Verify these 11 success criteria:**

    1. **Server-side sorting:** Click "Views" column header. Check Network tab -- should see GraphQL request with `sortBy: "VIEW_COUNT"`. Data should reorder. Click again for DESC.

    2. **Per-column filters:** Look for filter input below the "Item" column header. Type a few characters. After 500ms debounce, Network tab should show a new query with filter.search parameter.

    3. **Server-side pagination:** Look at bottom pagination bar. Shows "1-10 of N". Click right arrow. Network tab should show query with `after` cursor. Page size dropdown: change to 25, verify 25 rows load.

    4. **6 default columns:** Verify you see: Item (with small thumbnail), Type (red play icon), Length, Views, Likes, Date.

    5. **Column chooser:** Right-click any column header. Select "Columns" tab. Check/uncheck "Channel" -- it should appear/disappear. Also try Date Added, Tags, Description.

    6. **New YouTube fields:** Views should show numbers like "1.2K" or "45.3K". Likes similar. Date should show YouTube publish date (not database date). Hover column headers to see tooltips.

    7. **Compact rows:** Rows should be ~44px height. Thumbnails small (~40x30px).

    8. **Sticky headers:** Scroll down in the table. Both the app header ("Perspectize" logo bar) and the AG Grid column headers should stay fixed.

    9. **Add Video popover:** Click "Add Video" button. A popover should appear near the button (not a centered modal). The table behind it should still be scrollable/clickable. Paste a YouTube URL and submit -- should show success toast and table updates.

    10. **Data provenance tooltips:** Hover over any column header. Tooltip should say something like "View count (from YouTube API -- source data, read-only)".

    11. **Empty state:** If you have no data, the table should show "No items yet - add the first one!" in the grid area.

    **Also check:**
    - No console errors
    - Page loads quickly (no loading all 100 items upfront)
    - Mobile: resize to 375px -- table should still be usable (no P1 regressions)
  </how-to-verify>
  <resume-signal>Type "approved" or describe specific issues to fix</resume-signal>
</task>

</tasks>

<verification>
- All 11 roadmap success criteria verified by human
- `cd perspective-fe && pnpm run check && pnpm run test:coverage` passes
- `cd backend && make test` passes
- No console errors in browser
- No visual regressions at 375px
</verification>

<success_criteria>
- Human confirms all 11 success criteria from ROADMAP are met
- Frontend and backend test coverage gates pass
- No console errors
- No mobile regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-activity-page-beta-quality/03.2-04-SUMMARY.md`
</output>
