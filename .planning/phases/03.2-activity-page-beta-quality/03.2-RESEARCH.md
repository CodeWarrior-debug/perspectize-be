# Phase 3.2: Activity Page Beta Quality - Research

**Researched:** 2026-02-12
**Domain:** AG Grid server-side operations, SvelteKit/Svelte 5, GraphQL pagination/filtering, popover UI patterns
**Confidence:** HIGH

## Summary

This phase rebuilds the Activity page table on top of the design token system from Phase 3.1, implementing server-side data operations (sorting/filtering/pagination), exposing new YouTube metadata columns, and replacing the modal dialog with a non-modal popover pattern.

**Key findings:**
- AG Grid Server-Side Row Model (SSRM) requires implementing an IServerSideDatasource with a getRows() callback that receives request parameters (startRow, endRow, sortModel, filterModel) and returns data via success() callback.
- The GraphQL schema already includes viewCount and likeCount fields, but the backend YouTube adapter doesn't extract them from the API response. Additional fields (channelTitle, publishedAt, tags) exist in the YouTube API response but aren't surfaced.
- shadcn-svelte provides a Popover component built on bits-ui primitives, using Floating UI for positioning. The pattern is non-modal by default and supports anchoring to trigger elements.
- AG Grid provides built-in floating filters, column chooser via tool panel or column menu, sticky headers by default, and customizable overlays for empty/loading states.

**Primary recommendation:** Use AG Grid SSRM with GraphQL cursor-based pagination (already implemented in the schema). Extend backend YouTube adapter to extract statistics and snippet fields from the existing API response (no new API calls needed). Use shadcn-svelte Popover with Floating UI for the dialog redesign.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| AG Grid v32.2.x | 32.2.1 | Data grid with SSRM | Industry standard for complex data grids, built-in server-side operations, column management, floating filters |
| ag-grid-svelte5 | 1.0.3 | Svelte 5 wrapper | Official Svelte 5 adapter, bundles AG Grid internally |
| @tanstack/svelte-query | 6.0.18 | Data fetching | Established pattern in codebase, handles GraphQL queries reactively |
| shadcn-svelte | latest | UI primitives | Established in codebase, includes Popover component |
| bits-ui | 2.15.5 | Headless components | Powers shadcn-svelte, provides accessible primitives |
| Floating UI | (via bits-ui) | Popover positioning | Industry standard for floating element positioning |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| graphql-request | 7.4.0 | GraphQL client | Already used for mutations/queries |
| svelte-sonner | 1.0.7 | Toast notifications | Already used for feedback |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| SSRM | Client-Side Row Model with infinite scroll | SSRM is more appropriate for true server-side operations; client-side would require fetching all data upfront |
| Floating UI | Manual positioning | Floating UI handles edge cases (viewport boundaries, scroll containers) that manual positioning misses |
| shadcn Popover | bits-ui Popover directly | shadcn provides styled components matching the design system |

**Installation:**
```bash
# Already installed — no new dependencies needed
# AG Grid packages already pinned to 32.2.x
# shadcn Popover can be added via CLI if not present:
pnpm dlx shadcn-svelte@latest add popover
```

## Architecture Patterns

### Recommended Project Structure
```
fe/src/
├── routes/
│   └── (dashboard)/
│       └── activity/
│           ├── +page.svelte           # Activity page container
│           ├── ActivityTable.svelte   # AG Grid wrapper with SSRM
│           ├── AddVideoPopover.svelte # Non-modal popover dialog
│           └── columns.ts             # Column definitions with filters/tooltips
├── lib/
│   ├── queries/
│   │   └── content.ts                 # GraphQL query with pagination args
│   └── components/shadcn/popover/     # shadcn Popover components
```

### Pattern 1: AG Grid Server-Side Datasource
**What:** Implement IServerSideDatasource to delegate sorting/filtering/pagination to GraphQL backend
**When to use:** Whenever you need to display large datasets with server-controlled operations

**Example:**
```typescript
// Source: https://www.ag-grid.com/javascript-data-grid/server-side-model-datasource/
import type { IServerSideDatasource, IServerSideGetRowsParams } from '@ag-grid-community/core';

const datasource: IServerSideDatasource = {
  getRows(params: IServerSideGetRowsParams) {
    const { request, success, fail } = params;
    const { startRow, endRow, sortModel, filterModel } = request;

    // Calculate pagination args
    const pageSize = endRow - startRow;

    // Transform sortModel to GraphQL args
    const sortBy = sortModel[0]?.colId || 'CREATED_AT';
    const sortOrder = sortModel[0]?.sort === 'asc' ? 'ASC' : 'DESC';

    // Transform filterModel to GraphQL filter input
    const filter = buildFilterFromModel(filterModel);

    // Query GraphQL
    graphqlClient.request(CONTENT_QUERY, {
      first: pageSize,
      after: encodeCursor(startRow),
      sortBy,
      sortOrder,
      filter,
      includeTotalCount: true
    })
    .then(response => {
      success({
        rowData: response.content.items,
        rowCount: response.content.totalCount // enables "last page" button
      });
    })
    .catch(error => {
      console.error('Failed to fetch rows:', error);
      fail();
    });
  }
};

// Apply to grid
gridOptions.serverSideDatasource = datasource;
gridOptions.rowModelType = 'serverSide';
gridOptions.cacheBlockSize = 25; // matches page size
```

### Pattern 2: Floating Filters Per-Column
**What:** Enable per-column filters in the header row instead of global search
**When to use:** When columns have different data types requiring different filter UIs

**Example:**
```typescript
// Source: https://www.ag-grid.com/javascript-data-grid/floating-filters/
const columnDefs = [
  {
    field: 'name',
    headerName: 'Title',
    floatingFilter: true,
    filter: 'agTextColumnFilter',
    filterParams: {
      debounceMs: 500
    }
  },
  {
    field: 'viewCount',
    headerName: '# Views',
    floatingFilter: true,
    filter: 'agNumberColumnFilter'
  },
  {
    field: 'createdAt',
    headerName: 'Date',
    floatingFilter: true,
    filter: 'agDateColumnFilter'
  }
];
```

### Pattern 3: Non-Modal Popover with Floating UI
**What:** Use shadcn Popover for dialogs that don't block page interaction
**When to use:** When users might want to reference page content while filling a form

**Example:**
```svelte
<!-- Source: https://www.shadcn-svelte.com/docs/components/popover -->
<script lang="ts">
  import * as Popover from "$lib/components/shadcn/popover";
  import Button from "$lib/components/shadcn/button/button.svelte";
  import Input from "$lib/components/shadcn/input/input.svelte";

  let url = $state('');
  let open = $state(false);

  function handleSubmit() {
    // Mutation logic
    open = false;
  }
</script>

<Popover.Root bind:open>
  <Popover.Trigger asChild let:builder>
    <Button builders={[builder]}>Add Video</Button>
  </Popover.Trigger>
  <Popover.Content class="w-80" sideOffset={8} align="end">
    <form onsubmit={handleSubmit}>
      <Input
        type="url"
        bind:value={url}
        autocomplete="off"
        placeholder="YouTube URL"
      />
      <Button type="submit">Submit</Button>
    </form>
  </Popover.Content>
</Popover.Root>
```

### Pattern 4: Column Header Tooltips
**What:** Display data provenance information on column header hover
**When to use:** To explain what data source a column comes from

**Example:**
```typescript
// Source: https://www.ag-grid.com/javascript-data-grid/tooltips/
const columnDefs = [
  {
    field: 'viewCount',
    headerName: '# Views',
    headerTooltip: 'View count from YouTube API (source data, read-only)'
  },
  {
    field: 'createdAt',
    headerName: 'Date Added',
    headerTooltip: 'Date this video was added to Perspectize (database)'
  }
];
```

### Anti-Patterns to Avoid
- **Don't mix client-side and server-side row models** — Pick one row model type and stick with it. Switching between them causes state inconsistencies.
- **Don't forget cacheBlockSize** — Must match your page size or SSRM will make redundant requests.
- **Don't use OFFSET pagination with cursor-based GraphQL** — AG Grid's startRow/endRow must be converted to cursor values, not used directly as OFFSET.
- **Don't create modal overlays for non-modal popovers** — Use Popover.Root without Popover.Overlay or Popover.Portal to prevent background darkening.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Floating element positioning | Manual absolute positioning with offsets | Floating UI (via bits-ui/shadcn) | Handles viewport boundaries, scroll containers, flipping, collision detection |
| Empty state overlays | Custom "no data" div overlaid on grid | AG Grid `overlayNoRowsTemplate` | Integrated with grid lifecycle, auto-shows/hides, supports custom components |
| Column visibility management | Custom checkbox list for show/hide | AG Grid Columns Tool Panel or Column Menu | Built-in, keyboard accessible, drag-to-reorder, searchable |
| Filter UI components | Custom input fields synced to state | AG Grid floating filters | Type-appropriate (text/number/date), debounced, integrated with SSRM |
| Cursor pagination logic | Manual base64 encode/decode | Relay cursor connection pattern (already in backend schema) | Opaque cursors, standardized PageInfo, hasNextPage/hasPreviousPage |
| Sort/filter state management | Manual state tracking for sort direction, active filters | AG Grid SSRM request object | Grid manages state, passes changes via sortModel/filterModel |

**Key insight:** AG Grid SSRM was designed for exactly this use case. Don't fight the framework by rebuilding its features. Implementing IServerSideDatasource is the only custom code needed — everything else is configuration.

## Common Pitfalls

### Pitfall 1: OFFSET vs Cursor Pagination Mismatch
**What goes wrong:** AG Grid SSRM sends startRow/endRow (OFFSET-style), but GraphQL uses cursor-based pagination (first/after).
**Why it happens:** The two pagination styles don't map 1:1. startRow=50 doesn't mean "skip 50 rows" with cursors.
**How to avoid:** Convert startRow to a cursor. For example, if startRow=50, encode cursor as `base64("cursor:50")` and pass as `after` argument. Maintain a cursor cache or use deterministic cursor encoding based on sort order.
**Warning signs:** Duplicate rows appear when paginating, or rows are skipped entirely.

### Pitfall 2: Forgetting includeTotalCount for Last Page Detection
**What goes wrong:** Pagination controls show "Next" button even on the last page because AG Grid doesn't know the total row count.
**Why it happens:** GraphQL query doesn't request `totalCount`, so AG Grid can't determine when to stop.
**How to avoid:** Always include `includeTotalCount: true` in SSRM queries and pass `rowCount` in the success() callback.
**Warning signs:** Clicking "Next" on the last page makes empty API requests.

### Pitfall 3: Not Debouncing Filter Changes
**What goes wrong:** Every keystroke in a filter input triggers a GraphQL query, causing network spam and poor UX.
**Why it happens:** Default filter behavior is immediate.
**How to avoid:** Set `filterParams: { debounceMs: 500 }` on text column filters.
**Warning signs:** Network tab shows dozens of identical queries as user types.

### Pitfall 4: Browser Autocomplete Fighting URL Input
**What goes wrong:** Browser suggests previously pasted URLs in the "Add Video" input, even though user doesn't want these suggestions.
**Why it happens:** Modern browsers aggressively autocomplete URL fields.
**How to avoid:** Set `autocomplete="off"` on the input. For extra protection, consider `autocomplete="new-url"` or a non-standard value. Note: Some browsers ignore autocomplete="off" on password/username fields, but URL fields usually respect it.
**Warning signs:** Users complain about unwanted suggestions appearing in the input.

### Pitfall 5: Missing YouTube Fields in Backend Response
**What goes wrong:** GraphQL query returns null for viewCount, likeCount, publishedAt, channelTitle, or tags even though the data exists.
**Why it happens:** The YouTube adapter fetches these fields from the API but doesn't extract them into the Content domain model. They're only stored in the raw `response` JSON field.
**How to avoid:** Update the YouTube adapter's `GetVideoMetadata()` to extract statistics.viewCount, statistics.likeCount, statistics.commentCount, snippet.channelTitle, snippet.publishedAt, and snippet.tags into the VideoMetadata struct. Update the domain model to include these fields.
**Warning signs:** GraphQL playground shows null for new columns, but inspecting the `response` JSON shows the data is present.

### Pitfall 6: Sticky Header Conflicts with domLayout="autoHeight"
**What goes wrong:** Column headers scroll with the table body instead of staying fixed at the top.
**Why it happens:** domLayout="autoHeight" disables AG Grid's internal scrolling container.
**How to avoid:** Use domLayout="normal" (default) with an explicit grid height. The grid creates its own scroll container, which enables sticky headers. Combine with a page-level sticky header for the Activity heading.
**Warning signs:** Headers disappear when scrolling down the table.

## Code Examples

Verified patterns from official sources:

### Server-Side Datasource with GraphQL
```typescript
// Source: https://www.ag-grid.com/javascript-data-grid/server-side-model-datasource/
// Adapted for GraphQL cursor pagination

import type { IServerSideDatasource, IServerSideGetRowsParams } from '@ag-grid-community/core';
import { graphqlClient } from '$lib/queries/client';
import { gql } from 'graphql-request';

const CONTENT_QUERY = gql`
  query ContentList(
    $first: Int
    $after: String
    $sortBy: ContentSortBy
    $sortOrder: SortOrder
    $filter: ContentFilter
    $includeTotalCount: Boolean
  ) {
    content(
      first: $first
      after: $after
      sortBy: $sortBy
      sortOrder: $sortOrder
      filter: $filter
      includeTotalCount: $includeTotalCount
    ) {
      items {
        id
        name
        url
        length
        viewCount
        likeCount
        createdAt
        updatedAt
      }
      pageInfo {
        hasNextPage
        endCursor
      }
      totalCount
    }
  }
`;

function createServerSideDatasource(): IServerSideDatasource {
  return {
    getRows(params: IServerSideGetRowsParams) {
      const { request, success, fail } = params;
      const { startRow, endRow, sortModel, filterModel } = request;

      const pageSize = endRow - startRow;

      // Convert AG Grid sortModel to GraphQL args
      const sortBy = sortModel[0]?.colId?.toUpperCase() || 'CREATED_AT';
      const sortOrder = sortModel[0]?.sort?.toUpperCase() || 'DESC';

      // Convert startRow to cursor
      // Simple approach: encode row index (more sophisticated: maintain cursor cache)
      const after = startRow > 0 ? btoa(`cursor:${startRow - 1}`) : undefined;

      // Convert filterModel to GraphQL filter
      const filter = buildGraphQLFilter(filterModel);

      graphqlClient.request(CONTENT_QUERY, {
        first: pageSize,
        after,
        sortBy,
        sortOrder,
        filter,
        includeTotalCount: true
      })
      .then(response => {
        success({
          rowData: response.content.items,
          rowCount: response.content.totalCount // CRITICAL: enables last page detection
        });
      })
      .catch(error => {
        console.error('Server-side datasource error:', error);
        fail();
      });
    }
  };
}

function buildGraphQLFilter(filterModel: any): any {
  // Transform AG Grid filterModel to GraphQL ContentFilter input
  // Example: { name: { type: 'contains', filter: 'example' } }
  //       -> { search: 'example' }
  // Implement based on your GraphQL schema's filter capabilities
  return {};
}
```

### Floating Filters Configuration
```typescript
// Source: https://www.ag-grid.com/javascript-data-grid/floating-filters/

import type { ColDef } from '@ag-grid-community/core';

const columnDefs: ColDef[] = [
  {
    field: 'name',
    headerName: 'Item',
    floatingFilter: true,
    filter: 'agTextColumnFilter',
    filterParams: {
      debounceMs: 500,
      buttons: ['reset', 'apply']
    }
  },
  {
    field: 'viewCount',
    headerName: '# Views',
    floatingFilter: true,
    filter: 'agNumberColumnFilter',
    filterParams: {
      debounceMs: 500
    }
  },
  {
    field: 'createdAt',
    headerName: 'Date',
    floatingFilter: true,
    filter: 'agDateColumnFilter'
  }
];
```

### Custom Empty State Overlay
```typescript
// Source: https://www.ag-grid.com/javascript-data-grid/overlays/

const gridOptions = {
  overlayNoRowsTemplate: '<span>No items yet - add the first one!</span>',
  // Alternative: custom component
  // noRowsOverlayComponent: CustomNoRowsOverlay
};
```

### shadcn Popover with Click-Outside Dismiss
```svelte
<!-- Source: https://www.shadcn-svelte.com/docs/components/popover -->
<script lang="ts">
  import * as Popover from "$lib/components/shadcn/popover";
  import Button from "$lib/components/shadcn/button/button.svelte";
  import Input from "$lib/components/shadcn/input/input.svelte";
  import Label from "$lib/components/shadcn/label/label.svelte";

  let url = $state('');
  let open = $state(false);

  async function handleSubmit(e: Event) {
    e.preventDefault();
    // Mutation logic
    open = false; // Close on success
  }
</script>

<Popover.Root bind:open>
  <Popover.Trigger asChild let:builder>
    <Button builders={[builder]} variant="default">
      Add Video
    </Button>
  </Popover.Trigger>
  <Popover.Content
    class="w-80"
    sideOffset={8}
    align="end"
  >
    <!-- No Popover.Overlay — page stays interactive -->
    <!-- Click-outside dismiss is default behavior -->
    <form onsubmit={handleSubmit}>
      <div class="grid gap-4">
        <Label for="url">YouTube URL</Label>
        <Input
          id="url"
          type="url"
          bind:value={url}
          autocomplete="off"
          placeholder="https://youtube.com/watch?v=..."
        />
        <div class="flex justify-end gap-2">
          <Button type="button" variant="secondary" onclick={() => open = false}>
            Cancel
          </Button>
          <Button type="submit">
            Add
          </Button>
        </div>
      </div>
    </form>
  </Popover.Content>
</Popover.Root>
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Client-side pagination (fetch all, paginate locally) | Server-side pagination with SSRM | AG Grid SSRM introduced ~2017 | Scales to millions of rows, reduces initial load time |
| Global search bar | Per-column floating filters | AG Grid added floating filters in v18 (2017) | More precise filtering, type-appropriate UIs |
| Modal dialogs for forms | Non-modal popovers | Popover API baseline 2024, Floating UI v1 2021 | Less disruptive UX, users can reference page content |
| OFFSET pagination | Cursor-based pagination (Relay spec) | Relay connection spec published 2015 | Stable pagination with concurrent updates, opaque cursors |
| Manual column show/hide UI | AG Grid Columns Tool Panel | Built-in since early versions | Accessible, searchable, drag-to-reorder |

**Deprecated/outdated:**
- `on:click` event syntax in Svelte 5 — use `onclick` attribute
- `export let` for props in Svelte 5 — use `$props()` rune
- `$: reactive statements` in Svelte 5 — use `$derived()` or `$effect()`
- `autocomplete="false"` — use `autocomplete="off"` (string "false" is not a valid value)

## Open Questions

Things that couldn't be fully resolved:

1. **Cursor encoding strategy for AG Grid startRow**
   - What we know: AG Grid sends startRow (integer offset), GraphQL expects cursor (opaque string)
   - What's unclear: Should we maintain a cursor cache, or use deterministic encoding based on sort field + row index?
   - Recommendation: Start with deterministic encoding (`btoa("cursor:{id}")`) since the backend already uses ID-based cursors. If sort order changes break pagination, implement a cursor cache.

2. **Filter capabilities of ContentFilter input**
   - What we know: GraphQL schema has a ContentFilter input with contentType and length range filters
   - What's unclear: Does it support text search on name/description? Multi-column filters?
   - Recommendation: Check backend ContentFilter implementation. May need to extend it to support per-column text filters. Alternatively, use floating filters only for columns that map to existing filter fields, disable for others in Phase 3.2.

3. **YouTube API publishedAt vs database createdAt**
   - What we know: User wants "Date" column to show YouTube publish date, not Perspectize database date
   - What's unclear: Does the YouTube API always return publishedAt? Is it nullable?
   - Recommendation: Verify YouTube API response structure. If publishedAt is always present, extract it. If nullable, fall back to database createdAt with a visual indicator (tooltip showing which date is displayed).

4. **Column chooser placement — header or toolbar?**
   - What we know: User requested "column chooser button near the heading or as a toolbar element"
   - What's unclear: Exact placement preference
   - Recommendation: Place near "Activity" heading as a secondary button (outlined/ghost variant). AG Grid Tool Panel is an alternative but requires a sidebar, which may not fit the "maximize table real estate" goal.

## Sources

### Primary (HIGH confidence)
- [AG Grid Server-Side Row Model](https://www.ag-grid.com/javascript-data-grid/server-side-model/) - SSRM architecture and concepts
- [AG Grid SSRM Datasource](https://www.ag-grid.com/javascript-data-grid/server-side-model-datasource/) - IServerSideDatasource interface, getRows() parameters
- [AG Grid SSRM Pagination](https://www.ag-grid.com/javascript-data-grid/server-side-model-pagination/) - Pagination configuration, lastRowIndex for total count
- [AG Grid Floating Filters](https://www.ag-grid.com/javascript-data-grid/floating-filters/) - Per-column filter configuration, floating filter types
- [AG Grid Column Menu](https://www.ag-grid.com/javascript-data-grid/column-menu/) - Right-click column header menu
- [AG Grid Columns Tool Panel](https://www.ag-grid.com/javascript-data-grid/tool-panel-columns/) - Column chooser sidebar
- [AG Grid Tooltips](https://www.ag-grid.com/javascript-data-grid/tooltips/) - Header tooltips, cell tooltips, custom components
- [AG Grid Overlays](https://www.ag-grid.com/javascript-data-grid/overlays/) - Empty state and loading overlays
- [shadcn-svelte Popover](https://www.shadcn-svelte.com/docs/components/popover) - Popover component structure, usage with Svelte 5
- [Floating UI Popover](https://floating-ui.com/docs/popover) - Positioning, click-outside dismiss, accessibility
- [Relay GraphQL Cursor Connections Specification](https://relay.dev/graphql/connections.htm) - Connection, Edge, PageInfo structure
- [YouTube Data API Videos](https://developers.google.com/youtube/v3/docs/videos) - Video resource structure, snippet and statistics fields
- [MDN autocomplete attribute](https://developer.mozilla.org/en-US/docs/Web/HTML/Reference/Attributes/autocomplete) - Preventing browser autofill

### Secondary (MEDIUM confidence)
- [GraphQL Filtering, Pagination & Sorting Tutorial](https://www.howtographql.com/graphql-js/8-filtering-pagination-and-sorting/) - Best practices for filter/sort arguments
- [Medium: YouTube Data API v3 — Fetch View Counts](https://medium.com/code-uncomplicated/youtube-data-api-v3-fetch-view-counts-thumbnails-and-more-73df8b44b5a0) - Example response structure

### Tertiary (LOW confidence)
- WebSearch results for AG Grid sticky headers (GitHub issues) - Indicates domLayout="autoHeight" conflicts with sticky headers, but not verified in official docs
- Community discussions on autocomplete="off" effectiveness - Modern browsers may ignore it, but URL fields usually respect it

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries verified as already installed and in use
- Architecture: HIGH - Official AG Grid docs, official shadcn-svelte docs, verified codebase patterns
- Pitfalls: MEDIUM - Cursor pagination mismatch inferred from AG Grid docs + GraphQL schema, not tested
- YouTube fields: HIGH - Backend schema and YouTube adapter code inspected directly, YouTube API docs verified

**Research date:** 2026-02-12
**Valid until:** 30 days (stable technologies, AG Grid v32 established, Svelte 5 stable)
