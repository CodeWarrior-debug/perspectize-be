---
phase: 04-add-perspective-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - perspectize-fe/src/lib/queries/perspectives.ts
  - perspectize-fe/src/lib/components/shadcn/progress/
  - perspectize-fe/src/lib/components/shadcn/textarea/
  - perspectize-fe/src/lib/components/shadcn/index.ts
  - perspectize-fe/src/lib/components/RatingInput.svelte
  - perspectize-fe/src/lib/components/VideoSelector.svelte
  - perspectize-fe/tests/unit/queries-perspectives.test.ts
  - perspectize-fe/tests/components/RatingInput.test.ts
  - perspectize-fe/tests/components/VideoSelector.test.ts
autonomous: true

must_haves:
  truths:
    - "CREATE_PERSPECTIVE mutation definition matches backend schema (createPerspective with CreatePerspectiveInput)"
    - "RatingInput renders a number input (0-10000) paired with a progress bar that visually reflects the value"
    - "RatingInput clamps values to 0-10000 range and handles NaN input gracefully"
    - "VideoSelector fetches content list via TanStack Query and renders a dropdown of video titles"
    - "shadcn Progress and Textarea components are installed and exported from barrel"
  artifacts:
    - path: "perspectize-fe/src/lib/queries/perspectives.ts"
      provides: "CREATE_PERSPECTIVE mutation definition"
      exports: ["CREATE_PERSPECTIVE"]
      min_lines: 15
    - path: "perspectize-fe/src/lib/components/RatingInput.svelte"
      provides: "Reusable rating input with progress bar visualization"
      min_lines: 40
    - path: "perspectize-fe/src/lib/components/VideoSelector.svelte"
      provides: "Video selection dropdown with TanStack Query"
      min_lines: 30
    - path: "perspectize-fe/src/lib/components/shadcn/index.ts"
      provides: "Barrel exports including Progress and Textarea"
      contains: "Progress"
    - path: "perspectize-fe/tests/unit/queries-perspectives.test.ts"
      provides: "Unit tests for perspective query definitions"
      min_lines: 20
    - path: "perspectize-fe/tests/components/RatingInput.test.ts"
      provides: "Component tests for RatingInput"
      min_lines: 30
  key_links:
    - from: "perspectize-fe/src/lib/queries/perspectives.ts"
      to: "perspectize-go/schema.graphql"
      via: "GraphQL mutation name and input type must match"
      pattern: "createPerspective"
    - from: "perspectize-fe/src/lib/components/RatingInput.svelte"
      to: "perspectize-fe/src/lib/components/shadcn/index.ts"
      via: "imports Progress component from barrel"
      pattern: "Progress"
    - from: "perspectize-fe/src/lib/components/VideoSelector.svelte"
      to: "perspectize-fe/src/lib/queries/content.ts"
      via: "uses LIST_CONTENT query to populate dropdown"
      pattern: "LIST_CONTENT"
---

<objective>
Create the foundation pieces for the Add Perspective flow: GraphQL mutation definition, shadcn Progress/Textarea components, reusable RatingInput component, VideoSelector component, and tests for all new code.

Purpose: Establish the building blocks (query, UI primitives, reusable components) that the AddPerspectiveDialog needs in Plan 02, following the same foundation-then-assembly pattern used in Phase 3.
Output: Tested mutation definition, two reusable components (RatingInput, VideoSelector), and shadcn Progress/Textarea ready for use.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-add-perspective-flow/04-RESEARCH.md

@perspectize-fe/src/lib/components/shadcn/index.ts
@perspectize-fe/src/lib/queries/content.ts
@perspectize-fe/src/lib/queries/client.ts
@perspectize-fe/src/lib/components/UserSelector.svelte
@perspectize-fe/vite.config.ts
@perspectize-fe/tests/unit/queries-content.test.ts
@perspectize-fe/tests/components/UserSelector.test.ts
@perspectize-fe/tests/helpers/render.ts
@perspectize-go/schema.graphql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn components, create mutation definition, and add query tests</name>
  <files>
    perspectize-fe/src/lib/components/shadcn/progress/
    perspectize-fe/src/lib/components/shadcn/textarea/
    perspectize-fe/src/lib/components/shadcn/index.ts
    perspectize-fe/src/lib/queries/perspectives.ts
    perspectize-fe/tests/unit/queries-perspectives.test.ts
  </files>
  <action>
    1. **Install shadcn Progress and Textarea components via CLI:**
       ```bash
       cd perspectize-fe
       npx shadcn-svelte@latest add progress textarea --yes
       ```
       This creates files under `src/lib/components/shadcn/progress/` and `src/lib/components/shadcn/textarea/`.

    2. **Update barrel export file `src/lib/components/shadcn/index.ts`:**
       Add exports for Progress and Textarea. Keep alphabetized (Button, then Progress, then Textarea -- plus whatever Dialog, Input, Label exports Phase 3 added before this). Check the generated `progress/index.ts` and `textarea/index.ts` to see exact export names and re-export them. Follow the same pattern as the existing Button export line.

       NOTE: Phase 3 (which runs before Phase 4) will have already added Dialog, Input, and Label exports to this file. Preserve those -- only ADD Progress and Textarea exports in their alphabetical positions.

    3. **Create `src/lib/queries/perspectives.ts`** with the CREATE_PERSPECTIVE mutation definition:
       ```typescript
       import { gql } from 'graphql-request';

       export const CREATE_PERSPECTIVE = gql`
         mutation CreatePerspective($input: CreatePerspectiveInput!) {
           createPerspective(input: $input) {
             id
             claim
             userID
             contentID
             quality
             agreement
             importance
             confidence
             like
             privacy
             createdAt
           }
         }
       `;
       ```
       This matches the backend schema exactly. The mutation requires `claim: String!` and `userID: IntID!` as required fields. Optional fields: `contentID`, `quality`, `agreement`, `importance`, `confidence`, `like`, `privacy`, `description`, `category`.

    4. **Create `tests/unit/queries-perspectives.test.ts`** with tests for the mutation:
       Follow the same pattern as `tests/unit/queries-content.test.ts`:
       - Test that `CREATE_PERSPECTIVE` is exported and is a string (gql tagged template result)
       - Test that it contains `createPerspective` operation name
       - Test that it contains `CreatePerspectiveInput` input type
       - Test that it requests expected return fields: `id`, `claim`, `userID`, `contentID`, `quality`, `agreement`, `importance`, `confidence`, `like`
       - Test that it does NOT contain fields not needed by the form: `description`, `category`, `reviewStatus` (these are in the Perspective type but not requested in the return)

       Use `describe`/`it` blocks, import from `$lib/queries/perspectives`.
  </action>
  <verify>
    ```bash
    cd perspectize-fe
    ls src/lib/components/shadcn/progress/index.ts
    ls src/lib/components/shadcn/textarea/index.ts
    grep -q "Progress" src/lib/components/shadcn/index.ts
    grep -q "Textarea" src/lib/components/shadcn/index.ts
    grep -q "createPerspective" src/lib/queries/perspectives.ts
    pnpm run test:run
    pnpm run check
    ```
  </verify>
  <done>
    Progress and Textarea shadcn components installed and exported from barrel. CREATE_PERSPECTIVE mutation definition matches backend schema. Query tests pass. Type-check clean.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RatingInput and VideoSelector components with tests</name>
  <files>
    perspectize-fe/src/lib/components/RatingInput.svelte
    perspectize-fe/src/lib/components/VideoSelector.svelte
    perspectize-fe/tests/components/RatingInput.test.ts
    perspectize-fe/tests/components/VideoSelector.test.ts
  </files>
  <action>
    1. **Create `src/lib/components/RatingInput.svelte`:**
       A reusable component that pairs a number input (0-10000) with a shadcn Progress bar for visual feedback.

       **Props (Svelte 5 runes):**
       - `label: string` -- field label text (e.g., "Quality", "Agreement")
       - `name: string` -- input id/name for form association
       - `value: number | null = $bindable(null)` -- current rating value, bindable for parent control
       - `field: any = null` -- optional TanStack Form field API for integration (calls `field.handleChange` and `field.handleBlur`)
       - `required: boolean = false` -- shows required indicator

       **Constants:**
       - `MAX_RATING = 10000`

       **Input handling (`handleInput` function):**
       - Parse `event.target.value` with `parseInt(value, 10)`
       - If `Number.isNaN(numValue)` or `numValue < 0`, set value to `0`
       - If `numValue > MAX_RATING`, clamp to `MAX_RATING`
       - Otherwise set value to `numValue`
       - Call `field?.handleChange(value)` after updating

       **Blur handling:**
       - Call `field?.handleBlur()` on blur

       **Template structure:**
       ```
       div.space-y-2
         label.text-sm.font-medium for={name}
           {label}
           {#if required} span.text-destructive "*" {/if}
         div.flex.items-center.gap-4
           input type="number" min="0" max={MAX_RATING} value={value ?? 0}
             class="h-9 w-28 rounded-md border border-input bg-background px-3 text-sm"
             oninput={handleInput} onblur={handleBlur}
           div.flex-1
             Progress value={value ?? 0} max={MAX_RATING} class="h-2"
             p.text-xs.text-muted-foreground.mt-1 "{value ?? 0} / {MAX_RATING}"
         {#if field?.state.meta.errors.length > 0}
           span.text-destructive.text-sm {field.state.meta.errors[0]}
         {/if}
       ```

       **Imports:**
       - `Progress` from `$lib/components/shadcn` (barrel import)

       Reference: Pattern 2 in 04-RESEARCH.md for the complete example.

    2. **Create `src/lib/components/VideoSelector.svelte`:**
       A dropdown component that fetches the content list via TanStack Query and lets the user select a video.

       **Props (Svelte 5 runes):**
       - `value: number | null = $bindable(null)` -- selected content ID, bindable
       - `field: any = null` -- optional TanStack Form field API

       **TanStack Query:**
       - Use `createQuery(() => ({ ... }))` pattern (Svelte 5 function wrapper)
       - Query key: `['content']`
       - Query function: `graphqlClient.request(LIST_CONTENT, { first: 100, sortBy: 'NAME', sortOrder: 'ASC' })` to get all videos sorted alphabetically
       - `staleTime: 5 * 60 * 1000` (5 minutes)

       **Change handling:**
       - Parse `event.target.value` with `parseInt(value, 10)` -- if empty string, set to `null`
       - Call `field?.handleChange(newValue)` after updating

       **Template structure -- use native `<select>` element (simple, matches UserSelector pattern):**
       ```
       {#if contentQuery.isLoading}
         select.h-9.rounded-md.border.border-input.bg-background.px-3.text-sm disabled
           option "Loading videos..."
       {:else if contentQuery.error}
         select.h-9.rounded-md.border.border-input.bg-background.px-3.text-sm.text-destructive disabled
           option "Error loading videos"
       {:else if contentQuery.data}
         select value={value ? String(value) : ''} onchange={handleChange} onblur={field?.handleBlur}
           class="h-9 w-full rounded-md border border-input bg-background px-3 text-sm"
           option value="" "Select video..."
           {#each contentQuery.data.content.items as content}
             option value={content.id} {content.name}
           {/each}
       {/if}
       ```

       **Imports:**
       - `createQuery` from `@tanstack/svelte-query`
       - `graphqlClient` from `$lib/queries/client`
       - `LIST_CONTENT` from `$lib/queries/content`

       Reference: Pattern 3 in 04-RESEARCH.md and existing UserSelector.svelte pattern.

    3. **Create `tests/components/RatingInput.test.ts`:**
       Mock the Progress component from shadcn (it's excluded from coverage in vite.config.ts anyway):
       ```typescript
       vi.mock('$lib/components/shadcn', () => ({
         Progress: vi.fn()
       }));
       ```

       Test cases:
       a. "renders label with provided text" -- render with label="Quality", check for "Quality" text
       b. "renders number input with min 0 and max 10000" -- check input attributes
       c. "shows required indicator when required=true" -- render with required=true, check for "*" text
       d. "does not show required indicator when required=false" -- render with required=false, no "*"
       e. "displays value / 10000 text" -- render, check for "0 / 10000" text
       f. "renders progress bar element" -- check that a progress-related element exists in DOM

       Note: Testing actual input change behavior requires firing input events and checking reactive updates. Keep tests focused on initial render state. The clamping behavior will be verified via the checkpoint in Plan 02.

    4. **Create `tests/components/VideoSelector.test.ts`:**
       Mock TanStack Query and GraphQL client:
       ```typescript
       vi.mock('@tanstack/svelte-query', () => ({
         createQuery: vi.fn(() => ({
           isLoading: false,
           error: null,
           data: {
             content: {
               items: [
                 { id: '1', name: 'Test Video 1' },
                 { id: '2', name: 'Test Video 2' }
               ]
             }
           }
         }))
       }));
       vi.mock('$lib/queries/client', () => ({
         graphqlClient: { request: vi.fn() }
       }));
       ```

       Test cases:
       a. "renders select element with placeholder option" -- check for "Select video..." option
       b. "renders video options from query data" -- check for "Test Video 1" and "Test Video 2" options

       Follow the same mocking patterns established in UserSelector.test.ts and Header.test.ts.
  </action>
  <verify>
    ```bash
    cd perspectize-fe
    pnpm run test:run
    pnpm run check
    ```
    All tests pass (existing + new RatingInput + VideoSelector + perspectives query tests). Type-check passes.
  </verify>
  <done>
    RatingInput.svelte renders number input (0-10000) with Progress bar visualization, clamps values, integrates with TanStack Form field API. VideoSelector.svelte fetches content list and renders native select dropdown. Both have component tests passing. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm run test:run` -- all tests pass (existing + new query + component tests)
2. `pnpm run check` -- no TypeScript errors
3. `grep -q "Progress" perspectize-fe/src/lib/components/shadcn/index.ts` -- Progress exported
4. `grep -q "Textarea" perspectize-fe/src/lib/components/shadcn/index.ts` -- Textarea exported
5. `grep -q "createPerspective" perspectize-fe/src/lib/queries/perspectives.ts` -- mutation defined
6. `grep -q "CREATE_PERSPECTIVE" perspectize-fe/src/lib/queries/perspectives.ts` -- mutation exported
7. `test -f perspectize-fe/src/lib/components/RatingInput.svelte` -- RatingInput exists
8. `test -f perspectize-fe/src/lib/components/VideoSelector.svelte` -- VideoSelector exists
</verification>

<success_criteria>
- shadcn Progress and Textarea installed and exported from barrel
- CREATE_PERSPECTIVE mutation matches backend schema (claim, userID required; quality, agreement, importance, confidence, like optional)
- RatingInput renders number input (0-10000) with progress bar, clamps values, handles NaN
- VideoSelector fetches content via TanStack Query, renders dropdown with video names
- All tests pass including new component and query tests
- Type-check clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-add-perspective-flow/04-01-SUMMARY.md`
</output>
