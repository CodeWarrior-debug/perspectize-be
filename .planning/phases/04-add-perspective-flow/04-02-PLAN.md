---
phase: 04-add-perspective-flow
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - fe/src/lib/components/AddPerspectiveDialog.svelte
  - fe/src/lib/components/Header.svelte
  - fe/tests/components/AddPerspectiveDialog.test.ts
  - fe/tests/components/Header.test.ts
autonomous: false

must_haves:
  truths:
    - "User can select a video to add a perspective on"
    - "User can set Quality, Agreement, Importance, and Confidence ratings via number inputs with progress bar visualization"
    - "User can enter Like text and Review text (freeform)"
    - "User sees validation error toasts before submission if form is invalid"
    - "User sees success toast after perspective is created, attributed to selected user"
  artifacts:
    - path: "fe/src/lib/components/AddPerspectiveDialog.svelte"
      provides: "TanStack Form dialog with video selector, 4 rating inputs, like/review fields, validation, mutation"
      min_lines: 120
    - path: "fe/src/lib/components/Header.svelte"
      provides: "Add Perspective button wired to dialog open state"
      contains: "AddPerspectiveDialog"
    - path: "fe/tests/components/AddPerspectiveDialog.test.ts"
      provides: "Component tests for AddPerspectiveDialog"
      min_lines: 40
    - path: "fe/tests/components/Header.test.ts"
      provides: "Updated Header tests (both dialogs)"
      min_lines: 30
  key_links:
    - from: "fe/src/lib/components/AddPerspectiveDialog.svelte"
      to: "fe/src/lib/queries/perspectives.ts"
      via: "imports CREATE_PERSPECTIVE mutation"
      pattern: "CREATE_PERSPECTIVE"
    - from: "fe/src/lib/components/AddPerspectiveDialog.svelte"
      to: "fe/src/lib/stores/userSelection.svelte"
      via: "reads selected user ID for mutation input"
      pattern: "getSelectedUserId"
    - from: "fe/src/lib/components/AddPerspectiveDialog.svelte"
      to: "fe/src/lib/components/RatingInput.svelte"
      via: "uses RatingInput for 4 rating fields"
      pattern: "RatingInput"
    - from: "fe/src/lib/components/AddPerspectiveDialog.svelte"
      to: "fe/src/lib/components/VideoSelector.svelte"
      via: "uses VideoSelector for content selection"
      pattern: "VideoSelector"
    - from: "fe/src/lib/components/Header.svelte"
      to: "fe/src/lib/components/AddPerspectiveDialog.svelte"
      via: "imports and renders AddPerspectiveDialog with bind:open"
      pattern: "AddPerspectiveDialog"
---

<objective>
Build the AddPerspectiveDialog component using TanStack Form with video selector, four rating inputs, Like/Review text fields, form validation with toast errors, and the GraphQL mutation. Wire it to the Header with an "Add Perspective" button. Update tests for both components.

Purpose: Complete the Add Perspective user flow so users can create perspectives on videos with ratings, text feedback, and receive toast notifications for validation errors and success.
Output: Working AddPerspectiveDialog with full form, mutation integration, Header wired with both dialog buttons, and component tests.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-add-perspective-flow/04-RESEARCH.md
@.planning/phases/04-add-perspective-flow/04-01-SUMMARY.md

@fe/src/lib/components/Header.svelte
@fe/src/lib/components/RatingInput.svelte
@fe/src/lib/components/VideoSelector.svelte
@fe/src/lib/components/shadcn/index.ts
@fe/src/lib/queries/perspectives.ts
@fe/src/lib/queries/client.ts
@fe/src/lib/stores/userSelection.svelte.ts
@fe/vite.config.ts
@fe/tests/components/Header.test.ts
@fe/tests/helpers/render.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AddPerspectiveDialog with TanStack Form, validation, and mutation</name>
  <files>
    fe/src/lib/components/AddPerspectiveDialog.svelte
  </files>
  <action>
    Create `src/lib/components/AddPerspectiveDialog.svelte` implementing the complete Add Perspective form dialog. Reference the complete code example in 04-RESEARCH.md "Complete Perspective Form with TanStack Form" section.

    **Props:**
    - `open` using `$bindable(false)` -- controlled by parent (Header)

    **TanStack Form setup using `createForm`:**
    ```typescript
    const form = createForm(() => ({
      defaultValues: {
        claim: '',
        quality: null as number | null,
        agreement: null as number | null,
        importance: null as number | null,
        confidence: null as number | null,
        like: '',
        review: '',
        contentID: null as number | null,
      },
      onSubmit: async ({ value }) => { /* see below */ },
    }));
    ```

    **Form reset via $effect:**
    When `open` becomes true, call `form.reset()` to clear stale data from previous attempts.

    **TanStack Query mutation using `createMutation`:**
    - `mutationFn`: calls `graphqlClient.request(CREATE_PERSPECTIVE, { input: { ...value, userID } })`
    - `onSuccess`: show `toast.success('Perspective created successfully')`, set `open = false`
    - `onError`: map error messages to user-friendly toasts:
      - If message contains "user" -> `toast.error('Please select a user before submitting')`
      - If message contains "claim" -> `toast.error('Claim is required')`
      - Otherwise -> `toast.error('Failed to create perspective. Please try again.')`

    **Pre-submission validation in `onSubmit`:**
    Collect errors into an array, show first 3 as toasts, return early if any exist:
    - If `!getSelectedUserId()` -> "Please select a user"
    - If `!value.claim?.trim()` -> "Claim is required"
    - If `value.quality === null` -> "Quality rating is required"
    - If `value.agreement === null` -> "Agreement rating is required"
    - If `value.importance === null` -> "Importance rating is required"
    - If `value.confidence === null` -> "Confidence rating is required"

    Show each error (up to 3) via `toast.error(err)`. If errors exist, return without calling mutation.

    If valid, submit mutation with:
    ```typescript
    await mutation.mutateAsync({
      claim: value.claim,
      userID: getSelectedUserId()!,
      contentID: value.contentID,
      quality: value.quality,
      agreement: value.agreement,
      importance: value.importance,
      confidence: value.confidence,
      like: value.like || undefined,
      description: value.review || undefined,
    });
    ```

    NOTE: The backend schema has no `review` field -- the Review text maps to the `description` field in CreatePerspectiveInput. Send `value.review` as `description`.

    **Template structure:**
    ```
    Dialog.Root bind:open
      Dialog.Content class="max-w-2xl max-h-[90vh] overflow-y-auto"
        Dialog.Header
          Dialog.Title "Add Perspective"
        form onsubmit={(e) => { e.preventDefault(); e.stopPropagation(); form.handleSubmit(); }}
          class="space-y-6"

          -- Video Selection section --
          div.space-y-2
            Label "Video (optional)"
            form.Field name="contentID"
              {#snippet children(field)}
                VideoSelector value={field.state.value} field={field}
              {/snippet}

          -- Claim field (required) --
          div.space-y-2
            form.Field name="claim"
              {#snippet children(field)}
                Label for="claim" "Claim *"
                Input id="claim" value={field.state.value}
                  oninput={(e) => field.handleChange(e.target.value)}
                  onblur={field.handleBlur}
                  placeholder="What is your perspective?"
                {#if field.state.meta.isTouched && field.state.meta.errors.length > 0}
                  span.text-destructive.text-sm {field.state.meta.errors[0]}
                {/if}
              {/snippet}

          -- Ratings section (2x2 grid on desktop, stacked on mobile) --
          div.grid.grid-cols-1.md:grid-cols-2.gap-4
            form.Field name="quality"
              {#snippet children(field)}
                RatingInput label="Quality" name="quality" value={field.state.value} field={field} required
              {/snippet}
            form.Field name="agreement"
              {#snippet children(field)}
                RatingInput label="Agreement" name="agreement" value={field.state.value} field={field} required
              {/snippet}
            form.Field name="importance"
              {#snippet children(field)}
                RatingInput label="Importance" name="importance" value={field.state.value} field={field} required
              {/snippet}
            form.Field name="confidence"
              {#snippet children(field)}
                RatingInput label="Confidence" name="confidence" value={field.state.value} field={field} required
              {/snippet}

          -- Like field (optional, single-line) --
          div.space-y-2
            form.Field name="like"
              {#snippet children(field)}
                Label for="like" "Like"
                Input id="like" value={field.state.value}
                  oninput={(e) => field.handleChange(e.target.value)}
                  onblur={field.handleBlur}
                  placeholder="What did you like?"
              {/snippet}

          -- Review field (optional, multi-line textarea) --
          div.space-y-2
            form.Field name="review"
              {#snippet children(field)}
                Label for="review" "Review"
                Textarea id="review" value={field.state.value}
                  oninput={(e) => field.handleChange(e.target.value)}
                  onblur={field.handleBlur}
                  placeholder="Write your detailed review..."
                  rows={4}
              {/snippet}

          -- Footer --
          Dialog.Footer
            Button type="button" variant="outline" onclick={() => open = false}
              disabled={mutation.isPending} "Cancel"
            Button type="submit" disabled={mutation.isPending}
              {mutation.isPending ? 'Creating...' : 'Create Perspective'}
    ```

    **Imports:**
    - `createForm` from `@tanstack/svelte-form`
    - `createMutation` from `@tanstack/svelte-query`
    - `toast` from `svelte-sonner`
    - `graphqlClient` from `$lib/queries/client`
    - `CREATE_PERSPECTIVE` from `$lib/queries/perspectives`
    - `getSelectedUserId` from `$lib/stores/userSelection.svelte`
    - `Dialog, Button, Input, Label, Textarea` from `$lib/components/shadcn`
    - `RatingInput` from `$lib/components/RatingInput.svelte`
    - `VideoSelector` from `$lib/components/VideoSelector.svelte`

    **Important notes:**
    - Use `mutation.isPending` (not `$mutation.isPending`) -- TanStack Query v5 with Svelte 5 returns a reactive object, not a store. Access properties directly.
    - Use `form.Field` component with `{#snippet children(field)}` pattern per TanStack Form Svelte 5 adapter docs.
    - Dialog content needs `max-h-[90vh] overflow-y-auto` because the form is tall (video selector + claim + 4 ratings + like + review + buttons).
  </action>
  <verify>
    ```bash
    cd fe
    pnpm run check
    ```
    Type-check passes with no errors on the new component.
  </verify>
  <done>
    AddPerspectiveDialog.svelte exists with: TanStack Form managing all fields, VideoSelector for content selection, 4 RatingInput components in 2x2 grid, Like input and Review textarea, pre-submission validation showing up to 3 error toasts, mutation with user-friendly error mapping, form reset on dialog open, disabled states during mutation pending.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Header to AddPerspectiveDialog and update all tests</name>
  <files>
    fe/src/lib/components/Header.svelte
    fe/tests/components/AddPerspectiveDialog.test.ts
    fe/tests/components/Header.test.ts
  </files>
  <action>
    **1. Update Header.svelte:**
    The Header currently has an "Add Video" button (which Phase 3 will have wired to AddVideoDialog). Add a second button for "Add Perspective" and wire it to AddPerspectiveDialog.

    - Add `import AddPerspectiveDialog from './AddPerspectiveDialog.svelte'`
    - Add `let perspectiveDialogOpen = $state(false)` for dialog state
    - Add a new Button after the existing "Add Video" button:
      ```svelte
      <Button variant="outline" onclick={() => perspectiveDialogOpen = true}>Add Perspective</Button>
      ```
      Use `variant="outline"` to visually differentiate from the primary "Add Video" button.
    - Add `<AddPerspectiveDialog bind:open={perspectiveDialogOpen} />` after the existing AddVideoDialog component.

    The header actions area should now have: UserSelector, Add Video button, Add Perspective button.

    NOTE: If Phase 3 has NOT yet been executed when this plan runs (i.e., Header still has the placeholder `toast.info` for Add Video), then:
    - Keep the existing Add Video button behavior as-is (do not break it)
    - Just add the Add Perspective button and dialog alongside it
    - The Header should have both buttons regardless of Phase 3 completion status

    **2. Create `tests/components/AddPerspectiveDialog.test.ts`:**
    Mock all dependencies that AddPerspectiveDialog imports:
    ```typescript
    vi.mock('@tanstack/svelte-form', () => ({
      createForm: vi.fn(() => ({
        Field: vi.fn(),
        handleSubmit: vi.fn(),
        reset: vi.fn(),
      }))
    }));
    vi.mock('@tanstack/svelte-query', () => ({
      createMutation: vi.fn(() => ({
        mutate: vi.fn(),
        mutateAsync: vi.fn(),
        isPending: false,
      })),
      createQuery: vi.fn(() => ({
        isLoading: false,
        error: null,
        data: { content: { items: [] } }
      }))
    }));
    vi.mock('svelte-sonner', () => ({
      toast: { success: vi.fn(), error: vi.fn() }
    }));
    vi.mock('$lib/queries/client', () => ({
      graphqlClient: { request: vi.fn() }
    }));
    vi.mock('$lib/queries/perspectives', () => ({
      CREATE_PERSPECTIVE: 'mock-mutation'
    }));
    vi.mock('$lib/stores/userSelection.svelte', () => ({
      getSelectedUserId: vi.fn(() => 1)
    }));
    vi.mock('$lib/components/shadcn', () => ({
      Dialog: { Root: vi.fn(), Content: vi.fn(), Header: vi.fn(), Title: vi.fn(), Footer: vi.fn() },
      Button: vi.fn(),
      Input: vi.fn(),
      Label: vi.fn(),
      Textarea: vi.fn(),
      Progress: vi.fn(),
    }));
    ```

    Test cases:
    a. "renders dialog with title 'Add Perspective' when open" -- render with `open: true`, check for "Add Perspective" text
    b. "renders Create Perspective submit button when open" -- check for "Create Perspective" button text
    c. "renders Cancel button when open" -- check for "Cancel" text
    d. "renders rating labels (Quality, Agreement, Importance, Confidence)" -- check for all 4 label texts
    e. "renders Like and Review labels" -- check for "Like" and "Review" text

    Note: The mocking complexity for TanStack Form's `form.Field` snippet pattern may require a simpler testing approach. If `form.Field` is hard to mock (it's a Svelte component rendered inside `createForm`), focus on testing that the dialog renders its structural elements (title, buttons, labels). The full form interaction is verified via the checkpoint task. Adapt the mocking strategy based on what the test runner supports -- follow patterns from existing component tests in the project.

    **3. Update `tests/components/Header.test.ts`:**
    The Header now imports AddPerspectiveDialog, which depends on TanStack Query, TanStack Form, and other modules. Add mocks for the new dependencies:
    ```typescript
    vi.mock('@tanstack/svelte-form', () => ({
      createForm: vi.fn(() => ({
        Field: vi.fn(),
        handleSubmit: vi.fn(),
        reset: vi.fn(),
      }))
    }));
    ```
    Also mock `$lib/queries/perspectives` and `$lib/stores/userSelection.svelte` (if not already mocked from Phase 3).

    Add test:
    - "renders Add Perspective button" -- check for button with text "Add Perspective"
    - "renders AddPerspectiveDialog component" -- verify the dialog component is present in the DOM

    Keep all existing tests passing (structural tests for header, Add Video button, UserSelector, etc.).
  </action>
  <verify>
    ```bash
    cd fe
    pnpm run test:run
    pnpm run check
    ```
    All tests pass (existing + updated Header tests + new AddPerspectiveDialog tests). Type-check clean.
  </verify>
  <done>
    Header has "Add Perspective" button that opens AddPerspectiveDialog. Both AddPerspectiveDialog and updated Header component tests pass. All existing tests still pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Add Perspective flow: clicking "Add Perspective" in header opens a dialog with TanStack Form containing video selector dropdown, claim text input, four rating inputs (Quality, Agreement, Importance, Confidence) each with number input (0-10000) and progress bar visualization, Like text input, Review textarea, and submit/cancel buttons. Form validates required fields showing toast errors. Successful submission calls createPerspective mutation with selected user ID and shows success toast.</what-built>
  <how-to-verify>
    Prerequisites: Backend must be running (`cd backend && make run`). At least one video must exist in the database. At least one user must exist.

    1. Start frontend: `cd fe && pnpm run dev`
    2. Open http://localhost:5173 in browser
    3. Select a user from the user dropdown in the header
    4. Click "Add Perspective" button in header
    5. Verify: Dialog opens with "Add Perspective" title, all form fields visible (scroll if needed)
    6. Try submitting with empty form -- should show toast errors: "Claim is required", "Quality rating is required", etc. (up to 3 toasts)
    7. Fill in Claim: "This is a great video"
    8. Set Quality: type "8500" in the number input -- progress bar should fill to ~85%
    9. Set Agreement: type "7000" -- progress bar should fill to ~70%
    10. Set Importance: type "6000" -- progress bar should fill to ~60%
    11. Set Confidence: type "9000" -- progress bar should fill to ~90%
    12. Type in Like: "Great content"
    13. Type in Review: "This video provides excellent coverage of the topic with clear explanations."
    14. Optionally select a video from the dropdown
    15. Click "Create Perspective"
    16. Verify: Button shows "Creating...", then success toast appears (top-right, auto-dismiss)
    17. Verify: Dialog closes automatically after success
    18. Test edge case: type "abc" in a rating input -- should show 0, not NaN
    19. Test edge case: type "99999" in a rating input -- should clamp to 10000
    20. Test edge case: deselect user (select "Select user..." placeholder), try to submit -- should show "Please select a user" toast
    21. Reopen dialog -- form should be reset (no stale data)
    22. Click Cancel -- dialog should close without submitting
    23. Check mobile (375px width) -- dialog and form should be responsive
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `pnpm run test:run` -- all tests pass (existing + new AddPerspectiveDialog + updated Header)
2. `pnpm run check` -- no TypeScript errors
3. `pnpm run test:coverage` -- coverage thresholds still met (80% lines/functions/statements, 75% branches)
4. Header has both "Add Video" and "Add Perspective" buttons
5. "Add Perspective" button opens dialog with TanStack Form
6. Form contains: video selector, claim input, 4 rating inputs with progress bars, like input, review textarea
7. Empty form submission shows validation error toasts (up to 3)
8. Valid submission creates perspective via mutation and shows success toast
9. User ID from store is included in mutation input (USER-03)
10. Rating inputs clamp values to 0-10000 and handle NaN
11. Form resets when dialog reopens
12. Dialog is responsive on mobile (375px)
</verification>

<success_criteria>
- User can select a video to add a perspective on (PERSP-01)
- User can set Quality, Agreement, Importance, and Confidence ratings via number inputs with progress bar visualization (PERSP-02, PERSP-03, PERSP-04, PERSP-05)
- User can enter Like text and Review text freeform (PERSP-06, PERSP-07)
- User sees validation error toasts before submission if form is invalid (PERSP-08)
- User sees success toast after perspective is created, attributed to selected user (PERSP-09, USER-03)
- All tests pass including new component tests (TEST-05)
- Coverage thresholds maintained
</success_criteria>

<output>
After completion, create `.planning/phases/04-add-perspective-flow/04-02-SUMMARY.md`
</output>
