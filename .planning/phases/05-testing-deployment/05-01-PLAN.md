---
phase: 05-testing-deployment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - perspectize-fe/tests/components/UserSelector.test.ts
  - perspectize-fe/tests/components/ActivityTable.test.ts
  - perspectize-fe/tests/unit/stores-userSelection.test.ts
autonomous: true

must_haves:
  truths:
    - "Running pnpm run test:coverage exits 0 (all thresholds pass)"
    - "Line coverage is >= 80%"
    - "Function coverage is >= 80%"
    - "Branch coverage is >= 75%"
  artifacts:
    - path: "perspectize-fe/tests/components/UserSelector.test.ts"
      provides: "UserSelector component tests covering render, selection, query states"
      min_lines: 40
    - path: "perspective-fe/tests/components/ActivityTable.test.ts"
      provides: "ActivityTable tests covering grid rendering, search, pagination handlers"
      min_lines: 60
    - path: "perspectize-fe/tests/unit/stores-userSelection.test.ts"
      provides: "userSelection store tests covering setUser, clearUser, session sync"
      min_lines: 30
  key_links:
    - from: "perspectize-fe/tests/components/UserSelector.test.ts"
      to: "perspectize-fe/src/lib/components/UserSelector.svelte"
      via: "imports and renders component"
      pattern: "import.*UserSelector"
    - from: "perspectize-fe/tests/components/ActivityTable.test.ts"
      to: "perspectize-fe/src/lib/components/ActivityTable.svelte"
      via: "imports and renders component"
      pattern: "import.*ActivityTable"
---

<objective>
Fill test coverage gaps to reach the 80% line coverage threshold.

Purpose: The project has enforced coverage thresholds (80% lines/functions/statements, 75% branches) in vite.config.ts but current coverage is at 36-40%. The primary gaps are UserSelector (0%), ActivityTable (32.5%), and userSelection store (40%). Filling these gaps ensures the CI pipeline (Plan 02) can enforce coverage on every push.

Output: Updated test files that bring overall coverage above thresholds. `pnpm run test:coverage` passes cleanly.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-deployment/05-RESEARCH.md
@perspectize-fe/vite.config.ts
@perspectize-fe/tests/components/UserSelector.test.ts
@perspectize-fe/tests/components/ActivityTable.test.ts
@perspectize-fe/tests/unit/stores-userSelection.test.ts
@perspectize-fe/tests/helpers/render.ts
@perspectize-fe/tests/helpers/TestWrapper.svelte
@perspectize-fe/tests/setup.ts
@perspectize-fe/src/lib/components/UserSelector.svelte
@perspectize-fe/src/lib/components/ActivityTable.svelte
@perspective-fe/src/lib/stores/userSelection.svelte.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Identify exact coverage gaps</name>
  <files>perspectize-fe/coverage/ (generated output, not committed)</files>
  <action>
Run `cd perspectize-fe && pnpm run test:coverage` to get the current coverage report. This will likely fail due to thresholds not met — that is expected. Examine the text output to identify exact uncovered line ranges for each source file. Focus on:

1. `src/lib/components/UserSelector.svelte` — expected ~0% coverage, need to test: render with loading state, render with users list, user selection change handler, default user selection from store
2. `src/lib/components/ActivityTable.svelte` — expected ~32.5% coverage, need to test: grid initialization, quick filter search handler, pagination size change handler, column definitions, loading/error states
3. `src/lib/stores/userSelection.svelte.ts` — expected ~40% coverage, need to test: setSelectedUserId, clearUserSelection, session storage sync, loadFromSession with various inputs

Record exact uncovered lines for use in Task 2. Do NOT write any tests in this task.
  </action>
  <verify>`pnpm run test:coverage` produces output showing per-file coverage percentages. Note all files below 80% lines.</verify>
  <done>Coverage report generated. Exact gaps documented for UserSelector, ActivityTable, and userSelection store with uncovered line ranges identified.</done>
</task>

<task type="auto">
  <name>Task 2: Write tests for all coverage gaps</name>
  <files>
perspectize-fe/tests/components/UserSelector.test.ts
perspectize-fe/tests/components/ActivityTable.test.ts
perspective-fe/tests/unit/stores-userSelection.test.ts
  </files>
  <action>
Using the gap analysis from Task 1, expand existing test files to cover uncovered lines. Follow the testing patterns already established in the codebase (see tests/helpers/render.ts for component rendering, tests/setup.ts for jsdom setup).

**UserSelector.test.ts** — Add tests covering:
- Component renders loading state when query is pending
- Component renders user options from query data
- Component renders error/empty state when query fails
- Selection change calls setSelectedUserId from store
- Default selection loads from store's current value
- Mock TanStack Query responses using the existing TestWrapper.svelte pattern

**ActivityTable.test.ts** — Add tests covering:
- Grid renders with provided row data (column headers visible)
- Quick filter input updates grid filter (test the onFilterTextBoxChanged or equivalent handler)
- Page size selector renders with options 10/25/50
- Loading state shows loading overlay
- Empty state shows "no rows" message
- Column definitions match expected fields (Title, Type, Duration, Date Added, Last Updated)

**stores-userSelection.test.ts** — Add tests covering:
- setSelectedUserId stores value and syncs to sessionStorage
- clearUserSelection sets value to null and removes from sessionStorage
- selectedUserId.value getter returns current value
- selectedUserId.value setter syncs to sessionStorage
- loadFromSession handles missing key (returns null)
- loadFromSession handles non-numeric stored value (returns null)
- loadFromSession handles valid stored value (returns number)

Important patterns to follow:
- Use `@testing-library/svelte` render function
- Mock `$app/environment` browser flag as needed (already in setup.ts)
- Mock `graphql-request` client for query tests
- Use `vi.spyOn(sessionStorage, 'getItem')` and `vi.spyOn(sessionStorage, 'setItem')` for store tests
- Keep test descriptions clear and behavior-focused

After writing tests, run `cd perspectize-fe && pnpm run test:coverage`. If any threshold is still not met, identify remaining gaps and add more tests. Iterate until ALL thresholds pass:
- Lines: >= 80%
- Functions: >= 80%
- Branches: >= 75%
- Statements: >= 80%
  </action>
  <verify>Run `cd perspectize-fe && pnpm run test:coverage`. Command must exit 0 with all thresholds met. All tests must pass (no failures).</verify>
  <done>All coverage thresholds pass: lines >= 80%, functions >= 80%, branches >= 75%, statements >= 80%. Zero test failures. `pnpm run test:coverage` exits 0.</done>
</task>

</tasks>

<verification>
1. `cd perspectize-fe && pnpm run test:coverage` exits 0 (all thresholds pass)
2. `cd perspectize-fe && pnpm run test:run` shows zero test failures
3. Coverage text output shows lines >= 80%, functions >= 80%, branches >= 75%, statements >= 80%
</verification>

<success_criteria>
- All Vitest coverage thresholds pass on `pnpm run test:coverage` (exit code 0)
- No test failures across all test files
- UserSelector, ActivityTable, and userSelection store each have meaningful test coverage (not just trivial assertions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-deployment/05-01-SUMMARY.md`
</output>
