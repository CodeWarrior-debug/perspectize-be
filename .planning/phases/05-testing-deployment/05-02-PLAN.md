---
phase: 05-testing-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - fe/svelte.config.js
  - fe/static/.nojekyll (DELETE)
  - .github/workflows/frontend-deploy.yml (DELETE)
autonomous: false

must_haves:
  truths:
    - "Frontend is deployed and accessible at a public DigitalOcean App Platform URL (https://fe-xxxxx.ondigitalocean.app)"
    - "Pushing to main auto-deploys the frontend via DigitalOcean App Platform (not GitHub Actions)"
    - "Pull requests with frontend changes trigger the GitHub Actions test workflow with coverage enforcement"
    - "SvelteKit base path is empty (root hosting, no /perspectize subpath)"
    - "Production build embeds the correct backend GraphQL URL via VITE_GRAPHQL_URL"
  artifacts:
    - path: "fe/svelte.config.js"
      provides: "SvelteKit config with base path set to empty string for root-path hosting"
      contains: "base: ''"
    - path: ".github/workflows/frontend-test.yml"
      provides: "GitHub Actions workflow for running frontend tests with coverage on PRs (kept from prior plan)"
      min_lines: 25
      contains: "test:coverage"
  key_links:
    - from: "fe/src/lib/queries/client.ts"
      to: "VITE_GRAPHQL_URL env var"
      via: "import.meta.env.VITE_GRAPHQL_URL embedded at build time"
      pattern: "VITE_GRAPHQL_URL"
    - from: "DigitalOcean App Platform"
      to: "fe/build/"
      via: "Static site serving from build output directory"
      pattern: "build"
---

<objective>
Clean up GitHub Pages artifacts and deploy the SvelteKit frontend to DigitalOcean App Platform as a static site.

Purpose: The frontend needs to be publicly accessible. The backend is already on DigitalOcean App Platform (backend-dz3qa.ondigitalocean.app), so deploying the frontend on the same platform keeps infrastructure unified. The previous GitHub Pages setup left artifacts (base path, .nojekyll, deploy workflow) that must be removed first.

Output: Frontend deployed at a public `*.ondigitalocean.app` URL, GitHub Pages artifacts removed, test CI workflow preserved. The assigned frontend URL will be captured for use in Plan 05-03 (CORS configuration).
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-deployment/05-RESEARCH-sevalla.md
@fe/svelte.config.js
@fe/package.json
@fe/src/lib/queries/client.ts
@.github/workflows/frontend-deploy.yml
@.github/workflows/frontend-test.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove GitHub Pages artifacts and fix SvelteKit config for root-path hosting</name>
  <files>
fe/svelte.config.js
fe/static/.nojekyll (DELETE)
.github/workflows/frontend-deploy.yml (DELETE)
  </files>
  <action>
**1. Update `fe/svelte.config.js`:**

Remove the GitHub Pages base path. The current config has:
```javascript
const dev = process.env.NODE_ENV !== 'production';
// ...
paths: {
    base: dev ? '' : '/perspectize'
}
```

Change to unconditionally empty base path (DigitalOcean App Platform serves from root):
```javascript
import adapter from '@sveltejs/adapter-static';

/** @type {import('@sveltejs/kit').Config} */
const config = {
    kit: {
        adapter: adapter({
            pages: 'build',
            assets: 'build',
            fallback: '404.html',
            strict: true
        }),
        paths: {
            base: ''
        }
    }
};

export default config;
```

Key changes:
- Removed `const dev = process.env.NODE_ENV !== 'production';` (no longer needed)
- Changed `base: dev ? '' : '/perspectize'` to `base: ''`
- DigitalOcean App Platform serves from root domain, not a subpath

**2. Delete `fe/static/.nojekyll`:**

This is a GitHub Pages artifact to bypass Jekyll processing. Not needed on DigitalOcean App Platform.

```bash
rm fe/static/.nojekyll
```

**3. Delete `.github/workflows/frontend-deploy.yml`:**

This is the GitHub Pages deployment workflow. DigitalOcean App Platform handles deployment via its own GitHub integration (auto-deploy on push to main).

```bash
rm .github/workflows/frontend-deploy.yml
```

**4. Keep `.github/workflows/frontend-test.yml` as-is:**

The test workflow is platform-independent (runs tests on PRs). Do NOT modify or delete it.

**5. Verify the production build still works:**

```bash
cd fe && pnpm run build
```

This ensures adapter-static builds correctly without the base path. Then run tests to confirm no regression:

```bash
cd fe && pnpm run test:coverage
```
  </action>
  <verify>
1. `grep "base: ''" fe/svelte.config.js` finds the empty base path
2. `grep -c "perspectize" fe/svelte.config.js` returns 0 (no more GitHub Pages base path)
3. `test ! -f perspective-fe/static/.nojekyll && echo "deleted"` outputs "deleted"
4. `test ! -f .github/workflows/frontend-deploy.yml && echo "deleted"` outputs "deleted"
5. `test -f .github/workflows/frontend-test.yml && echo "kept"` outputs "kept"
6. `cd fe && pnpm run build` succeeds
7. `cd fe && pnpm run test:coverage` exits 0, coverage not regressed
  </verify>
  <done>GitHub Pages artifacts removed. SvelteKit configured for root-path hosting. Production build succeeds. Test workflow preserved.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Deploy the frontend as a static site on DigitalOcean App Platform</action>
  <instructions>
**Before you start:** The code changes from Task 1 must be committed and pushed to `main` before DigitalOcean App Platform can build from it. If still on a feature branch, merge to main first.

**Deploy the frontend on DigitalOcean App Platform:**

1. Go to https://cloud.digitalocean.com/apps — click "Create App"

2. **Source configuration:**
   - Source: GitHub
   - Repository: `CodeWarrior-debug/perspectize`
   - Branch: `main`
   - Source Directory: `fe/`
   - Auto-deploy: Enabled

3. **Component type:** Static Site

4. **Build configuration:**
   - Build Command: `pnpm run build`
   - Output Directory: `build`

5. **Environment variables** (CRITICAL - set scope to BUILD_TIME):
   - Key: `VITE_GRAPHQL_URL`
   - Value: `https://backend-dz3qa.ondigitalocean.app/graphql`
   - Scope: **BUILD_TIME** (NOT RUN_TIME - static sites have no runtime)

6. **App name:** `fe` (or similar)

7. Click "Create Resources" / "Deploy"

8. Wait for build to complete (2-5 minutes). The build log should show:
   - pnpm install completing
   - `vite build` running
   - Static files uploaded

9. **Copy the assigned URL** from the deployment output. It will be something like:
   `https://fe-xxxxx.ondigitalocean.app`

**After deployment:**

10. Visit the assigned URL in your browser. The Perspectize frontend should load.

11. Open DevTools Network tab. You should see a GraphQL request to `backend-dz3qa.ondigitalocean.app/graphql`. It will likely fail with a CORS error — this is expected and will be fixed in Plan 05-03.

12. **Report back with:**
    - The assigned frontend URL (e.g., `https://fe-xxxxx.ondigitalocean.app`)
    - Whether the site loaded (HTML/CSS renders)
    - Whether GraphQL requests show CORS errors (expected at this stage)
  </instructions>
  <resume-signal>Provide the assigned DigitalOcean frontend URL and confirm the site loads. Example: "deployed at https://fe-xxxxx.ondigitalocean.app, site loads, GraphQL CORS error as expected"</resume-signal>
</task>

</tasks>

<verification>
1. `fe/svelte.config.js` has `base: ''` (no subpath)
2. `fe/static/.nojekyll` does NOT exist
3. `.github/workflows/frontend-deploy.yml` does NOT exist
4. `.github/workflows/frontend-test.yml` exists and is valid YAML
5. `cd fe && pnpm run build` succeeds
6. `cd fe && pnpm run test:coverage` exits 0
7. Frontend is accessible at the assigned DigitalOcean App Platform URL (confirmed by user)
</verification>

<success_criteria>
- GitHub Pages artifacts (base path, .nojekyll, deploy workflow) are removed
- SvelteKit builds with empty base path for root-path hosting
- Frontend is deployed on DigitalOcean App Platform as a static site
- VITE_GRAPHQL_URL is set as BUILD_TIME env var pointing to the production backend
- The assigned frontend URL is known (captured from deployment output for use in 05-03)
- GitHub Actions test workflow still runs on PRs
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-deployment/05-02-SUMMARY.md`

IMPORTANT: The summary MUST include the assigned DigitalOcean frontend URL in the "Key Results" section. Plan 05-03 depends on this URL for CORS configuration.
</output>
