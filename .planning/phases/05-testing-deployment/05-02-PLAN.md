---
phase: 05-testing-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/frontend-deploy.yml
  - .github/workflows/frontend-test.yml
  - perspectize-fe/svelte.config.js
  - perspective-fe/static/.nojekyll
autonomous: false

must_haves:
  truths:
    - "Frontend is accessible at https://codewarrior-debug.github.io/perspectize-be/"
    - "Pushing to main triggers the deploy workflow for frontend changes"
    - "Pull requests with frontend changes trigger the test workflow with coverage enforcement"
    - "GitHub Pages is enabled for the repository"
  artifacts:
    - path: ".github/workflows/frontend-deploy.yml"
      provides: "GitHub Actions workflow for building and deploying frontend to GitHub Pages"
      min_lines: 40
      contains: "deploy-pages"
    - path: ".github/workflows/frontend-test.yml"
      provides: "GitHub Actions workflow for running frontend tests with coverage on PRs"
      min_lines: 25
      contains: "test:coverage"
    - path: "perspectize-fe/svelte.config.js"
      provides: "SvelteKit config with base path for GitHub Pages subpath deployment"
      contains: "perspectize-be"
    - path: "perspectize-fe/static/.nojekyll"
      provides: "Empty file to bypass Jekyll processing on GitHub Pages"
  key_links:
    - from: ".github/workflows/frontend-deploy.yml"
      to: "perspectize-fe/build/"
      via: "upload-pages-artifact action"
      pattern: "perspectize-fe/build"
    - from: ".github/workflows/frontend-deploy.yml"
      to: "perspectize-fe/pnpm-lock.yaml"
      via: "pnpm install --frozen-lockfile"
      pattern: "frozen-lockfile"
    - from: "perspectize-fe/svelte.config.js"
      to: "GitHub Pages URL path"
      via: "kit.paths.base configuration"
      pattern: "paths.*base.*perspectize-be"
---

<objective>
Set up CI/CD pipeline and deploy the SvelteKit frontend to GitHub Pages.

Purpose: The frontend needs to be publicly accessible and automatically deployed. GitHub Pages is free with unlimited bandwidth and has native GitHub integration. The CI pipeline ensures test coverage is enforced on every PR.

Output: Two GitHub Actions workflows (deploy on push to main, test on PRs), SvelteKit configured for GitHub Pages base path, and the frontend deployed at https://codewarrior-debug.github.io/perspectize-be/
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-deployment/05-RESEARCH.md
@perspectize-fe/svelte.config.js
@perspectize-fe/package.json
@perspectize-fe/src/lib/queries/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure SvelteKit for GitHub Pages and create CI/CD workflows</name>
  <files>
perspectize-fe/svelte.config.js
perspectize-fe/static/.nojekyll
.github/workflows/frontend-deploy.yml
.github/workflows/frontend-test.yml
  </files>
  <action>
**1. Update `perspectize-fe/svelte.config.js`:**

Add `paths.base` for GitHub Pages subpath deployment. Use process.env.NODE_ENV to only apply base path in production (so dev server still works at root):

```javascript
import adapter from '@sveltejs/adapter-static';

const dev = process.env.NODE_ENV !== 'production';

/** @type {import('@sveltejs/kit').Config} */
const config = {
  kit: {
    adapter: adapter({
      pages: 'build',
      assets: 'build',
      fallback: '404.html',
      strict: true
    }),
    paths: {
      base: dev ? '' : '/perspectize-be'
    }
  }
};

export default config;
```

Key changes from current config:
- Added `fallback: '404.html'` for SPA routing on GitHub Pages
- Added `paths.base` conditional on NODE_ENV
- Base path `/perspectize-be` matches the GitHub repository name

**2. Create `perspectize-fe/static/.nojekyll`:**

Create an empty file. This prevents GitHub Pages from processing the site with Jekyll, which would ignore files starting with underscore (like `_app/` from SvelteKit).

**3. Create `.github/workflows/frontend-deploy.yml`:**

Deploy workflow that builds and deploys to GitHub Pages on push to main. Key requirements:
- Use `dorny/paths-filter@v3` to only deploy when `perspective-fe/**` changes
- Use `pnpm/action-setup@v2` with version 9 (matching the lockfile version 9.0)
- Use `actions/setup-node@v4` with node 20 and pnpm cache
- Set `VITE_GRAPHQL_URL` env var to the Sevalla backend URL during build: `https://perspectize-go-dz3qa.ondigitalocean.app/graphql` (this is the production backend endpoint)
- Use `actions/configure-pages@v3`, `actions/upload-pages-artifact@v3`, `actions/deploy-pages@v4`
- Set permissions: `contents: read`, `pages: write`, `id-token: write`
- Add concurrency group `"pages"` with `cancel-in-progress: false`
- Add `workflow_dispatch` trigger for manual deploys
- Separate detect-changes, build, and deploy into distinct jobs

Follow the exact pattern from 05-RESEARCH.md "Complete Frontend Deployment Workflow" section. Add the VITE_GRAPHQL_URL env var in the build step:
```yaml
- name: Build
  env:
    VITE_GRAPHQL_URL: https://perspectize-go-dz3qa.ondigitalocean.app/graphql
  run: cd perspectize-fe && pnpm run build
```

**4. Create `.github/workflows/frontend-test.yml`:**

Test workflow that runs on PRs and pushes to main when frontend files change. Key requirements:
- Trigger on `pull_request` with `paths: ['perspectize-fe/**']` and `push` to main with same paths
- Same pnpm/node setup as deploy workflow
- Run `pnpm run test:coverage` — this will fail the workflow if coverage thresholds aren't met
- Upload coverage reports as artifacts using `actions/upload-artifact@v4` with `if: always()`
  </action>
  <verify>
1. `cat perspectize-fe/svelte.config.js` shows paths.base config
2. `test -f perspectize-fe/static/.nojekyll && echo "exists"` outputs "exists"
3. `cat .github/workflows/frontend-deploy.yml` shows valid YAML with deploy-pages action
4. `cat .github/workflows/frontend-test.yml` shows valid YAML with test:coverage step
5. `cd perspectize-fe && NODE_ENV=production pnpm run build` succeeds (validates base path config)
  </verify>
  <done>SvelteKit configured for GitHub Pages. Two workflow files created. Production build succeeds with base path.</done>
</task>

<task type="auto">
  <name>Task 2: Enable GitHub Pages and trigger initial deployment</name>
  <files>None (GitHub API operations only)</files>
  <action>
**1. Enable GitHub Pages for the repository:**

Use the GitHub CLI to enable Pages with GitHub Actions as source:
```bash
gh api repos/CodeWarrior-debug/perspectize-be/pages -X POST -f build_type=workflow -f source='{"branch":"main","path":"/"}' 2>/dev/null || \
gh api repos/CodeWarrior-debug/perspectize-be/pages -X PUT -f build_type=workflow -f source='{"branch":"main","path":"/"}'
```

If Pages is already enabled, the POST will fail and the PUT will update the config.

**2. Push changes and verify deployment:**

The workflow files and svelte.config.js changes need to be on main for the deploy workflow to trigger. After the commit (handled by execute-plan workflow), the push to main should trigger the deploy workflow.

Verify the workflow was triggered:
```bash
gh run list --workflow=frontend-deploy.yml --limit=1
```

If the workflow hasn't triggered yet (because changes aren't pushed), note this for the checkpoint.

**3. Verify GitHub Actions environment:**

Check that the github-pages environment exists:
```bash
gh api repos/CodeWarrior-debug/perspectize-be/environments
```
  </action>
  <verify>
1. `gh api repos/CodeWarrior-debug/perspectize-be/pages` returns Pages config (not 404)
2. GitHub Pages source is set to "workflow" (not "branch")
  </verify>
  <done>GitHub Pages is enabled with workflow source. Repository is configured for automatic deployments.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>CI/CD pipeline with GitHub Actions and GitHub Pages deployment. The frontend should be deploying or deployed at https://codewarrior-debug.github.io/perspectize-be/</what-built>
  <how-to-verify>
1. Check GitHub Actions: Go to https://github.com/CodeWarrior-debug/perspectize-be/actions — verify the "Deploy Frontend" workflow ran or is running
2. If deployed, visit https://codewarrior-debug.github.io/perspectize-be/ — the Perspectize frontend should load
3. Check the test workflow: Create a test PR or check that the "Frontend Tests" workflow appears in the Actions tab
4. If the deploy hasn't triggered yet: Run `gh workflow run frontend-deploy.yml` to manually trigger, or push a small change to main

Note: First deployment may take 2-5 minutes. If the site shows 404, GitHub Pages may still be provisioning.
  </how-to-verify>
  <resume-signal>Type "deployed" if the site is live, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `gh api repos/CodeWarrior-debug/perspectize-be/pages` returns valid Pages configuration
2. `curl -s -o /dev/null -w "%{http_code}" https://codewarrior-debug.github.io/perspectize-be/` returns 200
3. `gh run list --workflow=frontend-deploy.yml --limit=1` shows a completed run
4. `.github/workflows/frontend-test.yml` exists and is valid YAML
5. `cd perspectize-fe && NODE_ENV=production pnpm run build` succeeds
</verification>

<success_criteria>
- Frontend is deployed and accessible at https://codewarrior-debug.github.io/perspectize-be/
- Deploy workflow triggers on push to main when perspectize-fe/ files change
- Test workflow triggers on PRs when perspectize-fe/ files change
- SvelteKit base path correctly handles subpath routing
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-deployment/05-02-SUMMARY.md`
</output>
