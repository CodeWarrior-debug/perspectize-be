---
phase: 05-testing-deployment
plan: 03
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - backend/cmd/server/main.go
  - backend/go.mod
  - backend/go.sum
autonomous: false

must_haves:
  truths:
    - "Backend CORS allows requests from the Sevalla frontend origin"
    - "Backend CORS rejects requests from unauthorized origins in production"
    - "Frontend deployed on Sevalla can successfully query the backend GraphQL API"
    - "Local development still works (localhost origins allowed by default)"
  artifacts:
    - path: "backend/cmd/server/main.go"
      provides: "Production CORS configuration using rs/cors with environment-based origin allowlist"
      contains: "AllowedOrigins"
    - path: "backend/go.mod"
      provides: "Go module with rs/cors dependency"
      contains: "rs/cors"
  key_links:
    - from: "backend/cmd/server/main.go"
      to: "ALLOWED_ORIGINS env var"
      via: "os.Getenv for origin allowlist"
      pattern: "ALLOWED_ORIGINS"
    - from: "backend/cmd/server/main.go"
      to: "/graphql endpoint"
      via: "cors.Handler wrapping GraphQL server"
      pattern: "corsMiddleware\\.Handler"
---

<objective>
Replace wildcard CORS on the Go backend with rs/cors and environment-based origin allowlist, then configure it to allow the deployed Sevalla frontend.

Purpose: The backend currently uses wildcard CORS (`Access-Control-Allow-Origin: *`) which is a security risk in production. The frontend deployed on Sevalla (URL obtained from Plan 05-02) needs to make GraphQL requests to the backend. This plan replaces the hand-rolled CORS middleware with the `rs/cors` library and restricts origins to the production frontend URL.

Output: Backend CORS configured with environment-based origin allowlist. The deployed frontend can successfully query the production GraphQL API. Local development continues to work with localhost defaults.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-deployment/05-RESEARCH-sevalla.md
@.planning/phases/05-testing-deployment/05-02-SUMMARY.md
@backend/cmd/server/main.go
@backend/go.mod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace wildcard CORS with rs/cors and environment-based allowlist</name>
  <files>
backend/cmd/server/main.go
backend/go.mod
backend/go.sum
  </files>
  <action>
**IMPORTANT:** Read the 05-02-SUMMARY.md first to get the frontend URL assigned by Sevalla. You will need this URL in the checkpoint instructions.

**1. Add rs/cors dependency:**

```bash
cd backend && go get github.com/rs/cors
```

**2. Update `backend/cmd/server/main.go`:**

Add `"strings"` and `"github.com/rs/cors"` to the import block.

Replace the hand-rolled `corsHandler` closure (lines 90-102 in current file):

```go
// CORS middleware for frontend dev server
corsHandler := func(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        w.Header().Set("Access-Control-Allow-Origin", "*")
        w.Header().Set("Access-Control-Allow-Methods", "POST, GET, OPTIONS")
        w.Header().Set("Access-Control-Allow-Headers", "Content-Type")
        if r.Method == http.MethodOptions {
            w.WriteHeader(http.StatusOK)
            return
        }
        next.ServeHTTP(w, r)
    })
}
```

With rs/cors middleware:

```go
// Production-ready CORS
corsMiddleware := cors.New(cors.Options{
    AllowedOrigins:   getAllowedOrigins(),
    AllowedMethods:   []string{"GET", "POST", "OPTIONS"},
    AllowedHeaders:   []string{"Content-Type"},
    AllowCredentials: false,
    MaxAge:           3600, // Cache preflight for 1 hour
})
```

Update the route handler line (currently line 113):
- Change: `http.Handle("/graphql", corsHandler(srv))`
- To: `http.Handle("/graphql", corsMiddleware.Handler(srv))`

**3. Add `getAllowedOrigins` function** at package level (outside main function, e.g., before or after main):

```go
// getAllowedOrigins returns the list of allowed CORS origins.
// In production, set ALLOWED_ORIGINS env var (comma-separated).
// Defaults to localhost for development.
func getAllowedOrigins() []string {
    if origins := os.Getenv("ALLOWED_ORIGINS"); origins != "" {
        parts := strings.Split(origins, ",")
        result := make([]string, 0, len(parts))
        for _, origin := range parts {
            if trimmed := strings.TrimSpace(origin); trimmed != "" {
                result = append(result, trimmed)
            }
        }
        return result
    }

    // Default to localhost for development
    return []string{
        "http://localhost:5173", // Vite dev server
        "http://localhost:4173", // Vite preview server
    }
}
```

**4. Run `go mod tidy`** to clean up go.sum:

```bash
cd backend && go mod tidy
```

**5. Verify build and tests:**

```bash
cd backend && go build ./cmd/server/
cd backend && make test
```

Both must succeed. The build confirms the code compiles. The tests confirm no regressions.

**Do NOT** set the ALLOWED_ORIGINS env var on Sevalla at this point -- that will be done in the checkpoint with the user, who needs to access the Sevalla dashboard.
  </action>
  <verify>
1. `cd backend && go build ./cmd/server/` succeeds
2. `cd backend && make test` passes (all existing tests pass)
3. `grep "rs/cors" backend/go.mod` finds the dependency
4. `grep "getAllowedOrigins" backend/cmd/server/main.go` finds the function
5. `grep -c 'Access-Control-Allow-Origin' backend/cmd/server/main.go` returns 0 (no more hand-rolled CORS headers)
6. `grep "ALLOWED_ORIGINS" backend/cmd/server/main.go` finds the env var usage
7. `grep "corsMiddleware" backend/cmd/server/main.go` finds the middleware variable
  </verify>
  <done>rs/cors replaces hand-rolled CORS middleware. getAllowedOrigins function reads ALLOWED_ORIGINS env var with localhost defaults. Build and all tests pass.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <action>Set ALLOWED_ORIGINS on Sevalla backend and verify end-to-end</action>
  <instructions>
**Prerequisites:** The code changes from Task 1 must be committed and pushed so the backend redeploys on Sevalla with the new rs/cors middleware.

**Step 1: Get the frontend URL from Plan 05-02**

The frontend URL was captured during Plan 05-02 deployment. It should be in `.planning/phases/05-testing-deployment/05-02-SUMMARY.md`. It looks like:
`https://fe-xxxxx.sevalla.app`

**Step 2: Set ALLOWED_ORIGINS on the backend**

1. Go to the Sevalla dashboard (https://app.sevalla.com)
2. Find the backend app
3. Go to Settings > Environment Variables
4. Add environment variable:
   - Key: `ALLOWED_ORIGINS`
   - Value: `https://fe-xxxxx.sevalla.app` (use the ACTUAL URL from Step 1)
   - Scope: **RUN_TIME** (backend needs this at runtime, not build time)
5. Save and trigger a redeploy (or wait for auto-redeploy after push)

**IMPORTANT:** The ALLOWED_ORIGINS value is the ORIGIN only (scheme + host), NOT a full URL path. Do NOT include `/graphql` or trailing slashes.

**Step 3: Verify CORS works end-to-end**

After the backend redeploys with the new ALLOWED_ORIGINS:

1. Visit the frontend URL in Chrome (e.g., `https://fe-xxxxx.sevalla.app`)
2. Open DevTools > Network tab
3. The page should load and make GraphQL requests to `backend-dz3qa.sevalla.app/graphql`
4. Check that the GraphQL request returns 200 (not blocked by CORS)
5. Check response headers include `Access-Control-Allow-Origin` matching the frontend URL

**Step 4: Verify CORS rejects unauthorized origins**

Run this curl command in terminal:
```bash
curl -s -D - -o /dev/null \
  -H "Origin: https://evil-site.com" \
  -H "Content-Type: application/json" \
  -X OPTIONS \
  https://backend-dz3qa.sevalla.app/graphql
```

The response should NOT include `Access-Control-Allow-Origin: https://evil-site.com`.

**Step 5: Verify local dev still works (optional)**

If you have the backend running locally (`make run` or `make dev`), the frontend dev server at `http://localhost:5173` should still be able to query it, because localhost is in the default allowlist.

**Report back with:**
- Whether ALLOWED_ORIGINS was set successfully
- Whether the frontend can query the backend (GraphQL requests succeed)
- Whether unauthorized origins are rejected
  </instructions>
  <resume-signal>Type "verified" if CORS is working end-to-end, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
1. `cd backend && go build ./cmd/server/` succeeds
2. `cd backend && make test` passes
3. No wildcard CORS (`Access-Control-Allow-Origin: *`) in main.go
4. `rs/cors` dependency in go.mod
5. Frontend at Sevalla URL can query the backend (verified by user)
6. Unauthorized origins are rejected (verified by curl test)
7. `cd fe && pnpm run test:coverage` exits 0, frontend coverage not regressed
</verification>

<success_criteria>
- Backend uses rs/cors with environment-based origin allowlist (no more wildcard `*`)
- ALLOWED_ORIGINS env var set on Sevalla backend to allow the frontend origin
- Frontend deployed on Sevalla can successfully query the production backend GraphQL API
- Local development continues to work with localhost defaults
- All existing Go tests pass
- Frontend test coverage not regressed
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-deployment/05-03-SUMMARY.md`
</output>
