---
phase: 05-testing-deployment
plan: 03
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - perspectize-go/cmd/server/main.go
  - perspectize-go/go.mod
  - perspectize-go/go.sum
autonomous: false

must_haves:
  truths:
    - "Backend CORS allows requests from the GitHub Pages frontend origin"
    - "Backend CORS rejects requests from unauthorized origins in production"
    - "Frontend deployed on GitHub Pages can successfully query the backend GraphQL API"
    - "Local development still works (localhost origins allowed by default)"
  artifacts:
    - path: "perspectize-go/cmd/server/main.go"
      provides: "Production CORS configuration using rs/cors with environment-based origin allowlist"
      contains: "AllowedOrigins"
    - path: "perspective-go/go.mod"
      provides: "Go module with rs/cors dependency"
      contains: "rs/cors"
  key_links:
    - from: "perspectize-go/cmd/server/main.go"
      to: "ALLOWED_ORIGINS env var"
      via: "os.Getenv for origin allowlist"
      pattern: "ALLOWED_ORIGINS"
    - from: "perspectize-go/cmd/server/main.go"
      to: "/graphql endpoint"
      via: "cors.Handler wrapping GraphQL server"
      pattern: "corsHandler.*Handler.*srv"
---

<objective>
Configure production-ready CORS on the Go backend to allow requests from the deployed GitHub Pages frontend.

Purpose: The backend currently uses wildcard CORS (`*`) which is a security risk in production. The frontend deployed on GitHub Pages needs to make GraphQL requests to the Sevalla-hosted backend. This plan replaces the hand-rolled CORS middleware with the `rs/cors` library and configures it to allow the specific production frontend origin.

Output: Backend CORS configured with environment-based origin allowlist. The deployed frontend at https://codewarrior-debug.github.io/perspectize-be/ can successfully query the production GraphQL API.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-testing-deployment/05-RESEARCH.md
@.planning/phases/05-testing-deployment/05-02-SUMMARY.md
@perspectize-go/cmd/server/main.go
@perspectize-go/go.mod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace wildcard CORS with rs/cors and environment-based allowlist</name>
  <files>
perspectize-go/cmd/server/main.go
perspectize-go/go.mod
perspectize-go/go.sum
  </files>
  <action>
**1. Add rs/cors dependency:**

```bash
cd perspectize-go && go get github.com/rs/cors
```

**2. Update `perspectize-go/cmd/server/main.go`:**

Replace the hand-rolled `corsHandler` closure (lines 78-89) with `rs/cors` library. The current code is:

```go
// CORS middleware for frontend dev server
corsHandler := func(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        w.Header().Set("Access-Control-Allow-Origin", "*")
        w.Header().Set("Access-Control-Allow-Methods", "POST, GET, OPTIONS")
        w.Header().Set("Access-Control-Allow-Headers", "Content-Type")
        if r.Method == http.MethodOptions {
            w.WriteHeader(http.StatusOK)
            return
        }
        next.ServeHTTP(w, r)
    })
}
```

Replace with:

```go
import (
    // add to existing imports
    "strings"
    "github.com/rs/cors"
)

// ... in main() function, replace the corsHandler closure with:

// Production-ready CORS
corsMiddleware := cors.New(cors.Options{
    AllowedOrigins:   getAllowedOrigins(),
    AllowedMethods:   []string{"GET", "POST", "OPTIONS"},
    AllowedHeaders:   []string{"Content-Type"},
    AllowCredentials: false,
    MaxAge:           3600, // Cache preflight for 1 hour
})

// Update the route handler:
http.Handle("/graphql", corsMiddleware.Handler(srv))
```

**3. Add `getAllowedOrigins` function** (outside main, at package level):

```go
func getAllowedOrigins() []string {
    // Production: Set ALLOWED_ORIGINS env var (comma-separated)
    // Example: ALLOWED_ORIGINS=https://codewarrior-debug.github.io
    if origins := os.Getenv("ALLOWED_ORIGINS"); origins != "" {
        parts := strings.Split(origins, ",")
        result := make([]string, len(parts))
        for i, origin := range parts {
            result[i] = strings.TrimSpace(origin)
        }
        return result
    }

    // Default to localhost for development
    return []string{
        "http://localhost:5173",  // Vite dev server
        "http://localhost:4173",  // Vite preview server
    }
}
```

**4. Run `go mod tidy`** to clean up go.sum.

**5. Verify locally:**

```bash
cd perspectize-go && go build ./cmd/server/
```

The build must succeed. Then run `make test` to ensure no tests break.

**6. Set ALLOWED_ORIGINS on Sevalla:**

The production backend on Sevalla needs the `ALLOWED_ORIGINS` env var set. Use the Sevalla dashboard or CLI to set:
```
ALLOWED_ORIGINS=https://codewarrior-debug.github.io
```

Note: The origin is `https://codewarrior-debug.github.io` (no trailing path). CORS checks origin only, not full URL path.

If Sevalla CLI is not available, this will be handled in the checkpoint.
  </action>
  <verify>
1. `cd perspectize-go && go build ./cmd/server/` succeeds
2. `cd perspectize-go && make test` passes (all existing tests pass)
3. `grep "rs/cors" perspectize-go/go.mod` finds the dependency
4. `grep "getAllowedOrigins" perspectize-go/cmd/server/main.go` finds the function
5. `grep -c 'Access-Control-Allow-Origin.*\*' perspectize-go/cmd/server/main.go` returns 0 (no more wildcard)
  </verify>
  <done>rs/cors replaces hand-rolled CORS middleware. Environment-based origin allowlist with localhost defaults for development. Build and tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Production CORS configuration on the Go backend using rs/cors with environment-based origin allowlist. The wildcard CORS (*) has been replaced with specific origin validation.</what-built>
  <how-to-verify>
1. **Set ALLOWED_ORIGINS on Sevalla:** Go to the Sevalla dashboard for the perspectize-go application. Add environment variable:
   - Key: `ALLOWED_ORIGINS`
   - Value: `https://codewarrior-debug.github.io`
   Then redeploy the backend.

2. **Verify CORS works end-to-end:** Visit https://codewarrior-debug.github.io/perspectize-be/ in Chrome. Open DevTools (Network tab). The page should load and make a GraphQL request to the Sevalla backend. Check:
   - The GraphQL request should return 200 (not blocked by CORS)
   - Response headers should include `Access-Control-Allow-Origin: https://codewarrior-debug.github.io`

3. **Verify CORS rejects unauthorized origins:** In terminal, run:
   ```bash
   curl -s -D - -o /dev/null \
     -H "Origin: https://evil-site.com" \
     -H "Content-Type: application/json" \
     -X POST \
     https://perspectize-go-dz3qa.ondigitalocean.app/graphql \
     -d '{"query": "{ __typename }"}'
   ```
   The response should NOT include `Access-Control-Allow-Origin: https://evil-site.com`.

4. **Verify local dev still works:** If you have the backend running locally, the frontend dev server at localhost:5173 should still be able to query it (localhost is in the default allowlist).
  </how-to-verify>
  <resume-signal>Type "verified" if CORS is working end-to-end, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `cd perspectize-go && go build ./cmd/server/` succeeds
2. `cd perspectize-go && make test` passes
3. No wildcard CORS (`*`) in main.go
4. `rs/cors` dependency in go.mod
5. Frontend at GitHub Pages URL can query Sevalla backend (verified by user)
6. Unauthorized origins are rejected (verified by curl test)
</verification>

<success_criteria>
- Backend uses rs/cors with environment-based origin allowlist (no more wildcard `*`)
- ALLOWED_ORIGINS env var set on Sevalla to allow GitHub Pages origin
- Frontend deployed on GitHub Pages can successfully query the production backend
- Local development continues to work with localhost defaults
- All existing Go tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-testing-deployment/05-03-SUMMARY.md`
</output>
