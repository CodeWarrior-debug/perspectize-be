---
phase: 06-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/adapters/repositories/postgres/gorm_mappers.go
  - backend/internal/adapters/graphql/resolvers/helpers.go
  - backend/internal/adapters/graphql/resolvers/schema.resolvers.go
  - backend/internal/core/services/content_service.go
  - backend/pkg/graphql/intid.go
autonomous: true

must_haves:
  truths:
    - "gorm_mappers.go CategorizedRatings JSON parse failure is logged with slog.Warn (not silently skipped)"
    - "CreateFromYouTube returns the existing content item on duplicate URL (idempotent, no error)"
    - "io.WriteString return value is checked in MarshalIntID"
    - "All 78+ existing backend tests pass with zero regressions"
  artifacts:
    - path: "backend/internal/core/services/content_service.go"
      provides: "Idempotent CreateFromYouTube"
      contains: "return existing, nil"
    - path: "backend/internal/adapters/repositories/postgres/gorm_mappers.go"
      provides: "Logged CategorizedRatings parse failure"
      contains: "slog.Warn"
    - path: "backend/pkg/graphql/intid.go"
      provides: "Checked WriteString return"
      contains: "WriteString"
---

<objective>
Fix silent failures and data integrity issues: log CategorizedRatings JSON parse errors (C-06/C-08), make CreateFromYouTube idempotent on duplicate URLs (M-03), check io.WriteString return in IntID marshal (H-21).

Purpose: Eliminate silent data loss and improve error handling correctness.

Output: 3 targeted fixes, all existing tests pass.
</objective>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/CLAUDE.md
@backend/internal/adapters/repositories/postgres/gorm_mappers.go
@backend/internal/core/services/content_service.go
@backend/pkg/graphql/intid.go
</context>

<tasks>

### Task 1: Log CategorizedRatings JSON parse failure (C-06/C-08)

**File:** `backend/internal/adapters/repositories/postgres/gorm_mappers.go`

At line ~125, the `json.Unmarshal` for CategorizedRatings silently `continue`s on error. Add `slog.Warn`:

```go
if err := json.Unmarshal([]byte(jsonStr), &cr); err != nil {
    slog.Warn("failed to parse categorized rating JSON", "error", err)
    continue
}
```

Ensure `"log/slog"` is in the import block.

### Task 2: Make CreateFromYouTube idempotent (M-03)

**File:** `backend/internal/core/services/content_service.go`

At line ~31, change duplicate URL handling from returning an error to returning the existing item:

```go
// Before:
existing, err := s.repo.GetByURL(ctx, url)
if err == nil && existing != nil {
    return nil, fmt.Errorf("%w: content with URL %s already exists", domain.ErrAlreadyExists, url)
}

// After:
existing, err := s.repo.GetByURL(ctx, url)
if err == nil && existing != nil {
    return existing, nil
}
```

This makes the operation idempotent — calling CreateFromYouTube with an existing URL returns the existing content instead of an error. The frontend already handles this case via toast messages; now it will show the existing video data directly.

**Important:** Update any tests that assert `ErrAlreadyExists` on duplicate URLs to instead assert success with the existing item returned.

### Task 3: Check io.WriteString return in IntID (H-21)

**File:** `backend/pkg/graphql/intid.go`

At line 17, the `io.WriteString` return value is ignored. Fix:

```go
func MarshalIntID(id int) graphql.Marshaler {
    return graphql.WriterFunc(func(w io.Writer) {
        _, _ = io.WriteString(w, strconv.Quote(strconv.Itoa(id)))
    })
}
```

Using `_, _` explicitly acknowledges the error — in GraphQL marshalers, write errors are handled by the framework at the transport layer, so swallowing is intentional. The explicit discard satisfies linters.

### Task 4: Run tests

```bash
cd backend && go build ./... && go test ./...
```

All tests must pass. If any test asserts `ErrAlreadyExists` from `CreateFromYouTube`, update it for the new idempotent behavior.

</tasks>
