---
phase: 06-error-handling
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - backend/internal/adapters/graphql/resolvers/schema.resolvers.go
  - backend/cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "ContentByID returns nil,nil for not-found (same as UserByID, PerspectiveByID)"
    - "Resolver error messages never expose database schema, internal paths, or wrapped service errors"
    - "YouTube API key missing in production causes startup failure (not just a warning)"
    - "All 78+ existing backend tests pass with zero regressions"
  artifacts:
    - path: "backend/internal/adapters/graphql/resolvers/schema.resolvers.go"
      provides: "Consistent not-found and sanitized error handling"
      contains: "return nil, nil"
    - path: "backend/cmd/server/main.go"
      provides: "Startup validation for YouTube API key in production"
      contains: "log.Fatal"
---

<objective>
Standardize not-found handling across resolvers (H-16) and sanitize GraphQL error responses (H-13). Enforce YouTube API key in production (H-20).

Purpose: Consistent API behavior and no internal detail leakage to clients.

Output: Unified resolver error patterns, startup validation, all tests pass.
</objective>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@backend/CLAUDE.md
@backend/internal/adapters/graphql/resolvers/schema.resolvers.go
@backend/cmd/server/main.go
@backend/internal/core/domain/errors.go
</context>

<tasks>

### Task 1: Standardize not-found handling (H-16)

**File:** `backend/internal/adapters/graphql/resolvers/schema.resolvers.go`

Current inconsistency:
- `UserByID`, `UserByUsername`, `PerspectiveByID` → return `nil, nil` for not-found (correct GraphQL convention for nullable fields)
- `ContentByID` → returns error `"content not found with ID: %s"` (wrong — inconsistent)

Fix `ContentByID` (around line 193):

```go
content, err := r.ContentService.GetByID(ctx, intID)
if err != nil {
    if errors.Is(err, domain.ErrNotFound) {
        return nil, nil // Return null for not found (GraphQL convention)
    }
    if errors.Is(err, domain.ErrInvalidInput) {
        return nil, fmt.Errorf("invalid content ID: %s", id)
    }
    slog.Error("fetching content failed", "id", id, "error", err)
    return nil, fmt.Errorf("failed to fetch content")
}
```

### Task 2: Sanitize GraphQL error responses (H-13)

**File:** `backend/internal/adapters/graphql/resolvers/schema.resolvers.go`

Audit each resolver method's error handling. The pattern should be:
1. **Domain errors** (ErrNotFound, ErrInvalidInput, ErrAlreadyExists) → return user-friendly message
2. **Unexpected errors** → log full error server-side with `slog.Error`, return generic message to client

Check these resolvers and fix any that wrap internal errors:

**CreateContentFromYouTube** (around line 205):
```go
content, err := r.ContentService.CreateFromYouTube(ctx, url)
if err != nil {
    if errors.Is(err, domain.ErrInvalidURL) {
        return nil, fmt.Errorf("invalid YouTube URL")
    }
    slog.Error("creating content from YouTube failed", "url", url, "error", err)
    return nil, fmt.Errorf("failed to create content from YouTube")
}
```

**CreatePerspective** — already has good pattern (line ~102: generic "failed to create perspective")

**UpdatePerspective** — add slog.Error for unexpected errors:
```go
slog.Error("updating perspective failed", "id", input.ID, "error", err)
return nil, fmt.Errorf("failed to update perspective")
```

**DeletePerspective** — add slog.Error for unexpected errors:
```go
slog.Error("deleting perspective failed", "id", id, "error", err)
return false, fmt.Errorf("failed to delete perspective")
```

### Task 3: Enforce YouTube API key in production (H-20)

**File:** `backend/cmd/server/main.go`

At line ~86, change from warning to fatal in production:

```go
if cfg.YouTube.APIKey == "" {
    if os.Getenv("APP_ENV") == "production" {
        log.Fatal("YOUTUBE_API_KEY is required in production")
    }
    slog.Warn("YOUTUBE_API_KEY is empty — YouTube metadata fetching will fail")
}
```

### Task 4: Run tests

```bash
cd backend && go build ./... && go test ./...
```

All tests must pass. If any resolver test expects an error string like "content not found with ID:", update it for the new nil,nil behavior.

</tasks>
