---
phase: 07-backend-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/core/ports/services/content_service.go
  - backend/internal/core/ports/services/user_service.go
  - backend/internal/core/ports/services/perspective_service.go
  - backend/internal/core/ports/services/youtube_client.go
  - backend/internal/core/services/content_service.go
  - backend/internal/adapters/youtube/parser.go
  - backend/internal/adapters/youtube/client.go
  - backend/internal/adapters/graphql/resolvers/resolver.go
  - backend/internal/adapters/graphql/resolvers/schema.resolvers.go
  - backend/test/services/content_service_test.go
autonomous: true

must_haves:
  truths:
    - "Resolver depends on interfaces, not concrete service types"
    - "No adapter-to-adapter imports in resolver — youtube package not imported"
    - "ExtractVideoID is a method on YouTubeClient, not passed as function parameter"
    - "All 78+ existing tests pass with zero regressions"
  artifacts:
    - path: "backend/internal/core/ports/services/content_service.go"
      provides: "ContentService port interface"
      exports: ["ContentService"]
    - path: "backend/internal/core/ports/services/user_service.go"
      provides: "UserService port interface"
      exports: ["UserService"]
    - path: "backend/internal/core/ports/services/perspective_service.go"
      provides: "PerspectiveService port interface"
      exports: ["PerspectiveService"]
    - path: "backend/internal/adapters/graphql/resolvers/resolver.go"
      provides: "Resolver using port interfaces"
      contains: "portservices"
  key_links:
    - from: "backend/internal/adapters/graphql/resolvers/resolver.go"
      to: "backend/internal/core/ports/services/"
      via: "import portservices"
      pattern: "portservices\\."
    - from: "backend/internal/adapters/graphql/resolvers/schema.resolvers.go"
      to: "backend/internal/core/services/"
      via: "must NOT import concrete services or youtube adapter"
      pattern: "!youtube\\.ExtractVideoID"
---

<objective>
Define service port interfaces and refactor resolver to depend on interfaces instead of concrete types. Fix adapter-to-adapter coupling by moving ExtractVideoID to the YouTubeClient interface.

Purpose: Addresses H-01 (adapter-to-adapter coupling), H-02 (concrete service dependencies), and M-05 (function parameter injection). This is the core hexagonal architecture fix.

Output: Service port interfaces in `core/ports/services/`, resolver using interfaces, ExtractVideoID as YouTubeClient method, all tests passing.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-backend-architecture/07-RESEARCH.md
@backend/CLAUDE.md
@backend/internal/core/ports/services/youtube_client.go
@backend/internal/core/services/content_service.go
@backend/internal/core/services/user_service.go
@backend/internal/core/services/perspective_service.go
@backend/internal/adapters/graphql/resolvers/resolver.go
@backend/internal/adapters/graphql/resolvers/schema.resolvers.go
@backend/internal/adapters/youtube/parser.go
@backend/test/services/content_service_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define service port interfaces and move ExtractVideoID to YouTubeClient</name>
  <files>
    backend/internal/core/ports/services/content_service.go
    backend/internal/core/ports/services/user_service.go
    backend/internal/core/ports/services/perspective_service.go
    backend/internal/core/ports/services/youtube_client.go
    backend/internal/adapters/youtube/parser.go
    backend/internal/adapters/youtube/client.go
  </files>
  <action>
    1. Create `core/ports/services/content_service.go` with a `ContentService` interface:
       - `CreateFromYouTube(ctx context.Context, url string) (*domain.Content, error)` — NOTE: no extractVideoID parameter. The service implementation will use its injected YouTubeClient.
       - `GetByID(ctx context.Context, id int) (*domain.Content, error)`
       - `ListContent(ctx context.Context, params domain.ContentListParams) (*domain.PaginatedContent, error)`

    2. Create `core/ports/services/user_service.go` with a `UserService` interface:
       - `Create(ctx context.Context, username, email string) (*domain.User, error)`
       - `GetByID(ctx context.Context, id int) (*domain.User, error)`
       - `GetByUsername(ctx context.Context, username string) (*domain.User, error)`
       - `ListAll(ctx context.Context) ([]*domain.User, error)`

    3. Create `core/ports/services/perspective_service.go` with a `PerspectiveService` interface:
       - `Create(ctx context.Context, input CreatePerspectiveInput) (*domain.Perspective, error)`
       - `GetByID(ctx context.Context, id int) (*domain.Perspective, error)`
       - `Update(ctx context.Context, input UpdatePerspectiveInput) (*domain.Perspective, error)`
       - `Delete(ctx context.Context, id int) error`
       - `ListPerspectives(ctx context.Context, params domain.PerspectiveListParams) (*domain.PaginatedPerspectives, error)`
       - Also define `CreatePerspectiveInput` and `UpdatePerspectiveInput` structs in this file (move from `services` package). These are part of the service contract.

    4. Update `core/ports/services/youtube_client.go`:
       - Add `ExtractVideoID(url string) (string, error)` to the `YouTubeClient` interface.

    5. Add `ExtractVideoID` as a method on the YouTube `Client` struct in `adapters/youtube/client.go`:
       - Add method: `func (c *Client) ExtractVideoID(url string) (string, error)` that delegates to the existing standalone `ExtractVideoID` function in `parser.go`.
       - Keep the standalone function in `parser.go` as-is (it can be unexported later, but for now the parser tests reference it).

    6. Update `core/services/content_service.go`:
       - Change `CreateFromYouTube` signature: remove the `extractVideoID func(string) (string, error)` parameter.
       - Instead, call `s.youtubeClient.ExtractVideoID(url)` to get the video ID.

    7. Update `core/services/perspective_service.go`:
       - Change `CreatePerspectiveInput` and `UpdatePerspectiveInput` to be type aliases or re-exports from the port package. The simplest approach: import the port types and use them directly. Update references throughout the file.
       - Concrete approach: In `perspective_service.go`, replace the local `CreatePerspectiveInput` and `UpdatePerspectiveInput` struct definitions with imports from `core/ports/services`. Update `Create` and `Update` method signatures to use `portservices.CreatePerspectiveInput` and `portservices.UpdatePerspectiveInput`.
  </action>
  <verify>
    `cd backend && go build ./...` compiles with zero errors. No import of `"github.com/CodeWarrior-debug/perspectize/backend/internal/core/services"` in the port interface files (they must only import domain).
  </verify>
  <done>
    Three service port interfaces defined. YouTubeClient interface includes ExtractVideoID. ContentService.CreateFromYouTube no longer takes extractVideoID parameter. Input types live in ports/services package.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor resolver to use interfaces and fix all tests</name>
  <files>
    backend/internal/adapters/graphql/resolvers/resolver.go
    backend/internal/adapters/graphql/resolvers/schema.resolvers.go
    backend/test/services/content_service_test.go
  </files>
  <action>
    1. Update `resolver.go`:
       - Import `portservices "github.com/CodeWarrior-debug/perspectize/backend/internal/core/ports/services"`
       - Change Resolver struct fields from concrete pointers to interfaces:
         ```go
         type Resolver struct {
             ContentService     portservices.ContentService
             UserService        portservices.UserService
             PerspectiveService portservices.PerspectiveService
         }
         ```
       - Update `NewResolver` to accept interfaces instead of concrete pointers.
       - Remove the import of `"github.com/CodeWarrior-debug/perspectize/backend/internal/core/services"`.

    2. Update `schema.resolvers.go`:
       - Remove the import of `"github.com/CodeWarrior-debug/perspectize/backend/internal/adapters/youtube"` (this is the H-01 adapter-to-adapter violation).
       - In `CreateContentFromYouTube`: change call from `r.ContentService.CreateFromYouTube(ctx, input.URL, youtube.ExtractVideoID)` to `r.ContentService.CreateFromYouTube(ctx, input.URL)`.
       - Remove the import of `"github.com/CodeWarrior-debug/perspectize/backend/internal/core/services"` — use `portservices` for input types instead.
       - In `CreatePerspective` and `UpdatePerspective`: change `services.CreatePerspectiveInput` to `portservices.CreatePerspectiveInput` and `services.UpdatePerspectiveInput` to `portservices.UpdatePerspectiveInput`.
       - Add import: `portservices "github.com/CodeWarrior-debug/perspectize/backend/internal/core/ports/services"`

    3. Update `cmd/server/main.go`:
       - `NewResolver` still receives concrete service instances — Go interfaces are satisfied implicitly, so `*services.ContentService` satisfies `portservices.ContentService` as long as the method signatures match. No change needed to main.go wiring beyond ensuring method signatures match.

    4. Update `test/services/content_service_test.go`:
       - All `CreateFromYouTube` test calls currently pass `extractVideoID` as a third argument. Remove this parameter from all test calls.
       - Add `ExtractVideoID` method to `mockYouTubeClient` struct so it satisfies the updated interface.
       - For tests that tested extractVideoID failure (like `TestCreateFromYouTube_InvalidURL`), mock `ExtractVideoID` on the YouTubeClient mock to return an error instead of passing a failing function.

    5. Run `cd backend && go test ./...` — all tests must pass.
  </action>
  <verify>
    `cd backend && go build ./...` compiles. `cd backend && go test ./...` passes all tests (78+). `grep -r "adapters/youtube" backend/internal/adapters/graphql/` returns zero results (no adapter-to-adapter imports). `grep "\\*services\\." backend/internal/adapters/graphql/resolvers/resolver.go` returns zero results (no concrete types).
  </verify>
  <done>
    Resolver depends on port interfaces only. No adapter-to-adapter imports. All tests pass. H-01, H-02, M-05 resolved.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && go build ./...` — zero compilation errors
2. `cd backend && go test ./...` — all tests pass
3. `grep -rn "adapters/youtube" backend/internal/adapters/graphql/` — zero results (H-01 fixed)
4. `grep -n "\\*services\\." backend/internal/adapters/graphql/resolvers/resolver.go` — zero results (H-02 fixed)
5. `grep -n "extractVideoID func" backend/internal/core/services/content_service.go` — zero results (M-05 fixed)
6. Port interface files exist: `ls backend/internal/core/ports/services/*.go` shows 4 files
</verification>

<success_criteria>
- Service port interfaces defined for all 3 services + YouTubeClient updated
- Resolver struct uses interfaces, not concrete types
- schema.resolvers.go has zero imports from adapters/youtube or core/services
- CreateFromYouTube takes (ctx, url) not (ctx, url, extractVideoID)
- All existing tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/07-backend-architecture/07-01-SUMMARY.md`
</output>
