---
phase: 07-backend-architecture
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/adapters/repositories/postgres/array_types.go
  - backend/internal/adapters/repositories/postgres/perspective_repository.go
  - backend/pkg/database/postgres.go
  - backend/internal/config/config.go
  - backend/internal/config/validation.go
  - backend/cmd/server/main.go
  - backend/go.mod
  - backend/go.sum
autonomous: true

must_haves:
  truths:
    - "lib/pq is removed from go.mod — single PostgreSQL driver (pgx)"
    - "DB pool settings are configurable via env vars (DB_MAX_OPEN_CONNS, DB_MAX_IDLE_CONNS, DB_CONN_MAX_LIFETIME)"
    - "Config path loaded from CONFIG_PATH env var with sensible default"
    - "DATABASE_URL format validated at startup (scheme, hostname, database name)"
    - "DB credentials sanitized before any logging — password never appears in log output"
  artifacts:
    - path: "backend/internal/adapters/repositories/postgres/array_types.go"
      provides: "Custom StringArray and Int64Array types replacing pq"
      exports: ["StringArray", "Int64Array"]
    - path: "backend/internal/config/validation.go"
      provides: "DATABASE_URL validation and DSN sanitization"
      exports: ["ValidateDatabaseURL", "SanitizeDSN"]
  key_links:
    - from: "backend/internal/adapters/repositories/postgres/perspective_repository.go"
      to: "backend/internal/adapters/repositories/postgres/array_types.go"
      via: "uses custom array types instead of pq"
      pattern: "StringArray|Int64Array"
    - from: "backend/cmd/server/main.go"
      to: "backend/internal/config/validation.go"
      via: "validates DATABASE_URL at startup"
      pattern: "ValidateDatabaseURL"
---

<objective>
Replace lib/pq with custom array types, make DB pool configurable via env vars, add config path env var support, validate DATABASE_URL format, and sanitize DB credentials in logs.

Purpose: Addresses M-01 (dual driver), M-02 (hardcoded pool), H-09 (hardcoded config path), M-12 (credential leakage), M-17 (no DSN validation). Consolidates all config and database hardening.

Output: Single PostgreSQL driver, configurable pool, env-based config path, DSN validation, credential sanitization.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-backend-architecture/07-RESEARCH.md
@backend/CLAUDE.md
@backend/internal/adapters/repositories/postgres/perspective_repository.go
@backend/pkg/database/postgres.go
@backend/internal/config/config.go
@backend/cmd/server/main.go
@backend/go.mod
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace lib/pq with custom array types and make pool configurable</name>
  <files>
    backend/internal/adapters/repositories/postgres/array_types.go
    backend/internal/adapters/repositories/postgres/perspective_repository.go
    backend/pkg/database/postgres.go
  </files>
  <action>
    1. Create `adapters/repositories/postgres/array_types.go` with custom types that implement `sql.Scanner` and `driver.Valuer`:

       **StringArray:**
       - `Scan(src interface{}) error` — handles nil (sets to nil), parses PostgreSQL text array literal `{val1,"val with comma",val3}`. Must handle: nil input, empty array `{}`, quoted strings with commas/backslashes, NULL elements.
       - `Value() (driver.Value, error)` — returns nil for nil slice, formats as PostgreSQL array literal.

       **Int64Array:**
       - `Scan(src interface{}) error` — handles nil, parses PostgreSQL integer array literal `{1,2,3}`.
       - `Value() (driver.Value, error)` — returns nil for nil slice, formats as `{1,2,3}`.

       These replace `pq.StringArray`, `pq.Int64Array`, and `pq.Array()`.

    2. Update `perspective_repository.go`:
       - Remove the `"github.com/lib/pq"` import.
       - Replace `pq.StringArray` with `StringArray` (local package type from array_types.go).
       - Replace `pq.Int64Array` with `Int64Array` (local package type).
       - Replace `pq.Array(p.Parts)` with `Int64Array(convertIntToInt64(p.Parts))` or equivalent — ensure the parts ([]int) are properly converted to Int64Array for the Value() call.
       - Replace `pq.Array(p.Labels)` with `StringArray(p.Labels)`.
       - Update the `CategorizedRatingArray` type's `Scan` and `Value` methods: they currently reference `pq.StringArray` — replace with `StringArray`.
       - Note: the `perspectiveDBModel` struct uses `pq.Int64Array` and `pq.StringArray` for `Parts` and `Labels` fields — change these to `Int64Array` and `StringArray`.

    3. Update `pkg/database/postgres.go`:
       - Add a `PoolConfig` struct with `MaxOpenConns`, `MaxIdleConns`, `ConnMaxLifetime` fields.
       - Add `DefaultPoolConfig()` returning sensible defaults (25, 5, 5min).
       - Add `PoolConfigFromEnv()` that reads `DB_MAX_OPEN_CONNS`, `DB_MAX_IDLE_CONNS`, `DB_CONN_MAX_LIFETIME` env vars, falling back to defaults.
       - Change `Connect` signature to accept `PoolConfig` as second parameter: `Connect(dsn string, pool PoolConfig) (*sqlx.DB, error)`.
       - Apply pool config from the struct instead of hardcoded values.

    4. Do NOT touch `gorm_models.go` or `gorm_mappers.go` — those are Phase 7.1 prototypes and will be updated then.
  </action>
  <verify>
    `cd backend && go build ./...` compiles. `grep -r "lib/pq" backend/internal/adapters/repositories/postgres/perspective_repository.go` returns zero results. `grep -r "lib/pq" backend/pkg/` returns zero results.
  </verify>
  <done>
    Custom array types replace pq in active code. DB pool configurable via env vars. Hardcoded pool values eliminated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Config path from env, DATABASE_URL validation, DSN sanitization, remove lib/pq</name>
  <files>
    backend/internal/config/config.go
    backend/internal/config/validation.go
    backend/cmd/server/main.go
    backend/go.mod
    backend/go.sum
  </files>
  <action>
    1. Create `config/validation.go`:
       - `ValidateDatabaseURL(raw string) error` — validates scheme (postgres:// or postgresql://), hostname present, database name present. Returns nil if raw is empty (not using DATABASE_URL). Uses `net/url.Parse`.
       - `SanitizeDSN(dsn string) string` — parses DSN as URL, replaces password with `***`. If URL parse fails (key-value format DSN), use regex to mask `password=xxx` with `password=***`. Always safe for logging.

    2. Update `config/config.go`:
       - In `Load()`: accept `configPath string` as before, but this is now passed from main.go which reads it from env.
       - No changes needed to Load itself — the env var logic is in main.go.

    3. Update `cmd/server/main.go`:
       - **Config path from env (H-09):** Replace `config.Load("config/config.example.json")` with:
         ```go
         configPath := os.Getenv("CONFIG_PATH")
         if configPath == "" {
             configPath = "config/config.example.json"
         }
         cfg, err := config.Load(configPath)
         ```
       - **DATABASE_URL validation (M-17):** After loading config, before connecting:
         ```go
         if dbURL := os.Getenv("DATABASE_URL"); dbURL != "" {
             if err := config.ValidateDatabaseURL(dbURL); err != nil {
                 log.Fatalf("Invalid DATABASE_URL: %v", err)
             }
         }
         ```
       - **DSN sanitization (M-12):** Replace the `log.Fatalf("Failed to connect to database: %v", err)` with `log.Fatalf("Failed to connect to database %s: %v", config.SanitizeDSN(dsn), err)` — ensures password never logged. Also sanitize the ping failure log.
       - **Configurable pool (M-02):** Pass `database.PoolConfigFromEnv()` to `database.Connect(dsn, poolCfg)`.

    4. Remove `lib/pq` from `go.mod`:
       - Run `cd backend && go mod tidy` — this should remove `lib/pq` IF no active code imports it.
       - Note: `gorm_models.go` and `gorm_mappers.go` still import `lib/pq`. If `go mod tidy` keeps it due to those files, that is acceptable — `lib/pq` will be fully removed in Phase 7.1. In that case, the concern is partially addressed (removed from active repository code, retained only in prototype files).

    5. Run `cd backend && go test ./...` to verify no regressions.
  </action>
  <verify>
    `cd backend && go build ./...` compiles. `cd backend && go test ./...` passes. `grep "config.example.json" backend/cmd/server/main.go` shows it only appears in the default fallback, not hardcoded in the Load call. `grep -n "ValidateDatabaseURL\|SanitizeDSN" backend/cmd/server/main.go` shows both are called.
  </verify>
  <done>
    Config path from CONFIG_PATH env var with default. DATABASE_URL validated at startup. DSN sanitized in all log output. Pool configurable via env. lib/pq removed from active code (may remain in go.mod due to gorm prototype files).
  </done>
</task>

</tasks>

<verification>
1. `cd backend && go build ./...` — zero compilation errors
2. `cd backend && go test ./...` — all tests pass
3. `grep -rn "lib/pq" backend/internal/adapters/repositories/postgres/perspective_repository.go` — zero results (M-01 active code)
4. `grep "SetMaxOpenConns" backend/pkg/database/postgres.go` — uses config struct, not hardcoded (M-02)
5. `grep "CONFIG_PATH" backend/cmd/server/main.go` — env var read (H-09)
6. `grep "SanitizeDSN" backend/cmd/server/main.go` — called before logging (M-12)
7. `grep "ValidateDatabaseURL" backend/cmd/server/main.go` — called at startup (M-17)
</verification>

<success_criteria>
- lib/pq removed from perspective_repository.go (custom array types work)
- DB pool configurable via DB_MAX_OPEN_CONNS, DB_MAX_IDLE_CONNS, DB_CONN_MAX_LIFETIME
- CONFIG_PATH env var with "config/config.example.json" default
- DATABASE_URL validated (scheme, host, dbname) at startup
- Password never appears in log output (SanitizeDSN used everywhere)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-backend-architecture/07-02-SUMMARY.md`
</output>
