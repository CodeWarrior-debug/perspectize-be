---
phase: 07-backend-architecture
plan: 03
type: execute
wave: 2
depends_on: ["07-02"]
files_modified:
  - backend/cmd/server/main.go
  - backend/go.mod
  - backend/go.sum
autonomous: true

must_haves:
  truths:
    - "Request logging middleware logs method, path, status, and duration for every HTTP request"
    - "/health returns 200 (liveness — process alive)"
    - "/ready returns 200 when DB reachable, 503 when DB unreachable (readiness — can serve traffic)"
    - "SIGTERM triggers graceful shutdown — in-flight requests complete before process exits"
    - "chi router serves all routes (GraphQL, playground, health, ready)"
  artifacts:
    - path: "backend/cmd/server/main.go"
      provides: "chi router with middleware, /ready endpoint, graceful shutdown"
      contains: "chi.NewRouter"
  key_links:
    - from: "backend/cmd/server/main.go"
      to: "chi/v5"
      via: "go-chi/chi/v5 import"
      pattern: "chi\\.NewRouter"
    - from: "/ready endpoint"
      to: "database.Ping"
      via: "DB connectivity check"
      pattern: "database\\.Ping"
---

<objective>
Add chi router with request logging middleware, /ready endpoint with DB health check, and improve graceful shutdown coordination.

Purpose: Addresses M-06 (request logging), M-09 (graceful shutdown improvements), M-10 (/ready endpoint). Completes server infrastructure hardening.

Output: chi router handling all routes with Logger/Recoverer middleware, /ready with DB ping, graceful shutdown with readiness coordination.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-backend-architecture/07-RESEARCH.md
@backend/CLAUDE.md
@backend/cmd/server/main.go
@backend/pkg/database/postgres.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install chi router, add middleware, /ready endpoint, and graceful shutdown</name>
  <files>
    backend/cmd/server/main.go
    backend/go.mod
    backend/go.sum
  </files>
  <action>
    1. Install chi: `cd backend && go get github.com/go-chi/chi/v5`

    2. Rewrite the HTTP routing section of `main.go` to use chi router:

       ```go
       import (
           "github.com/go-chi/chi/v5"
           "github.com/go-chi/chi/v5/middleware"
       )

       r := chi.NewRouter()

       // Middleware stack
       r.Use(middleware.RequestID)
       r.Use(middleware.RealIP)
       r.Use(middleware.Logger)     // M-06: request logging
       r.Use(middleware.Recoverer)  // panic recovery — prevents crashes from taking down server

       // CORS middleware (keep existing logic, wrap as chi middleware)
       r.Use(func(next http.Handler) http.Handler {
           return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
               w.Header().Set("Access-Control-Allow-Origin", "*")
               w.Header().Set("Access-Control-Allow-Methods", "POST, GET, OPTIONS")
               w.Header().Set("Access-Control-Allow-Headers", "Content-Type")
               if r.Method == http.MethodOptions {
                   w.WriteHeader(http.StatusOK)
                   return
               }
               next.ServeHTTP(w, r)
           })
       })

       // Health check — liveness probe (M-10)
       r.Get("/health", func(w http.ResponseWriter, r *http.Request) {
           w.WriteHeader(http.StatusOK)
           w.Write([]byte("ok"))
       })

       // Ready check — readiness probe with DB ping (M-10)
       r.Get("/ready", func(w http.ResponseWriter, r *http.Request) {
           if err := database.Ping(r.Context(), db); err != nil {
               w.WriteHeader(http.StatusServiceUnavailable)
               w.Write([]byte("not ready: database unreachable"))
               return
           }
           w.WriteHeader(http.StatusOK)
           w.Write([]byte("ready"))
       })

       // GraphQL
       r.Handle("/graphql", srv)
       if os.Getenv("APP_ENV") != "production" {
           r.Handle("/", playground.Handler("GraphQL Playground", "/graphql"))
       }
       ```

    3. Update the `http.Server` to use the chi router as handler:
       ```go
       server := &http.Server{
           Addr:         addr,
           Handler:      r,  // was using DefaultServeMux
           ReadTimeout:  15 * time.Second,
           WriteTimeout: 15 * time.Second,
           IdleTimeout:  60 * time.Second,
       }
       ```

    4. Graceful shutdown (M-09) — the existing pattern is already mostly correct (SIGINT/SIGTERM handler with 30s timeout). Keep it as-is. The key improvement is that chi's middleware.Logger will properly log the shutdown process, and the /ready endpoint enables load balancers to stop sending traffic before shutdown.

    5. Remove all `http.HandleFunc` and `http.Handle` calls (they register on DefaultServeMux which is no longer used).

    6. Run `cd backend && go mod tidy` to clean up.
  </action>
  <verify>
    `cd backend && go build ./...` compiles. `cd backend && go test ./...` passes. `grep "chi.NewRouter" backend/cmd/server/main.go` returns a match. `grep "middleware.Logger" backend/cmd/server/main.go` returns a match. `grep "/ready" backend/cmd/server/main.go` returns a match.
  </verify>
  <done>
    chi router serves all routes with Logger and Recoverer middleware. /health returns 200 (liveness). /ready returns 200 or 503 based on DB connectivity (readiness). Graceful shutdown with SIGTERM. M-06, M-09, M-10 resolved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify all Phase 7 success criteria and run full test suite</name>
  <files></files>
  <action>
    Run the complete Phase 7 verification checklist. This task produces no file changes — it validates everything works.

    1. `cd backend && go build ./...` — must compile
    2. `cd backend && go test ./...` — all tests must pass
    3. Verify each success criterion from the roadmap:
       - SC1 (H-01, H-02): `grep -rn "adapters/youtube" backend/internal/adapters/graphql/` — zero results
       - SC2 (H-02): `grep -n "portservices\\." backend/internal/adapters/graphql/resolvers/resolver.go` — shows interface types
       - SC3 (H-09): `grep "CONFIG_PATH" backend/cmd/server/main.go` — env var used
       - SC4 (M-01): `grep -rn "lib/pq" backend/internal/adapters/repositories/postgres/perspective_repository.go` — zero results
       - SC5 (M-02): `grep "PoolConfigFromEnv\|DB_MAX_OPEN" backend/pkg/database/postgres.go` — env vars read
       - SC6 (M-05): `grep "extractVideoID func" backend/internal/core/services/content_service.go` — zero results
       - SC7 (M-06): `grep "middleware.Logger" backend/cmd/server/main.go` — present
       - SC8 (M-09): `grep "SIGTERM\|SIGINT" backend/cmd/server/main.go` — present
       - SC9 (M-10): `grep "/ready\|/health" backend/cmd/server/main.go` — both present
       - SC10 (M-12): `grep "SanitizeDSN" backend/cmd/server/main.go` — present
       - SC11 (M-17): `grep "ValidateDatabaseURL" backend/cmd/server/main.go` — present

    4. If any check fails, fix the issue before marking complete.
  </action>
  <verify>
    All 11 success criteria grep checks return expected results. `go build` and `go test` pass.
  </verify>
  <done>
    All Phase 7 success criteria verified. Backend compiles and all tests pass. 11 concerns addressed.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && go build ./...` — zero errors
2. `cd backend && go test ./...` — all tests pass
3. chi router active: `grep "chi.NewRouter" backend/cmd/server/main.go`
4. Request logging: `grep "middleware.Logger" backend/cmd/server/main.go`
5. Ready endpoint: `grep "/ready" backend/cmd/server/main.go`
6. All 11 Phase 7 roadmap success criteria verified via grep
</verification>

<success_criteria>
- chi router handles all HTTP routes (no DefaultServeMux)
- middleware.Logger and middleware.Recoverer installed
- /health returns 200 (liveness)
- /ready returns 200 or 503 based on DB ping (readiness)
- Graceful shutdown on SIGTERM with 30s timeout
- All Phase 7 roadmap success criteria pass verification
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-backend-architecture/07-03-SUMMARY.md`
</output>
