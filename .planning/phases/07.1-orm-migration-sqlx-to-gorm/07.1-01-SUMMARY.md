---
phase: 07.1-orm-migration-sqlx-to-gorm
plan: 01
subsystem: database
tags: [gorm, orm, postgres, pgx, hexagonal-architecture, repository-pattern]

# Dependency graph
requires:
  - phase: 07-backend-architecture
    provides: Custom StringArray/Int64Array/JSONBArray types for PostgreSQL arrays
provides:
  - GORM dependencies installed (gorm.io/gorm + gorm.io/driver/postgres)
  - GORM persistence models (UserModel, ContentModel, PerspectiveModel) with hex-clean separation
  - Bidirectional domain <-> GORM mappers for all 3 entities
  - ConnectGORM function using pgx driver
  - GormUserRepository implementing UserRepository port
affects: [07.1-02, 07.1-03, database, orm-migration]

# Tech tracking
tech-stack:
  added: [gorm.io/gorm@v1.31.1, gorm.io/driver/postgres@v1.6.0]
  patterns: [hex-clean-orm-models, bidirectional-mappers, gorm-context-propagation]

key-files:
  created:
    - backend/internal/adapters/repositories/postgres/gorm_models.go
    - backend/internal/adapters/repositories/postgres/gorm_mappers.go
    - backend/internal/adapters/repositories/postgres/gorm_user_repository.go
  modified:
    - backend/go.mod
    - backend/go.sum
    - backend/pkg/database/postgres.go

key-decisions:
  - "Hex-clean GORM pattern: separate GORM models from domain models with mapper functions"
  - "Reuse custom StringArray/Int64Array/JSONBArray types (not lib/pq)"
  - "Privacy/ReviewStatus stored lowercase in DB, UPPERCASE in domain"
  - "Parts array stored as int64[] in DB, converted to []int in domain"
  - "CategorizedRatings stored as jsonb[] with JSON marshal/unmarshal in mappers"

patterns-established:
  - "GORM model pattern: gorm: tags, TableName() method, no domain imports"
  - "Mapper pattern: bidirectional domain <-> model conversion, case conversions, type conversions"
  - "Repository pattern: db.WithContext(ctx) for context propagation, gorm.ErrRecordNotFound -> domain.ErrNotFound"
  - "Compile-time interface check: var _ repositories.Interface = (*Implementation)(nil)"

# Metrics
duration: 2min
completed: 2026-02-14
---

# Phase 07.1 Plan 01: GORM Foundation Summary

**GORM dependencies with hex-clean persistence models, bidirectional mappers, and GormUserRepository implementing the repository port interface**

## Performance

- **Duration:** 2 min 15 sec
- **Started:** 2026-02-14T02:23:02Z
- **Completed:** 2026-02-14T02:25:17Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- GORM installed with pgx driver integration alongside existing sqlx connection
- 3 GORM persistence models (User, Content, Perspective) with proper gorm: tags and custom array types
- 6 bidirectional mappers handling case conversion (Privacy/ReviewStatus), type conversion (Parts int64<->int), and JSON marshaling (CategorizedRatings)
- ConnectGORM and PingGORM functions using same pgx driver as sqlx
- GormUserRepository with compile-time interface verification and context propagation

## Task Commits

Each task was committed atomically:

1. **Task 1: Install GORM and create models + mappers** - `17089c7` (feat)
2. **Task 2: Add ConnectGORM and implement GormUserRepository** - `42b8331` (feat)

## Files Created/Modified
- `backend/go.mod` - Added gorm.io/gorm and gorm.io/driver/postgres dependencies
- `backend/internal/adapters/repositories/postgres/gorm_models.go` - GORM-tagged persistence models for all 3 entities using custom array types
- `backend/internal/adapters/repositories/postgres/gorm_mappers.go` - Bidirectional conversion functions with case/type/JSON conversions
- `backend/internal/adapters/repositories/postgres/gorm_user_repository.go` - GORM implementation of UserRepository port
- `backend/pkg/database/postgres.go` - ConnectGORM and PingGORM functions

## Decisions Made

**Hex-clean GORM pattern with separate models:**
- GORM models (`gorm_models.go`) have zero domain imports - only gorm: tags
- Mappers (`gorm_mappers.go`) import domain but NOT gorm - pure conversion logic
- Repository implementations import both - coordinate between layers
- Rationale: Maintains hexagonal architecture - domain stays pure, adapters handle ORM

**Custom array types instead of lib/pq:**
- Use existing `StringArray`, `Int64Array`, `JSONBArray` from Phase 07
- These already implement Scanner/Valuer for pgx driver
- Rationale: Single driver (pgx), avoid lib/pq dependency

**Case conversion for enums:**
- Privacy/ReviewStatus stored lowercase in DB, UPPERCASE in domain
- Mappers handle `strings.ToUpper()` / `strings.ToLower()` conversion
- Rationale: Database convention (lowercase), GraphQL/domain convention (UPPERCASE)

**Type conversion for Parts array:**
- Database stores `integer[]` (int64)
- Domain uses `[]int`
- Mappers handle conversion in both directions
- Rationale: Database precision, domain convenience

**JSON marshaling for CategorizedRatings:**
- Database stores `jsonb[]` array of JSON objects
- Domain uses `[]CategorizedRating` struct
- Mappers marshal/unmarshal JSON strings
- Rationale: Type safety in domain, flexibility in storage

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - GORM installation and implementation proceeded smoothly. All existing tests continue to pass.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for Plan 02:** Content and Perspective GORM repositories
- GORM connection infrastructure complete
- Model and mapper pattern established
- UserRepository pattern proven with compile-time verification
- Custom array types (StringArray, Int64Array, JSONBArray) working with GORM

**Pattern to replicate:**
1. Create GORM models with appropriate tags
2. Create bidirectional mappers with case/type conversions
3. Implement repository with context propagation and error mapping
4. Add compile-time interface check

**No blockers:** All dependencies installed, pattern established, verification passing.

---
*Phase: 07.1-orm-migration-sqlx-to-gorm*
*Completed: 2026-02-14*
