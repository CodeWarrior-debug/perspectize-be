---
phase: 07.1-orm-migration-sqlx-to-gorm
plan: 03
type: execute
wave: 3
depends_on: ["07.1-01", "07.1-02"]
files_modified:
  - backend/cmd/server/main.go
  - backend/internal/adapters/repositories/postgres/user_repository.go
  - backend/internal/adapters/repositories/postgres/content_repository.go
  - backend/internal/adapters/repositories/postgres/perspective_repository.go
  - backend/pkg/database/postgres.go
  - backend/go.mod
autonomous: true

must_haves:
  truths:
    - "main.go uses ConnectGORM instead of sqlx Connect"
    - "main.go creates GORM repositories (NewGormUserRepository, NewGormContentRepository, NewGormPerspectiveRepository)"
    - "Old sqlx repository files renamed to .sqlx.bak (preserved for reference, not compiled)"
    - "sqlx dependency removed from go.mod (go mod tidy)"
    - "All existing tests pass with zero changes to test mocks"
    - "go build ./... compiles with zero errors"
    - "/health and /ready endpoints still work"
    - "Domain models have zero GORM imports (verified by grep)"
  artifacts:
    - path: "backend/cmd/server/main.go"
      provides: "Server wiring using GORM repositories"
      contains: "NewGormUserRepository, NewGormContentRepository, NewGormPerspectiveRepository, ConnectGORM"
  key_links:
    - from: "cmd/server/main.go"
      to: "pkg/database/postgres.go"
      via: "ConnectGORM call"
      pattern: "database\\.ConnectGORM"
    - from: "cmd/server/main.go"
      to: "gorm_*_repository.go"
      via: "repository constructor calls"
      pattern: "postgres\\.NewGorm"
---

<objective>
Wire GORM repositories into the application, replace sqlx connection with GORM, remove sqlx dependency, and archive old sqlx repository files.

Purpose: Complete the migration by making GORM the active ORM. This is the switchover — after this plan, the application runs on GORM.
Output: Application boots with GORM, all tests pass, sqlx removed.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-orm-migration-sqlx-to-gorm/07.1-01-SUMMARY.md
@.planning/phases/07.1-orm-migration-sqlx-to-gorm/07.1-02-SUMMARY.md
@backend/cmd/server/main.go
@backend/pkg/database/postgres.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire GORM into main.go and archive sqlx files</name>
  <files>
    backend/cmd/server/main.go
    backend/internal/adapters/repositories/postgres/user_repository.go
    backend/internal/adapters/repositories/postgres/content_repository.go
    backend/internal/adapters/repositories/postgres/perspective_repository.go
  </files>
  <action>
    1. Update `cmd/server/main.go`:

       **Replace database connection:**
       - Change `database.Connect(dsn, poolCfg)` to `database.ConnectGORM(dsn, poolCfg)`
       - Variable type changes from `*sqlx.DB` to `*gorm.DB`
       - Update defer: `sqlDB, _ := db.DB(); defer sqlDB.Close()` (GORM wraps sql.DB)
       - Replace `database.Ping(ctx, db)` with `database.PingGORM(ctx, db)`
       - Update the version query: use `db.Raw("SELECT version()").Scan(&version)` instead of `db.Get(&version, ...)`
       - Remove `sqlx` import, add `"gorm.io/gorm"` import

       **Replace repository constructors:**
       - `postgres.NewContentRepository(db)` -> `postgres.NewGormContentRepository(db)`
       - `postgres.NewUserRepository(db)` -> `postgres.NewGormUserRepository(db)`
       - `postgres.NewPerspectiveRepository(db)` -> `postgres.NewGormPerspectiveRepository(db)`

       **Update /ready endpoint:**
       - The readiness probe uses `db.PingContext(r.Context())` which is sqlx-specific
       - Replace with: `sqlDB, err := db.DB(); if err != nil || sqlDB.PingContext(r.Context()) != nil { ... }`

       Keep everything else unchanged (chi router, middleware, CORS, graceful shutdown).

    2. Rename old sqlx repository files to preserve them as reference:
       ```bash
       cd backend/internal/adapters/repositories/postgres
       mv user_repository.go user_repository.go.sqlx.bak
       mv content_repository.go content_repository.go.sqlx.bak
       mv perspective_repository.go perspective_repository.go.sqlx.bak
       ```

       IMPORTANT: These files contain shared helper functions used by GORM repos:
       - `encodeCursor`, `decodeCursor` (used by gorm_content_repository.go and gorm_perspective_repository.go)
       - `sortColumnName`, `sortDirection`, `isJSONBSort` (used by gorm_content_repository.go)
       - `perspectiveSortColumnName` (used by gorm_perspective_repository.go)
       - `contentTypeToDBValue`, `contentTypeFromDBValue` (used by gorm_mappers.go and gorm_content_repository.go)
       - `privacyToDBValue`, `privacyFromDBValue`, `reviewStatusToDBValue`, `reviewStatusFromDBValue` (used by gorm_mappers.go and gorm_perspective_repository.go)

       BEFORE renaming the old files, extract all shared helper functions into a new file:
       ```
       backend/internal/adapters/repositories/postgres/helpers.go
       ```
       Move these functions there:
       - `encodeCursor`, `decodeCursor`
       - `sortColumnName`, `sortDirection`, `isJSONBSort`
       - `perspectiveSortColumnName`
       - `contentTypeToDBValue`, `contentTypeFromDBValue`
       - `contentTypeFromDBValue` (content type conversion)
       - `privacyToDBValue`, `privacyFromDBValue`
       - `reviewStatusToDBValue`, `reviewStatusFromDBValue`
       - `toNullInt64FromIntPtr` (if still needed — check if any GORM code uses it, likely NOT since GORM uses pointers)
       - `intSliceToInt64Array` (if still needed)

       Check which helpers are actually used by the GORM files before moving. Only move what's needed.
       DO NOT move sqlx-specific helpers (toNullString, toNullInt64, userRow, contentRow, perspectiveRow structs, rowToDomain functions).

    3. Also delete the .disabled prototype files since the real GORM files now exist:
       ```bash
       rm -f backend/internal/adapters/repositories/postgres/gorm_*.disabled
       ```
  </action>
  <verify>
    ```bash
    cd backend && go build ./...
    ```
    Must compile. If there are missing function references, the shared helpers weren't properly extracted.
  </verify>
  <done>
    main.go uses GORM connection and GORM repositories. Old sqlx files archived as .sqlx.bak. Shared helpers extracted to helpers.go. Compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove sqlx dependency and run full verification</name>
  <files>
    backend/pkg/database/postgres.go
    backend/go.mod
  </files>
  <action>
    1. Remove the sqlx `Connect` and `Ping` functions from `pkg/database/postgres.go`:
       - Delete the `Connect` function (returns *sqlx.DB)
       - Delete the `Ping` function (takes *sqlx.DB)
       - Remove `"github.com/jmoiron/sqlx"` import
       - Keep `ConnectGORM` and `PingGORM` as the only connection functions

    2. Run `go mod tidy` to remove sqlx from go.mod:
       ```bash
       cd backend && go mod tidy
       ```

    3. Verify sqlx is fully removed:
       ```bash
       grep -r "jmoiron/sqlx" backend/ --include="*.go"
       ```
       Should return nothing (only .sqlx.bak files might match, which is fine).

    4. Verify no lib/pq imports crept in:
       ```bash
       grep -r "lib/pq" backend/ --include="*.go"
       ```
       Should return nothing.

    5. Verify domain is hex-clean:
       ```bash
       grep -r "gorm" backend/internal/core/domain/ --include="*.go"
       ```
       Should return nothing.

    6. Full test suite:
       ```bash
       cd backend && go test ./...
       ```
       All tests must pass. Tests use mock interfaces, not concrete repository types, so they should be unaffected by the sqlx->GORM switch.

    7. Build verification:
       ```bash
       cd backend && go build ./...
       ```
  </action>
  <verify>
    ```bash
    cd backend && go build ./... && go test ./...
    ```
    Zero errors, all tests pass. `grep "jmoiron/sqlx" backend/go.mod` returns nothing.
  </verify>
  <done>
    sqlx fully removed from active code and go.mod. No lib/pq imports. Domain layer has zero GORM imports. All tests pass. Build succeeds. Migration complete.
  </done>
</task>

</tasks>

<verification>
1. `cd backend && go build ./...` — zero errors
2. `cd backend && go test ./...` — all tests pass
3. `grep -r "jmoiron/sqlx" backend/ --include="*.go"` — no active Go files import sqlx
4. `grep -r "lib/pq" backend/ --include="*.go"` — no active Go files import lib/pq
5. `grep -r "gorm" backend/internal/core/domain/ --include="*.go"` — domain is GORM-free
6. `grep "ConnectGORM" backend/cmd/server/main.go` — main uses GORM connection
7. `grep "NewGorm" backend/cmd/server/main.go` — main uses GORM repositories
8. Old sqlx files exist as .sqlx.bak (not compiled)
</verification>

<success_criteria>
- Application wired to GORM end-to-end
- sqlx removed from go.mod
- No lib/pq in active code
- Domain layer hex-clean (zero GORM imports)
- All existing tests pass unchanged
- Shared helper functions preserved in helpers.go
- Old sqlx implementations archived as .sqlx.bak
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-orm-migration-sqlx-to-gorm/07.1-03-SUMMARY.md`
</output>
