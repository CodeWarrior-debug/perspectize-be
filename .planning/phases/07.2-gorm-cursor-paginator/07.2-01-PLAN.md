---
phase: 07.2-gorm-cursor-paginator
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/go.mod
  - backend/go.sum
  - backend/internal/adapters/repositories/postgres/gorm_models.go
  - backend/internal/adapters/repositories/postgres/helpers.go
autonomous: true

must_haves:
  truths:
    - "gorm-cursor-paginator v2 is a project dependency"
    - "ContentModel has dummy fields for JSONB sort keys (ViewCount, LikeCount, PublishedAt)"
    - "Sort rule builder functions exist for both Content and Perspective sort fields"
    - "Hand-rolled encodeCursor/decodeCursor functions are removed"
  artifacts:
    - path: "backend/go.mod"
      provides: "gorm-cursor-paginator dependency"
      contains: "github.com/pilagod/gorm-cursor-paginator/v2"
    - path: "backend/internal/adapters/repositories/postgres/gorm_models.go"
      provides: "Dummy GORM fields for JSONB sort keys"
      contains: "ViewCount"
    - path: "backend/internal/adapters/repositories/postgres/helpers.go"
      provides: "Sort rule builder functions, no more encodeCursor/decodeCursor"
      exports: ["buildContentSortRules", "buildPerspectiveSortRules"]
  key_links:
    - from: "helpers.go buildContentSortRules"
      to: "paginator.Rule"
      via: "returns []paginator.Rule"
      pattern: "paginator\\.Rule"
---

<objective>
Add gorm-cursor-paginator library dependency, prepare GORM models with dummy fields for JSONB sort keys, and create sort rule builder functions that the paginator needs. Remove hand-rolled cursor encoding.

Purpose: Foundation for replacing buggy ID-only cursor pagination with compound keyset pagination via library.
Output: Library installed, models ready, sort rules defined, old cursor code removed.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-gorm-cursor-paginator/07.2-RESEARCH.md
@backend/internal/adapters/repositories/postgres/helpers.go
@backend/internal/adapters/repositories/postgres/gorm_models.go
@backend/internal/core/domain/pagination.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add gorm-cursor-paginator dependency and update GORM models</name>
  <files>
    backend/go.mod
    backend/go.sum
    backend/internal/adapters/repositories/postgres/gorm_models.go
  </files>
  <action>
1. Install the library:
   ```bash
   cd backend && go get -u github.com/pilagod/gorm-cursor-paginator/v2
   ```

2. Add dummy fields to `ContentModel` for JSONB sort keys. These fields are NOT database columns — they exist solely so the paginator's schema validation passes when using `Rule.Key` with `SQLRepr`. Add them AFTER the existing fields, BEFORE CreatedAt/UpdatedAt:

   ```go
   // Dummy fields for gorm-cursor-paginator sort key validation.
   // These are NOT database columns — SQLRepr provides the actual SQL.
   // The gorm:"-" tag tells GORM to ignore them for queries/migrations.
   ViewCount   int64  `gorm:"-"`
   LikeCount   int64  `gorm:"-"`
   PublishedAt string `gorm:"-"`
   ```

   Do NOT modify UserModel or PerspectiveModel (perspective sorts use standard columns only).
  </action>
  <verify>
    `cd backend && go build ./...` compiles with zero errors.
    `grep "gorm-cursor-paginator" backend/go.mod` shows the dependency.
    `grep "ViewCount" backend/internal/adapters/repositories/postgres/gorm_models.go` shows the dummy field.
  </verify>
  <done>
    gorm-cursor-paginator v2 in go.mod. ContentModel has ViewCount, LikeCount, PublishedAt dummy fields with `gorm:"-"` tags.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sort rule builders and remove hand-rolled cursor functions</name>
  <files>
    backend/internal/adapters/repositories/postgres/helpers.go
  </files>
  <action>
1. Add import for paginator package:
   ```go
   paginator "github.com/pilagod/gorm-cursor-paginator/v2/paginator"
   ```

2. Create `buildContentSortRules` function that maps `domain.ContentSortBy` + `domain.SortOrder` to `[]paginator.Rule`. Each rule set must include:
   - Primary sort key (the requested column)
   - Secondary tie-breaker key (ID, same direction as primary)

   For JSONB sort fields (ViewCount, LikeCount, PublishedAt), use `SQLRepr` with the JSONB extraction SQL and `NULLReplacement`:
   - ViewCount: `SQLRepr: "(response->'items'->0->'statistics'->>'viewCount')::BIGINT"`, `NULLReplacement: int64(0)`
   - LikeCount: `SQLRepr: "(response->'items'->0->'statistics'->>'likeCount')::BIGINT"`, `NULLReplacement: int64(0)`
   - PublishedAt: `SQLRepr: "response->'items'->0->'snippet'->>'publishedAt'"`, `NULLReplacement: ""`

   For standard columns (CreatedAt, UpdatedAt, Name), just use `Key` matching the GORM model field name.

   Map `domain.SortOrder` to `paginator.Order`:
   - `domain.SortOrderAsc` -> `paginator.ASC`
   - `domain.SortOrderDesc` -> `paginator.DESC`

   Default case: `CreatedAt DESC`.

3. Create `buildPerspectiveSortRules` function mapping `domain.PerspectiveSortBy` + `domain.SortOrder` to `[]paginator.Rule`. All perspective sorts are standard columns:
   - CreatedAt, UpdatedAt, Claim

   Default case: `CreatedAt DESC`.

4. DELETE the `encodeCursor` and `decodeCursor` functions entirely. They are being replaced by the library's built-in cursor encoding.

5. KEEP these existing functions (still needed):
   - `sortColumnName` — still useful for reference, but review: if it's only used by the old List() pagination logic, mark it for deletion in plan 02. For now, keep it to avoid breaking compilation.
   - `sortDirection` — same as above.
   - `isJSONBSort` — same.
   - `perspectiveSortColumnName` — same.
   - All enum converter functions (contentTypeToDBValue, etc.)
   - JSONBArray, intSliceToInt64Array

6. Remove unused imports after deleting encodeCursor/decodeCursor. The `base64` and `strconv` imports may no longer be needed (check if other functions in this file use them). The `fmt` import may also be removable. Run `goimports` or manually verify.
  </action>
  <verify>
    `cd backend && go build ./...` — expect COMPILATION ERRORS. This is expected because `gorm_content_repository.go` and `gorm_perspective_repository.go` still call `encodeCursor`/`decodeCursor`. These will be fixed in plan 02. If the build fails ONLY due to undefined `encodeCursor`/`decodeCursor` references, this task is correct.

    Alternative: If you want a clean build at this stage, temporarily comment out the `encodeCursor`/`decodeCursor` calls in the repository files (do NOT rewrite the List methods — that's plan 02). Or, keep encodeCursor/decodeCursor in this plan and let plan 02 delete them when it rewrites List().

    PREFERRED APPROACH: Keep encodeCursor/decodeCursor for now. Plan 02 will delete them when rewriting List(). This keeps the build green between plans.

    So revise: Do NOT delete encodeCursor/decodeCursor in this task. Just ADD the new buildContentSortRules and buildPerspectiveSortRules functions. The old functions will be deleted in plan 02 when the List() methods are rewritten.

    With this approach: `cd backend && go build ./...` compiles with zero errors.
    `cd backend && go test ./...` all tests pass.
  </verify>
  <done>
    `buildContentSortRules` and `buildPerspectiveSortRules` functions exist in helpers.go, returning `[]paginator.Rule` with correct JSONB SQLRepr expressions. Build passes. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `cd backend && go build ./...` — zero errors
- `cd backend && go test ./...` — all tests pass
- `grep "gorm-cursor-paginator" backend/go.mod` — dependency present
- `grep "ViewCount" backend/internal/adapters/repositories/postgres/gorm_models.go` — dummy field exists
- `grep "buildContentSortRules" backend/internal/adapters/repositories/postgres/helpers.go` — function exists
- `grep "buildPerspectiveSortRules" backend/internal/adapters/repositories/postgres/helpers.go` — function exists
</verification>

<success_criteria>
- gorm-cursor-paginator v2 added to go.mod
- ContentModel has ViewCount, LikeCount, PublishedAt dummy fields (gorm:"-")
- buildContentSortRules returns paginator.Rule slices for all 6 content sort fields
- buildPerspectiveSortRules returns paginator.Rule slices for all 3 perspective sort fields
- JSONB sort rules use SQLRepr with correct SQL expressions and NULLReplacement
- All rules include ID tie-breaker with matching sort direction
- Build passes, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-gorm-cursor-paginator/07.2-01-SUMMARY.md`
</output>
