---
phase: 07.2-gorm-cursor-paginator
plan: 01
subsystem: database
tags: [gorm, pagination, cursor, keyset, jsonb]

# Dependency graph
requires:
  - phase: 07.1-orm-migration-sqlx-to-gorm
    provides: GORM models and repositories with custom array types
provides:
  - gorm-cursor-paginator v2 library installed
  - Dummy GORM fields (ViewCount, LikeCount, PublishedAt) for JSONB sort key validation
  - Sort rule builder functions (buildContentSortRules, buildPerspectiveSortRules)
affects: [07.2-02, pagination, content-listing, perspective-listing]

# Tech tracking
tech-stack:
  added: [github.com/pilagod/gorm-cursor-paginator/v2 v2.7.0]
  patterns: [Dummy GORM fields with gorm:"-" for library schema validation, Sort rule builders with SQLRepr for JSONB expressions]

key-files:
  created: []
  modified:
    - backend/go.mod
    - backend/go.sum
    - backend/internal/adapters/repositories/postgres/gorm_models.go
    - backend/internal/adapters/repositories/postgres/helpers.go

key-decisions:
  - "Added dummy fields with gorm:\"-\" tag to ContentModel for paginator schema validation without creating DB columns"
  - "Kept existing cursor encoding and sort helper functions for backward compatibility until plan 02 migration"
  - "Used SQLRepr with NULLReplacement for JSONB sort keys (ViewCount, LikeCount, PublishedAt)"

patterns-established:
  - "Dummy GORM fields pattern: fields with gorm:\"-\" tag allow library schema validation without DB column creation"
  - "Sort rule builders return []paginator.Rule with primary sort + ID tie-breaker in matching direction"

# Metrics
duration: 2min
completed: 2026-02-13
---

# Phase 07.2 Plan 01: gorm-cursor-paginator Foundation Summary

**gorm-cursor-paginator v2 installed with dummy GORM fields and sort rule builders for compound keyset pagination**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-13T18:57:47Z
- **Completed:** 2026-02-13T18:59:18Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Installed gorm-cursor-paginator v2.7.0 library for compound keyset pagination
- Added ViewCount, LikeCount, PublishedAt dummy fields to ContentModel for paginator schema validation
- Created buildContentSortRules function mapping all 6 content sort fields to paginator.Rule slices
- Created buildPerspectiveSortRules function mapping all 3 perspective sort fields to paginator.Rule slices
- All JSONB sort rules use SQLRepr with correct extraction SQL and NULLReplacement values
- All rule sets include ID tie-breaker with matching sort direction

## Task Commits

Each task was committed atomically:

1. **Task 1: Add gorm-cursor-paginator dependency and update GORM models** - `125c63b` (feat)
2. **Task 2: Create sort rule builders and remove hand-rolled cursor functions** - `a4ac470` (feat)

## Files Created/Modified
- `backend/go.mod` - Added gorm-cursor-paginator v2.7.0 dependency
- `backend/go.sum` - Dependency checksums
- `backend/internal/adapters/repositories/postgres/gorm_models.go` - Added ViewCount, LikeCount, PublishedAt dummy fields to ContentModel with gorm:"-" tags
- `backend/internal/adapters/repositories/postgres/helpers.go` - Added buildContentSortRules and buildPerspectiveSortRules functions with paginator import

## Decisions Made

**1. Dummy GORM fields with gorm:"-" tag**
- **Rationale:** gorm-cursor-paginator validates sort keys against GORM model fields. JSONB keys (ViewCount, LikeCount, PublishedAt) don't exist as columns, so we add dummy fields with gorm:"-" to pass validation while preventing GORM from creating DB columns.

**2. Keep existing cursor encoding helpers until plan 02**
- **Rationale:** encodeCursor/decodeCursor are still used by current List() implementations. Keeping them maintains a green build between plans. Plan 02 will remove them when rewriting pagination.

**3. SQLRepr with NULLReplacement for JSONB sorts**
- **Rationale:** JSONB extraction can return NULL for videos without statistics. NULLReplacement ensures consistent sort ordering (0 for counts, "" for timestamps).

**4. ID tie-breaker with matching sort direction**
- **Rationale:** Ensures deterministic pagination when primary sort values are equal. Direction must match primary to maintain correct ordering (e.g., DESC+DESC not DESC+ASC).

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

Foundation complete for plan 02 (Rewrite List methods with library pagination).

Ready to proceed:
- Library installed and imported
- GORM models have necessary dummy fields
- Sort rule builders tested and ready to use
- All tests pass, build clean

No blockers.

---
*Phase: 07.2-gorm-cursor-paginator*
*Completed: 2026-02-13*
