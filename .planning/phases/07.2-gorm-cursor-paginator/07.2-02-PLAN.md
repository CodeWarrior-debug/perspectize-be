---
phase: 07.2-gorm-cursor-paginator
plan: 02
type: execute
wave: 2
depends_on: ["07.2-01"]
files_modified:
  - backend/internal/adapters/repositories/postgres/gorm_content_repository.go
  - backend/internal/adapters/repositories/postgres/gorm_perspective_repository.go
  - backend/internal/adapters/repositories/postgres/helpers.go
autonomous: true

must_haves:
  truths:
    - "Cursor pagination works correctly for all sort columns (created_at, updated_at, name, JSONB fields), not just ID"
    - "Compound keyset pagination: cursors encode both sort column value + ID"
    - "Frontend cursor contract preserved (opaque base64 strings, hasNext/hasPrev, startCursor/endCursor)"
    - "All existing tests pass with no behavior regression"
    - "Hand-rolled encodeCursor/decodeCursor fully removed"
  artifacts:
    - path: "backend/internal/adapters/repositories/postgres/gorm_content_repository.go"
      provides: "Content List() using gorm-cursor-paginator"
      contains: "Paginate"
    - path: "backend/internal/adapters/repositories/postgres/gorm_perspective_repository.go"
      provides: "Perspective List() using gorm-cursor-paginator"
      contains: "Paginate"
    - path: "backend/internal/adapters/repositories/postgres/helpers.go"
      provides: "No more encodeCursor/decodeCursor"
  key_links:
    - from: "gorm_content_repository.go List()"
      to: "paginator.Paginate()"
      via: "library call with Rules from buildContentSortRules"
      pattern: "p\\.Paginate"
    - from: "gorm_perspective_repository.go List()"
      to: "paginator.Paginate()"
      via: "library call with Rules from buildPerspectiveSortRules"
      pattern: "p\\.Paginate"
    - from: "List() result"
      to: "domain.PaginatedContent"
      via: "cursor.After/Before mapped to HasNext/HasPrev/StartCursor/EndCursor"
      pattern: "cursor\\.After"
---

<objective>
Rewrite Content and Perspective List() methods to use gorm-cursor-paginator, replacing hand-rolled cursor pagination. Delete old cursor encoding functions. Fix C-02 (cursor pagination broken for non-ID sorts).

Purpose: Fix the C-02 bug where cursors only encode ID, causing incorrect results when sorting by non-ID columns. Library handles compound keyset (sort column + ID) correctly.
Output: Both List() methods use library paginator. encodeCursor/decodeCursor deleted. All tests pass.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.2-gorm-cursor-paginator/07.2-RESEARCH.md
@.planning/phases/07.2-gorm-cursor-paginator/07.2-01-SUMMARY.md
@backend/internal/adapters/repositories/postgres/gorm_content_repository.go
@backend/internal/adapters/repositories/postgres/gorm_perspective_repository.go
@backend/internal/adapters/repositories/postgres/helpers.go
@backend/internal/core/domain/pagination.go
@backend/internal/core/domain/perspective.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Content List() to use gorm-cursor-paginator</name>
  <files>
    backend/internal/adapters/repositories/postgres/gorm_content_repository.go
  </files>
  <action>
Replace the entire List() method in GormContentRepository. The new implementation must:

1. Import the paginator package:
   ```go
   paginator "github.com/pilagod/gorm-cursor-paginator/v2/paginator"
   ```

2. Build sort rules using `buildContentSortRules(params.SortBy, params.SortOrder)` from helpers.go (created in plan 01).

3. Configure paginator options:
   ```go
   opts := []paginator.Option{
       paginator.WithRules(rules...),
       paginator.WithLimit(limit),
       paginator.WithAllowTupleCmp(paginator.TRUE),
   }
   if params.After != nil {
       opts = append(opts, paginator.WithAfter(*params.After))
   }
   p := paginator.New(opts...)
   ```

4. Build filtered GORM query BEFORE pagination (same filter logic as current — content_type, min/max length, search ILIKE). This is critical: filters must be applied to the query before calling Paginate().

5. TotalCount query BEFORE Paginate() (same as current). Use a separate `countQuery` variable cloned from the filtered query to avoid Paginate() modifying the count query. IMPORTANT: GORM's `Session(&gorm.Session{})` creates a new session to avoid shared state:
   ```go
   countQuery := query.Session(&gorm.Session{})
   ```

6. Call `p.Paginate(query, &models)`:
   ```go
   var models []ContentModel
   _, cursor, err := p.Paginate(query, &models)
   ```
   The first return value (result) is the GORM result — we don't need it since errors come through `err`.

7. Map results to domain:
   - `HasNext = cursor.After != nil`
   - `HasPrev = cursor.Before != nil`
   - For StartCursor/EndCursor: Use `cursor.Before` as StartCursor and `cursor.After` as EndCursor. The library's `cursor.After` is an opaque string encoding the last item's sort keys (perfect for EndCursor/next-page-start). `cursor.Before` encodes the first item's sort keys (perfect for StartCursor/prev-page-start).
   - If `cursor.Before` is nil (first page), StartCursor should still be set for the frontend. In this case, check if the library returns it. If not, StartCursor can be nil on first page (frontend handles nil StartCursor).
   - IMPORTANT: The library returns cursors as `*string` pointers. These are already opaque base64 strings. Assign directly to `result.StartCursor` and `result.EndCursor`.

8. Remove all references to `encodeCursor`, `decodeCursor`, `sortColumnName`, `sortDirection`, `isJSONBSort` from this file. The paginator handles all of it.

9. Remove unused imports (strings may no longer be needed if only used for filter logic — check). Keep fmt for error wrapping.

IMPORTANT NOTE on StartCursor/EndCursor: The research flagged Open Question #1 about StartCursor extraction. During implementation, test the actual behavior:
- `cursor.After` should be the EndCursor (encodes last item for forward pagination)
- `cursor.Before` should be the StartCursor (encodes first item for backward pagination)
- On the first page, `cursor.Before` may be nil. This is acceptable — the frontend should handle nil StartCursor.
- If the library does NOT provide `cursor.Before` on forward-only pagination, we may need to construct StartCursor differently. Cross that bridge if reached.
  </action>
  <verify>
    `cd backend && go build ./...` compiles with zero errors.
    `grep -c "encodeCursor\|decodeCursor" backend/internal/adapters/repositories/postgres/gorm_content_repository.go` returns 0.
    `grep "Paginate" backend/internal/adapters/repositories/postgres/gorm_content_repository.go` shows library usage.
  </verify>
  <done>
    Content List() uses gorm-cursor-paginator with compound keyset rules. No references to hand-rolled cursor functions. Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite Perspective List() and delete old cursor functions</name>
  <files>
    backend/internal/adapters/repositories/postgres/gorm_perspective_repository.go
    backend/internal/adapters/repositories/postgres/helpers.go
  </files>
  <action>
1. Rewrite Perspective List() following the SAME pattern as Content List() (task 1), but using `buildPerspectiveSortRules(params.SortBy, params.SortOrder)`. Perspective sorts are simpler — all standard columns (CreatedAt, UpdatedAt, Claim), no JSONB.

   The implementation is nearly identical to Content List():
   - Build rules with `buildPerspectiveSortRules`
   - Configure paginator with WithRules, WithLimit, WithAllowTupleCmp, WithAfter
   - Build filtered query (UserID, ContentID, Privacy filters)
   - TotalCount before Paginate
   - Call Paginate
   - Map cursor.After/Before to HasNext/HasPrev/StartCursor/EndCursor

2. In helpers.go, DELETE:
   - `encodeCursor` function
   - `decodeCursor` function
   - `sortColumnName` function (no longer used — sort logic now in buildContentSortRules)
   - `sortDirection` function (no longer used — paginator.ASC/DESC used directly)
   - `isJSONBSort` function (no longer used — JSONB handled by SQLRepr in rules)
   - `perspectiveSortColumnName` function (no longer used — sort logic now in buildPerspectiveSortRules)

3. Clean up helpers.go imports — remove `base64`, `strconv`, `fmt` if no longer used. Keep `database/sql`, `database/sql/driver`, `strings` (used by enum converters). Add paginator import if not already present (it should be from plan 01).

4. Run `cd backend && go build ./...` to verify compilation.

5. Run `cd backend && go test ./...` to verify all tests pass. The test files use mock repositories (not real DB), so the List() implementation changes should be transparent to tests. If any test failures occur:
   - Check if tests assert specific cursor format (e.g., `cursor:123` pattern). The library uses a different encoding format. Tests should treat cursors as opaque.
   - Check if tests pass specific cursor strings to After parameter. These would need updating to match library format.
   - If tests mock the repository interface, they won't be affected (they test service/resolver layer, not repository internals).
  </action>
  <verify>
    `cd backend && go build ./...` — zero errors.
    `cd backend && go test ./...` — all tests pass.
    `grep -c "encodeCursor\|decodeCursor" backend/internal/adapters/repositories/postgres/helpers.go` returns 0.
    `grep -c "encodeCursor\|decodeCursor" backend/internal/adapters/repositories/postgres/gorm_perspective_repository.go` returns 0.
    `grep "Paginate" backend/internal/adapters/repositories/postgres/gorm_perspective_repository.go` shows library usage.
  </verify>
  <done>
    Perspective List() uses gorm-cursor-paginator. encodeCursor/decodeCursor deleted from helpers.go. All old sort helper functions removed. Build passes. All tests pass. C-02 is fixed.
  </done>
</task>

</tasks>

<verification>
- `cd backend && go build ./...` — zero errors
- `cd backend && go test ./...` — all tests pass (no behavior regression)
- `grep -rn "encodeCursor\|decodeCursor" backend/internal/adapters/repositories/postgres/` — zero matches (fully removed)
- `grep -rn "Paginate" backend/internal/adapters/repositories/postgres/gorm_content_repository.go` — library Paginate call present
- `grep -rn "Paginate" backend/internal/adapters/repositories/postgres/gorm_perspective_repository.go` — library Paginate call present
- `grep -rn "cursor.After" backend/internal/adapters/repositories/postgres/` — cursor mapping present
- Cursors are opaque base64 strings (frontend contract preserved)
</verification>

<success_criteria>
- Content List() uses paginator.Paginate() with Rules from buildContentSortRules
- Perspective List() uses paginator.Paginate() with Rules from buildPerspectiveSortRules
- encodeCursor and decodeCursor fully deleted from codebase
- Old sort helper functions (sortColumnName, sortDirection, isJSONBSort, perspectiveSortColumnName) deleted
- HasNext/HasPrev derived from cursor.After/Before pointers (not limit+1 hack)
- StartCursor/EndCursor derived from library cursor pointers
- Compound keyset: cursors encode sort column value + ID (fixes C-02)
- AllowTupleCmp enabled for PostgreSQL optimization
- Filters applied BEFORE Paginate(), TotalCount queried BEFORE Paginate()
- All existing tests pass — zero regressions
- Build compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07.2-gorm-cursor-paginator/07.2-02-SUMMARY.md`
</output>
