---
phase: 07.3-frontend-caching-remediation
plan: 02
type: execute
wave: 2
depends_on: ["07.3-01"]
files_modified:
  - frontend/src/lib/queries/hooks/useAddVideo.ts
  - frontend/src/lib/components/AddVideoPopover.svelte
  - frontend/src/lib/components/AddVideoDialog.svelte
  - frontend/src/lib/components/UserSelector.svelte
autonomous: true

must_haves:
  truths:
    - "Shared useAddVideo hook extracts duplicated mutation logic"
    - "AddVideoPopover uses shared hook and no longer dispatches content-added event"
    - "AddVideoDialog uses shared hook and invalidates queries on success (fixes refresh bug)"
    - "Both components show consistent error messages via shared hook"
    - "UserSelector imports User type from users.ts instead of defining inline"
  artifacts:
    - path: "frontend/src/lib/queries/hooks/useAddVideo.ts"
      provides: "Shared mutation hook for adding YouTube videos"
      exports: ["useAddVideo"]
    - path: "frontend/src/lib/components/AddVideoPopover.svelte"
      provides: "Popover using shared hook, no custom event dispatch"
    - path: "frontend/src/lib/components/AddVideoDialog.svelte"
      provides: "Dialog using shared hook with query invalidation"
    - path: "frontend/src/lib/components/UserSelector.svelte"
      provides: "UserSelector importing User type from users.ts, using query keys"
  key_links:
    - from: "frontend/src/lib/queries/hooks/useAddVideo.ts"
      to: "frontend/src/lib/queries/keys.ts"
      via: "import queryKeys for invalidation"
      pattern: "queryKeys\\.content\\.lists"
    - from: "frontend/src/lib/components/AddVideoPopover.svelte"
      to: "frontend/src/lib/queries/hooks/useAddVideo.ts"
      via: "import useAddVideo"
      pattern: "useAddVideo"
    - from: "frontend/src/lib/components/UserSelector.svelte"
      to: "frontend/src/lib/queries/users.ts"
      via: "import type { User, UsersResponse }"
      pattern: "import.*User.*from.*users"
---

<objective>
Extract shared mutation hook, wire to both AddVideo components, fix Dialog refresh bug, update UserSelector types.

Purpose: Eliminate duplicated mutation logic across Popover and Dialog, fix the bug where AddVideoDialog doesn't refresh the table after adding a video, remove the fragile custom event pattern, and clean up UserSelector type imports.
Output: useAddVideo.ts shared hook, updated Popover/Dialog/UserSelector components.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07.3-frontend-caching-remediation/07.3-RESEARCH.md
@.planning/phases/07.3-frontend-caching-remediation/07.3-01-SUMMARY.md

@frontend/src/lib/queries/keys.ts
@frontend/src/lib/queries/content.ts
@frontend/src/lib/queries/users.ts
@frontend/src/lib/components/AddVideoPopover.svelte
@frontend/src/lib/components/AddVideoDialog.svelte
@frontend/src/lib/components/UserSelector.svelte
@frontend/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared useAddVideo mutation hook</name>
  <files>frontend/src/lib/queries/hooks/useAddVideo.ts</files>
  <action>
    Create NEW directory `frontend/src/lib/queries/hooks/` and file `useAddVideo.ts`.

    This hook extracts the duplicated mutation logic from AddVideoPopover and AddVideoDialog into a single source of truth.

    ```typescript
    import { createMutation, useQueryClient } from '@tanstack/svelte-query';
    import { toast } from 'svelte-sonner';
    import { graphqlClient } from '../client';
    import { CREATE_CONTENT_FROM_YOUTUBE, type CreateContentResponse } from '../content';
    import { queryKeys } from '../keys';

    export function useAddVideo() {
      const queryClient = useQueryClient();

      return createMutation(() => ({
        mutationFn: async (url: string) => {
          return graphqlClient.request<CreateContentResponse>(CREATE_CONTENT_FROM_YOUTUBE, {
            input: { url }
          });
        },
        onSuccess: (data: CreateContentResponse) => {
          const name = data?.createContentFromYouTube?.name ?? 'video';
          toast.success(`Added: ${name}`);
          // Invalidate all content lists -- triggers refetch in any component using content queries
          queryClient.invalidateQueries({ queryKey: queryKeys.content.lists() });
        },
        onError: (err: Error) => {
          const message = err.message.toLowerCase();
          if (message.includes('already exists')) {
            toast.error('This video has already been added');
          } else if (message.includes('invalid youtube url') || message.includes('video not found')) {
            toast.error('Invalid YouTube URL or video not found');
          } else {
            toast.error('Failed to add video. Please try again.');
          }
        }
      }));
    }
    ```

    Key design choices:
    - Uses `CreateContentResponse` type parameter on request (no `any`)
    - Invalidates `queryKeys.content.lists()` (all list variations) on success
    - NO custom event dispatch -- TanStack Query invalidation handles everything
    - Error handling is identical to existing behavior (preserves user experience)
  </action>
  <verify>
    - File exists at `frontend/src/lib/queries/hooks/useAddVideo.ts`
    - `cd frontend && pnpm run check` passes
  </verify>
  <done>useAddVideo hook exists, uses typed request, invalidates via query keys, no custom events.</done>
</task>

<task type="auto">
  <name>Task 2: Wire shared hook to Popover, Dialog, and fix UserSelector types</name>
  <files>
    frontend/src/lib/components/AddVideoPopover.svelte
    frontend/src/lib/components/AddVideoDialog.svelte
    frontend/src/lib/components/UserSelector.svelte
  </files>
  <action>
    **AddVideoPopover.svelte:**
    1. Replace the inline `createMutation` + `useQueryClient` with `useAddVideo`:
       - Remove imports: `createMutation`, `useQueryClient` from svelte-query
       - Remove imports: `graphqlClient` from client, `CREATE_CONTENT_FROM_YOUTUBE` from content
       - Add import: `import { useAddVideo } from '$lib/queries/hooks/useAddVideo';`
    2. Replace `const queryClient = useQueryClient();` and the entire `createMutation(...)` block with:
       `const mutation = useAddVideo();`
    3. REMOVE the `window.dispatchEvent(new CustomEvent('content-added'))` line (line 38). This is the critical fix -- the custom event is no longer needed because the hook invalidates via query keys.
    4. The hook handles onSuccess toast + invalidation, but we still need to close the popover on success. Add an $effect that watches mutation.isSuccess:
       ```typescript
       $effect(() => {
         if (mutation.isSuccess) {
           open = false;
         }
       });
       ```
       And remove `open = false` from any onSuccess callback (it is now in the hook which doesn't have access to `open`).
    5. Keep: `validateYouTubeUrl` import, form state (`open`, `url`, `error`), reset effect, handleSubmit function, all template markup.
    6. The handleSubmit function stays the same -- calls `mutation.mutate(url)`.

    **AddVideoDialog.svelte:**
    1. Same refactor as Popover -- replace inline mutation with `useAddVideo`:
       - Remove imports: `createMutation`, `useQueryClient`, `graphqlClient`, `CREATE_CONTENT_FROM_YOUTUBE`
       - Add import: `import { useAddVideo } from '$lib/queries/hooks/useAddVideo';`
    2. Replace mutation block with: `const mutation = useAddVideo();`
    3. Add success watcher to close dialog:
       ```typescript
       $effect(() => {
         if (mutation.isSuccess) {
           open = false;
         }
       });
       ```
    4. This FIXES the Dialog refresh bug: previously, AddVideoDialog invalidated `{ queryKey: ['content'] }` but did NOT dispatch the `content-added` custom event, so ActivityTable (which listened for that event) never refetched. Now the hook invalidates `queryKeys.content.lists()` which will match once ActivityTable is migrated in Plan 03.
    5. Keep: `validateYouTubeUrl` import, props (`open`), form state, reset effect, handleSubmit, all template markup.

    **UserSelector.svelte:**
    1. Remove the inline `User` and `UsersResponse` interfaces (lines 7-15).
    2. Add imports from users.ts: `import { LIST_USERS, type User, type UsersResponse } from '$lib/queries/users';`
    3. Import query keys: `import { queryKeys } from '$lib/queries/keys';`
    4. Update the createQuery to use typed request and query keys:
       ```typescript
       const usersQuery = createQuery(() => ({
         queryKey: queryKeys.users.list(),
         queryFn: () => graphqlClient.request<UsersResponse>(LIST_USERS),
         staleTime: 5 * 60 * 1000,
       }));
       ```
    5. Cast the response properly -- `usersQuery.data` is now typed as `UsersResponse`, so `usersQuery.data.users` has type `User[]`.
  </action>
  <verify>
    - `grep "content-added" frontend/src/lib/components/AddVideoPopover.svelte` returns nothing
    - `grep "useAddVideo" frontend/src/lib/components/AddVideoPopover.svelte` returns a match
    - `grep "useAddVideo" frontend/src/lib/components/AddVideoDialog.svelte` returns a match
    - `grep "interface User" frontend/src/lib/components/UserSelector.svelte` returns nothing (inline type removed)
    - `grep "queryKeys" frontend/src/lib/components/UserSelector.svelte` returns a match
    - `cd frontend && pnpm run check` passes
  </verify>
  <done>Both AddVideo components use shared hook, custom event removed from Popover, Dialog now properly invalidates cache on success, UserSelector uses shared types and query keys.</done>
</task>

</tasks>

<verification>
1. `grep -r "content-added" frontend/src/` returns NO matches (custom event fully removed)
2. `grep -r "useAddVideo" frontend/src/` returns matches in hooks/useAddVideo.ts, AddVideoPopover.svelte, AddVideoDialog.svelte
3. `grep "interface User" frontend/src/lib/components/UserSelector.svelte` returns nothing
4. `cd frontend && pnpm run check` passes
5. `cd frontend && pnpm run test:run` -- existing tests may need updates (handled in Plan 04)
</verification>

<success_criteria>
- useAddVideo hook created with typed mutation, toast handling, and queryKeys invalidation
- AddVideoPopover uses hook, no custom event dispatch
- AddVideoDialog uses hook, cache invalidation now works (refresh bug fixed)
- UserSelector imports types from users.ts, uses queryKeys
- No `any` types in mutation responses
</success_criteria>

<output>
After completion, create `.planning/phases/07.3-frontend-caching-remediation/07.3-02-SUMMARY.md`
</output>
