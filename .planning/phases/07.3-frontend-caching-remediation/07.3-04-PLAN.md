---
phase: 07.3-frontend-caching-remediation
plan: 04
type: execute
wave: 3
depends_on: ["07.3-02", "07.3-03"]
files_modified:
  - frontend/tests/unit/queries-keys.test.ts
  - frontend/tests/unit/queries-users.test.ts
  - frontend/tests/unit/queries-content.test.ts
  - frontend/tests/components/AddVideoPopover.test.ts
  - frontend/tests/components/AddVideoDialog.test.ts
  - frontend/tests/components/UserSelector.test.ts
  - frontend/tests/components/ActivityTable.test.ts
autonomous: true

must_haves:
  truths:
    - "All existing tests pass after updates for new patterns"
    - "Query key factory has unit tests verifying hierarchical structure"
    - "Coverage thresholds met: 80% stmts/lines/functions, 75% branches"
    - "No test references content-added custom event"
    - "useAddVideo hook test verifies mutation + invalidation"
  artifacts:
    - path: "frontend/tests/unit/queries-keys.test.ts"
      provides: "Tests for query key factory hierarchy"
    - path: "frontend/tests/unit/queries-users.test.ts"
      provides: "Updated tests reflecting email removal and type exports"
    - path: "frontend/tests/unit/queries-content.test.ts"
      provides: "Updated tests including CreateContentResponse type"
  key_links:
    - from: "frontend/tests/unit/queries-keys.test.ts"
      to: "frontend/src/lib/queries/keys.ts"
      via: "import { queryKeys }"
      pattern: "queryKeys"
---

<objective>
Update all tests for new patterns and add tests for query key factory. Pass coverage gate.

Purpose: Ensure all test files reflect the refactored code (shared hook, query keys, removed custom events, removed email). Add unit tests for the new query key factory. Pass the 80/80/80/75 coverage thresholds.
Output: Updated test suite, all passing, coverage thresholds met.
</objective>

<execution_context>
@/Users/jamesjordan/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jamesjordan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07.3-frontend-caching-remediation/07.3-01-SUMMARY.md
@.planning/phases/07.3-frontend-caching-remediation/07.3-02-SUMMARY.md
@.planning/phases/07.3-frontend-caching-remediation/07.3-03-SUMMARY.md

@frontend/tests/unit/queries-keys.test.ts
@frontend/tests/unit/queries-users.test.ts
@frontend/tests/unit/queries-content.test.ts
@frontend/tests/components/AddVideoPopover.test.ts
@frontend/tests/components/AddVideoDialog.test.ts
@frontend/tests/components/UserSelector.test.ts
@frontend/tests/components/ActivityTable.test.ts
@frontend/CLAUDE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add query key factory tests and update unit tests</name>
  <files>
    frontend/tests/unit/queries-keys.test.ts
    frontend/tests/unit/queries-users.test.ts
    frontend/tests/unit/queries-content.test.ts
  </files>
  <action>
    **Create NEW file `frontend/tests/unit/queries-keys.test.ts`:**

    Test the query key factory hierarchy:
    1. `queryKeys.all` returns `['app']`
    2. `queryKeys.content.all()` returns `['app', 'content']`
    3. `queryKeys.content.lists()` returns `['app', 'content', 'list']`
    4. `queryKeys.content.list({ sortBy: 'UPDATED_AT' })` returns `['app', 'content', 'list', { sortBy: 'UPDATED_AT' }]`
    5. `queryKeys.content.detail('123')` returns `['app', 'content', 'detail', '123']`
    6. `queryKeys.users.all()` returns `['app', 'users']`
    7. `queryKeys.users.list()` returns `['app', 'users', 'list']`
    8. Verify hierarchical prefix: `queryKeys.content.lists()` is a prefix of `queryKeys.content.list({...})` (important for TanStack Query invalidation matching)

    Use `describe('queryKeys', () => { ... })` structure with nested describes for content and users.

    **Update `frontend/tests/unit/queries-users.test.ts`:**
    - If test checks for `email` field in query string, remove that assertion
    - Add tests verifying `User` and `UsersResponse` types are exported (import check)
    - Verify LIST_USERS query string does NOT contain 'email'

    **Update `frontend/tests/unit/queries-content.test.ts`:**
    - Add test verifying `CreateContentResponse` is exported (import check)
    - Existing ContentItem and ContentResponse tests should be unchanged
  </action>
  <verify>
    - `cd frontend && pnpm run test:run -- tests/unit/queries-keys.test.ts` passes
    - `cd frontend && pnpm run test:run -- tests/unit/queries-users.test.ts` passes
    - `cd frontend && pnpm run test:run -- tests/unit/queries-content.test.ts` passes
  </verify>
  <done>Query key factory has comprehensive unit tests, users tests reflect email removal, content tests include CreateContentResponse.</done>
</task>

<task type="auto">
  <name>Task 2: Update component tests and run coverage gate</name>
  <files>
    frontend/tests/components/AddVideoPopover.test.ts
    frontend/tests/components/AddVideoDialog.test.ts
    frontend/tests/components/UserSelector.test.ts
    frontend/tests/components/ActivityTable.test.ts
  </files>
  <action>
    Read each test file first to understand current test structure, then update for new patterns.

    **AddVideoPopover.test.ts:**
    - If tests mock `graphqlClient.request` directly for mutation, they may still work since the hook calls the same client
    - If tests check for `window.dispatchEvent` or `content-added`, REMOVE those assertions
    - If tests mock `createMutation` or `useQueryClient`, update to account for the shared hook pattern
    - The component still renders the same UI, so DOM-based tests should largely still pass

    **AddVideoDialog.test.ts:**
    - Same updates as Popover -- remove any `content-added` event references
    - Update mutation mocking if needed

    **UserSelector.test.ts:**
    - If test mocks `LIST_USERS` response with email field, remove email from mock data
    - If test references inline User type, no change needed (just mock data)
    - Update query key mock if test specifies `queryKey: ['users']` -- should now be `queryKeys.users.list()` equivalent

    **ActivityTable.test.ts:**
    - This is the most impacted test file. ActivityTable now uses `createQuery` instead of `graphqlClient.request` directly.
    - If tests mock `graphqlClient.request` for the initial data load, they may need to mock the query instead
    - Remove any references to `content-added` event or `fetchData`
    - If existing tests mostly test AG Grid rendering with mocked data, they may need minimal changes
    - IMPORTANT: ActivityTable coverage is known to be low (40.9%) due to AG Grid callbacks not executing in JSDOM. This is a known concern from STATE.md. Focus on ensuring existing tests don't break rather than dramatically increasing coverage.

    **General approach for all component test updates:**
    1. Read the current test file
    2. Identify what changed in the component
    3. Update mocks and assertions to match new imports/patterns
    4. Run the individual test file to verify
    5. If a test was testing removed functionality (custom events), either remove the test or update it to test the new behavior (query invalidation)

    **After all test updates, run the coverage gate:**
    ```bash
    cd frontend && pnpm run test:coverage
    ```
    This must exit 0 (80% stmts/lines/functions, 75% branches).

    If coverage drops below thresholds due to new untested code (keys.ts, useAddVideo.ts), add targeted unit tests for the new files until thresholds are met.
  </action>
  <verify>
    - `cd frontend && pnpm run test:run` -- ALL tests pass (zero failures)
    - `cd frontend && pnpm run test:coverage` -- exits 0, thresholds met
    - `grep -r "content-added" frontend/tests/` returns NO matches
  </verify>
  <done>All tests pass, no references to removed patterns (custom events, inline types), coverage thresholds met (80/80/80/75).</done>
</task>

</tasks>

<verification>
1. `cd frontend && pnpm run test:run` -- all tests pass
2. `cd frontend && pnpm run test:coverage` -- exits 0 (thresholds met)
3. `grep -r "content-added" frontend/tests/` returns nothing
4. `grep -r "content-added" frontend/src/` returns nothing
5. `cd frontend && pnpm run check` passes
</verification>

<success_criteria>
- All existing tests updated for new patterns and passing
- New query key factory tests cover hierarchical structure
- No test references content-added custom event
- Coverage gate passes: 80% stmts/lines/functions, 75% branches
- `pnpm run test:coverage` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/07.3-frontend-caching-remediation/07.3-04-SUMMARY.md`
</output>
