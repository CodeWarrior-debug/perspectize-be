---
phase: 08-user-integration-flow
plan: 01
type: execute
wave: 1
depends_on: ["07.3-04"]
files_modified:
  - backend/schema.graphql
  - backend/internal/adapters/graphql/generated/generated.go
  - backend/internal/adapters/graphql/resolvers/schema.resolvers.go
  - frontend/src/lib/components/FormPopover.svelte
  - frontend/src/lib/components/AddVideoPopover.svelte
  - frontend/src/lib/components/CreateUserPopover.svelte
  - frontend/src/lib/components/UserSelector.svelte
  - frontend/src/lib/queries/users.ts
  - frontend/src/lib/queries/hooks/useCreateUser.ts
autonomous: true

must_haves:
  truths:
    - "CreateUserInput.email is optional (String, not String!) in GraphQL schema"
    - "FormPopover is a shared component used by both AddVideoPopover and CreateUserPopover"
    - "CreateUserPopover has a single username input field and calls createUser mutation"
    - "On successful user creation, users.list query cache is invalidated"
    - "On successful user creation, the new user is auto-selected in UserSelector"
    - "UserSelector shows a '+ New User' option that triggers CreateUserPopover"
    - "AddVideoPopover refactored to use FormPopover (no behavior change)"
  artifacts:
    - path: "frontend/src/lib/components/FormPopover.svelte"
      provides: "Shared popover shell with trigger, title, description, cancel/submit, form snippet slot"
      exports: ["FormPopover"]
    - path: "frontend/src/lib/components/CreateUserPopover.svelte"
      provides: "User creation popover with username input and createUser mutation"
      exports: ["CreateUserPopover"]
    - path: "frontend/src/lib/queries/hooks/useCreateUser.ts"
      provides: "Shared mutation hook for creating users"
      exports: ["useCreateUser"]
  key_links:
    - from: "frontend/src/lib/components/CreateUserPopover.svelte"
      to: "frontend/src/lib/queries/hooks/useCreateUser.ts"
      via: "import useCreateUser"
      pattern: "useCreateUser"
    - from: "frontend/src/lib/components/CreateUserPopover.svelte"
      to: "frontend/src/lib/components/FormPopover.svelte"
      via: "import FormPopover"
      pattern: "FormPopover"
    - from: "frontend/src/lib/components/AddVideoPopover.svelte"
      to: "frontend/src/lib/components/FormPopover.svelte"
      via: "import FormPopover"
      pattern: "FormPopover"
    - from: "frontend/src/lib/components/UserSelector.svelte"
      to: "frontend/src/lib/components/CreateUserPopover.svelte"
      via: "import CreateUserPopover"
      pattern: "CreateUserPopover"
---

<objective>
Add user creation flow to the frontend via a shared FormPopover component.

Purpose: Users can create new users directly from the UserSelector dropdown without leaving the page. The "+ New User" option opens a popover with a username field. On success, the new user is auto-selected. Backend schema updated to make email optional.
Output: FormPopover shared component, CreateUserPopover, useCreateUser hook, refactored AddVideoPopover, updated UserSelector.
</objective>

<context>
@.planning/STATE.md
@frontend/CLAUDE.md
@frontend/src/lib/components/AddVideoPopover.svelte
@frontend/src/lib/components/UserSelector.svelte
@frontend/src/lib/queries/users.ts
@frontend/src/lib/queries/hooks/useAddVideo.ts
@frontend/src/lib/queries/keys.ts
@backend/schema.graphql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make email optional in backend schema</name>
  <files>
    backend/schema.graphql
  </files>
  <action>
    Change `CreateUserInput.email` from `String!` to `String`:

    ```graphql
    input CreateUserInput {
      username: String!
      email: String
    }
    ```

    Then regenerate gqlgen:
    ```bash
    cd backend && go run github.com/99designs/gqlgen generate
    ```

    Update the resolver to handle nil email — the resolver calls `r.UserService.Create(ctx, input.Username, input.Email)`. Since `input.Email` is now `*string` in the generated model, dereference with a default:
    ```go
    email := ""
    if input.Email != nil {
      email = *input.Email
    }
    user, err := r.UserService.Create(ctx, input.Username, email)
    ```
  </action>
  <verify>
    - `cd backend && go build ./...` compiles
    - `cd backend && go test ./...` passes
  </verify>
  <done>CreateUserInput.email is optional in schema, resolver handles nil email, backend compiles and tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add CREATE_USER mutation and useCreateUser hook</name>
  <files>
    frontend/src/lib/queries/users.ts
    frontend/src/lib/queries/hooks/useCreateUser.ts
  </files>
  <action>
    **users.ts** — Add mutation definition and response type:

    ```typescript
    export interface CreateUserInput {
      username: string;
      email?: string;
    }

    export interface CreateUserResponse {
      createUser: User;
    }

    export const CREATE_USER = gql`
      mutation CreateUser($input: CreateUserInput!) {
        createUser(input: $input) {
          id
          username
        }
      }
    `;
    ```

    **useCreateUser.ts** — Create shared mutation hook:

    ```typescript
    import { createMutation, useQueryClient } from '@tanstack/svelte-query';
    import { toast } from 'svelte-sonner';
    import { graphqlClient } from '../client';
    import { CREATE_USER, type CreateUserInput, type CreateUserResponse } from '../users';
    import { queryKeys } from '../keys';

    export function useCreateUser() {
      const queryClient = useQueryClient();

      return createMutation(() => ({
        mutationFn: async (input: CreateUserInput) => {
          return graphqlClient.request<CreateUserResponse>(CREATE_USER, { input });
        },
        onSuccess: (data: CreateUserResponse) => {
          toast.success(`Created user: ${data.createUser.username}`);
          queryClient.invalidateQueries({ queryKey: queryKeys.users.list() });
        },
        onError: (err: Error) => {
          const message = err.message.toLowerCase();
          if (message.includes('already exists')) {
            toast.error('A user with that username already exists');
          } else {
            toast.error('Failed to create user. Please try again.');
          }
        }
      }));
    }
    ```
  </action>
  <verify>
    - `cd frontend && pnpm run check` passes
  </verify>
  <done>CREATE_USER mutation defined, useCreateUser hook created with cache invalidation and toast feedback.</done>
</task>

<task type="auto">
  <name>Task 3: Create FormPopover shared component</name>
  <files>
    frontend/src/lib/components/FormPopover.svelte
  </files>
  <action>
    Create a shared popover component that extracts the common shell from AddVideoPopover.

    Props (via $props):
    - `triggerLabel: string` — button text
    - `triggerIcon: Snippet` — icon snippet
    - `title: string` — popover heading
    - `description: string` — subtitle text
    - `submitLabel: string` — submit button text
    - `pendingLabel: string` — text during loading
    - `isPending: boolean` — disables form
    - `isSubmitDisabled: boolean` — disables submit button
    - `formFields: Snippet` — form content slot
    - `onSubmit: () => void` — form submit callback
    - `open: boolean` — bindable open state

    The component renders:
    - Popover with PopoverTrigger (button with icon + label)
    - PopoverContent with form wrapper
    - Title + description header
    - {@render formFields()} for consumer-provided inputs
    - Cancel + Submit buttons

    Use the same shadcn imports and styling as AddVideoPopover.
  </action>
  <verify>
    - `cd frontend && pnpm run check` passes
  </verify>
  <done>FormPopover.svelte created with snippet-based form slot, trigger props, and loading state.</done>
</task>

<task type="auto">
  <name>Task 4: Refactor AddVideoPopover to use FormPopover</name>
  <files>
    frontend/src/lib/components/AddVideoPopover.svelte
  </files>
  <action>
    Refactor AddVideoPopover to use FormPopover as its shell. The component keeps:
    - `useAddVideo` hook
    - `validateYouTubeUrl` logic
    - URL state and error state
    - handleSubmit function

    But delegates the popover chrome (trigger, content layout, cancel/submit buttons) to FormPopover.

    The YouTube URL input + error message become the `formFields` snippet.
    The PlusIcon becomes the `triggerIcon` snippet.

    Behavior must be identical — no UX change.
  </action>
  <verify>
    - `cd frontend && pnpm run check` passes
    - Visual behavior matches original (manual check)
  </verify>
  <done>AddVideoPopover uses FormPopover with identical behavior, popover boilerplate eliminated.</done>
</task>

<task type="auto">
  <name>Task 5: Create CreateUserPopover and wire into UserSelector</name>
  <files>
    frontend/src/lib/components/CreateUserPopover.svelte
    frontend/src/lib/components/UserSelector.svelte
  </files>
  <action>
    **CreateUserPopover.svelte:**
    - Uses FormPopover with title "New User", description "Create a new user account."
    - Single username input field as formFields snippet
    - Uses useCreateUser hook
    - Props: `onUserCreated: (userId: string) => void` callback
    - On success: calls onUserCreated with the new user's ID
    - Trigger: small button or link-styled element (UserPlusIcon from lucide)

    **UserSelector.svelte:**
    - Add a CreateUserPopover next to the select dropdown
    - When user is created, auto-select them via setSelectedUserId
    - The popover trigger sits adjacent to the dropdown (not inside the native select)

    Design note: Native `<select>` elements can't contain custom interactive elements, so the "+ New User" trigger is a separate button/icon next to the dropdown rather than an `<option>`. This is cleaner and avoids the hack of intercepting select change events.
  </action>
  <verify>
    - `cd frontend && pnpm run check` passes
    - `cd frontend && pnpm run test:run` passes
  </verify>
  <done>CreateUserPopover created, UserSelector has adjacent trigger for creating new users, new user auto-selected on creation.</done>
</task>

</tasks>

<verification>
1. `cd backend && go build ./...` compiles with zero errors
2. `cd backend && go test ./...` all tests pass
3. `cd frontend && pnpm run check` passes
4. `cd frontend && pnpm run test:run` all tests pass
5. Grep for `CreateUserInput` in schema.graphql shows `email: String` (no bang)
6. Grep for `FormPopover` in AddVideoPopover shows it's using the shared component
7. Grep for `CreateUserPopover` in UserSelector shows it's wired in
</verification>

<success_criteria>
- Backend: email optional in CreateUserInput, resolver handles nil
- FormPopover shared component extracts popover boilerplate
- AddVideoPopover refactored to use FormPopover (identical behavior)
- CreateUserPopover with username field and createUser mutation
- UserSelector shows create user trigger, auto-selects on creation
- All tests pass, no coverage regression
</success_criteria>

<output>
After completion, create `.planning/phases/08-user-integration-flow/08-01-SUMMARY.md`
</output>
